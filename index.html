<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Onest:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a1a;
            --card-bg: rgba(255, 255, 255, 0.04);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
            --card-inset: inset 0 1px 0 rgba(255, 255, 255, 0.06);
            --text: #fff;
            --text-muted: rgba(255, 255, 255, 0.45);
            --text-secondary: rgba(255, 255, 255, 0.85);
            --text-dim: rgba(255, 255, 255, 0.5);
            --text-label: rgba(255, 255, 255, 0.55);
            --text-nav-header: rgba(255, 255, 255, 0.3);
            --hover-bg: rgba(255, 255, 255, 0.04);
            --link-bg: rgba(255, 255, 255, 0.06);
            --link-border: rgba(255, 255, 255, 0.06);
            --input-bg: rgba(255, 255, 255, 0.05);
            --input-border: rgba(255, 255, 255, 0.1);
            --modal-bg: #16162a;
            --topbar-bg: rgba(10, 10, 26, 0.8);
            --sidebar-bg: rgba(255, 255, 255, 0.02);
            --border-color: rgba(255, 255, 255, 0.06);
            --nav-icon-bg: rgba(255, 255, 255, 0.06);
            --nav-icon-fill: rgba(255, 255, 255, 0.45);
            --link-icon-fill: rgba(255, 255, 255, 0.6);
            --skill-card-bg: rgba(255, 255, 255, 0.03);
            --skill-card-border: rgba(255, 255, 255, 0.06);
            --skill-card-hover: rgba(255, 255, 255, 0.05);
            --divider-color: rgba(255, 255, 255, 0.25);
            --divider-line: rgba(255, 255, 255, 0.08);
            --orb-opacity: 0.5;
            --orb3-opacity: 0.3;
            --btn-bg: rgba(255, 255, 255, 0.07);
            --btn-border: rgba(255, 255, 255, 0.12);
            --logout-bg: rgba(255, 255, 255, 0.06);
            --logout-border: rgba(255, 255, 255, 0.08);
            --logout-color: rgba(255, 255, 255, 0.6);
            --step-line: rgba(108, 92, 231, 0.3);
        }

        body.light {
            --bg: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: rgba(0, 0, 0, 0.08);
            --card-shadow: 0 30px 80px rgba(0, 0, 0, 0.08);
            --card-inset: inset 0 1px 0 rgba(255, 255, 255, 0.8);
            --text: #1a1a2e;
            --text-muted: rgba(0, 0, 0, 0.45);
            --text-secondary: rgba(0, 0, 0, 0.75);
            --text-dim: rgba(0, 0, 0, 0.5);
            --text-label: rgba(0, 0, 0, 0.55);
            --text-nav-header: rgba(0, 0, 0, 0.35);
            --hover-bg: rgba(0, 0, 0, 0.04);
            --link-bg: rgba(0, 0, 0, 0.05);
            --link-border: rgba(0, 0, 0, 0.06);
            --input-bg: rgba(0, 0, 0, 0.04);
            --input-border: rgba(0, 0, 0, 0.12);
            --modal-bg: #ffffff;
            --topbar-bg: rgba(240, 242, 245, 0.85);
            --sidebar-bg: rgba(255, 255, 255, 0.6);
            --border-color: rgba(0, 0, 0, 0.08);
            --nav-icon-bg: rgba(0, 0, 0, 0.05);
            --nav-icon-fill: rgba(0, 0, 0, 0.4);
            --link-icon-fill: rgba(0, 0, 0, 0.5);
            --skill-card-bg: rgba(255, 255, 255, 0.7);
            --skill-card-border: rgba(0, 0, 0, 0.06);
            --skill-card-hover: rgba(255, 255, 255, 0.9);
            --divider-color: rgba(0, 0, 0, 0.25);
            --divider-line: rgba(0, 0, 0, 0.08);
            --orb-opacity: 0.25;
            --orb3-opacity: 0.15;
            --btn-bg: rgba(0, 0, 0, 0.05);
            --btn-border: rgba(0, 0, 0, 0.1);
            --logout-bg: rgba(0, 0, 0, 0.04);
            --logout-border: rgba(0, 0, 0, 0.08);
            --logout-color: rgba(0, 0, 0, 0.5);
            --step-line: rgba(108, 92, 231, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: var(--bg);
            overflow-x: hidden;
            transition: background 0.4s;
        }

        /* BG orbs */
        .bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
        .bg-orb {
            position: absolute; border-radius: 50%; filter: blur(80px);
            opacity: var(--orb-opacity); animation: float 8s ease-in-out infinite; transition: opacity 0.4s;
        }
        .bg-orb:nth-child(1) { width: 400px; height: 400px; background: #6c5ce7; top: -10%; left: -5%; }
        .bg-orb:nth-child(2) { width: 350px; height: 350px; background: #0984e3; bottom: -10%; right: -5%; animation-delay: -3s; }
        .bg-orb:nth-child(3) { width: 250px; height: 250px; background: #e17055; top: 50%; left: 50%; transform: translate(-50%,-50%); animation-delay: -5s; opacity: var(--orb3-opacity); }
        @keyframes float {
            0%,100% { transform: translate(0,0) scale(1); }
            33% { transform: translate(30px,-20px) scale(1.05); }
            66% { transform: translate(-20px,20px) scale(0.95); }
        }

        /* ===== LANDING ===== */
        #landingPage {
            position: relative; z-index: 1;
            transition: opacity 0.4s, transform 0.4s;
        }
        #landingPage.hidden {
            opacity: 0; transform: scale(0.96); pointer-events: none; position: absolute;
        }

        /* Top bar landing */
        .land-topbar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 20;
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 40px;
            background: var(--topbar-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            transition: background 0.4s, border-color 0.4s;
        }
        .land-logo {
            font-size: 20px; font-weight: 900; color: var(--text);
            display: flex; align-items: center; gap: 10px; transition: color 0.4s;
        }
        .land-logo-icon {
            width: 36px; height: 36px; border-radius: 12px;
            background: linear-gradient(135deg, #6c5ce7, #a855f7);
            display: flex; align-items: center; justify-content: center;
        }
        .land-logo-icon svg { width: 20px; height: 20px; fill: #fff; }
        .land-topbar-right { display: flex; align-items: center; gap: 12px; }
        .land-nav { display: flex; align-items: center; gap: 8px; }
        .land-nav a {
            color: var(--text-dim); text-decoration: none; font-size: 14px; font-weight: 500;
            padding: 8px 14px; border-radius: 10px; transition: color 0.2s, background 0.2s;
        }
        .land-nav a:hover { color: var(--text); background: var(--hover-bg); }

        .reg-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 22px;
            background: linear-gradient(135deg, #6c5ce7, #a855f7);
            border: none; border-radius: 12px; color: #fff;
            font-family: inherit; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
            box-shadow: 0 4px 20px rgba(108,92,231,0.3);
        }
        .reg-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(108,92,231,0.45); }
        .reg-btn svg { width: 18px; height: 18px; fill: currentColor; }

        /* Hero */
        .hero {
            padding: 160px 40px 80px; text-align: center; max-width: 900px; margin: 0 auto;
        }
        .hero-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 20px; border-radius: 100px;
            background: rgba(108,92,231,0.12); color: #a78bfa;
            font-size: 13px; font-weight: 600; margin-bottom: 28px;
        }
        .hero-badge svg { width: 16px; height: 16px; fill: currentColor; }
        .hero h1 {
            font-size: clamp(36px, 5.5vw, 64px); font-weight: 900; line-height: 1.1;
            color: var(--text); margin-bottom: 24px; letter-spacing: -1.5px;
            transition: color 0.4s;
        }
        .hero h1 span {
            background: linear-gradient(135deg, #6c5ce7, #a855f7, #ec4899);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .hero p {
            font-size: 18px; line-height: 1.7; color: var(--text-muted);
            max-width: 640px; margin: 0 auto 40px; transition: color 0.4s;
        }
        .hero-cta {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 18px 44px; border-radius: 16px;
            background: linear-gradient(135deg, #6c5ce7, #a855f7);
            color: #fff; text-decoration: none; font-size: 16px; font-weight: 700;
            box-shadow: 0 8px 30px rgba(108,92,231,0.35);
            transition: all 0.3s cubic-bezier(0.16,1,0.3,1); cursor: pointer; border: none;
            font-family: inherit;
        }
        .hero-cta:hover { transform: translateY(-3px); box-shadow: 0 14px 40px rgba(108,92,231,0.5); }
        .hero-cta svg { width: 20px; height: 20px; fill: currentColor; }

        /* Section titles */
        .section { padding: 80px 40px; max-width: 1200px; margin: 0 auto; }
        .section-label {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 6px 16px; border-radius: 100px;
            background: rgba(108,92,231,0.1); color: #a78bfa;
            font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;
            margin-bottom: 16px;
        }
        .section-title {
            font-size: clamp(28px, 4vw, 42px); font-weight: 800; color: var(--text);
            margin-bottom: 12px; letter-spacing: -0.5px; transition: color 0.4s;
        }
        .section-desc {
            font-size: 16px; color: var(--text-muted); max-width: 600px;
            line-height: 1.7; margin-bottom: 48px; transition: color 0.4s;
        }

        /* Feature grid */
        .feat-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;
        }
        .feat-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 24px; padding: 32px;
            transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .feat-card:hover {
            background: var(--skill-card-hover); transform: translateY(-6px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }
        .feat-card:first-child {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(108,92,231,0.12), rgba(168,85,247,0.08));
            border-color: rgba(108,92,231,0.2);
        }
        .feat-card:first-child .feat-icon { background: linear-gradient(135deg, #6c5ce7, #a855f7); }
        .feat-card:first-child .feat-icon svg { fill: #fff; }
        .feat-icon {
            width: 52px; height: 52px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px;
        }
        .feat-icon svg { width: 24px; height: 24px; }
        .feat-card h3 {
            font-size: 18px; font-weight: 700; color: var(--text);
            margin-bottom: 10px; transition: color 0.4s;
        }
        .feat-card p {
            font-size: 14px; color: var(--text-muted); line-height: 1.7;
            transition: color 0.4s;
        }

        .ic-purple { background: rgba(108,92,231,0.12); }
        .ic-purple svg { fill: #a78bfa; }
        .ic-blue { background: rgba(56,189,248,0.12); }
        .ic-blue svg { fill: #38bdf8; }
        .ic-green { background: rgba(52,211,153,0.12); }
        .ic-green svg { fill: #34d399; }
        .ic-orange { background: rgba(251,146,60,0.12); }
        .ic-orange svg { fill: #fb923c; }
        .ic-pink { background: rgba(236,72,153,0.12); }
        .ic-pink svg { fill: #ec4899; }
        .ic-cyan { background: rgba(34,211,238,0.12); }
        .ic-cyan svg { fill: #22d3ee; }

        /* Steps */
        .steps {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 0;
            position: relative; margin-top: 48px;
        }
        .steps::before {
            content: ''; position: absolute; top: 36px; left: 10%; right: 10%;
            height: 2px; background: var(--step-line); transition: background 0.4s;
        }
        .step {
            text-align: center; position: relative; padding: 0 12px;
        }
        .step-num {
            width: 72px; height: 72px; border-radius: 50%; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 800; color: #fff;
            background: linear-gradient(135deg, #6c5ce7, #a855f7);
            box-shadow: 0 8px 30px rgba(108,92,231,0.3);
            position: relative; z-index: 1;
        }
        .step h4 {
            font-size: 16px; font-weight: 700; color: var(--text);
            margin-bottom: 8px; transition: color 0.4s;
        }
        .step p {
            font-size: 13px; color: var(--text-muted); line-height: 1.6;
            transition: color 0.4s;
        }

        /* CTA banner */
        .cta-banner {
            margin: 80px 40px; max-width: 1120px; margin-left: auto; margin-right: auto;
            padding: 56px 48px; border-radius: 32px; text-align: center;
            background: linear-gradient(135deg, rgba(108,92,231,0.15), rgba(168,85,247,0.1));
            border: 1px solid rgba(108,92,231,0.2);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .cta-banner h2 {
            font-size: clamp(22px, 3vw, 32px); font-weight: 800; color: var(--text);
            margin-bottom: 16px; line-height: 1.3; transition: color 0.4s;
        }
        .cta-banner h2 span {
            background: linear-gradient(135deg, #6c5ce7, #a855f7, #ec4899);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .cta-banner p {
            font-size: 16px; color: var(--text-muted); max-width: 550px;
            margin: 0 auto 32px; line-height: 1.7; transition: color 0.4s;
        }

        /* ===== ONBOARDING ===== */
        #onboarding {
            display: none; position: fixed; inset: 0; z-index: 90;
            background: var(--bg); overflow-y: auto;
            transition: background 0.4s;
        }
        #onboarding.show { display: flex; flex-direction: column; align-items: center; }

        .onb-container {
            max-width: 720px; width: 90%; padding: 60px 0 80px; margin: 0 auto;
        }
        .onb-progress {
            display: flex; align-items: center; gap: 8px; margin-bottom: 48px;
        }
        .onb-step-dot {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700;
            background: var(--nav-icon-bg); color: var(--text-dim);
            transition: all 0.3s;
        }
        .onb-step-dot.active {
            background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff;
            box-shadow: 0 4px 16px rgba(108,92,231,0.3);
        }
        .onb-step-dot.done {
            background: rgba(52,211,153,0.15); color: #34d399;
        }
        .onb-step-line {
            flex: 1; height: 2px; background: var(--border-color); transition: background 0.4s;
        }
        .onb-step-line.done { background: rgba(52,211,153,0.3); }

        .onb-title {
            font-size: 28px; font-weight: 800; color: var(--text);
            margin-bottom: 8px; transition: color 0.4s;
        }
        .onb-subtitle {
            font-size: 15px; color: var(--text-muted); margin-bottom: 36px;
            transition: color 0.4s;
        }

        .niche-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px; margin-bottom: 36px;
        }
        .niche-item {
            padding: 16px 20px; border-radius: 16px;
            background: var(--card-bg); border: 2px solid var(--card-border);
            color: var(--text-secondary); font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; text-align: center;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .niche-item:hover {
            border-color: rgba(108,92,231,0.3); background: rgba(108,92,231,0.06);
        }
        .niche-item.selected {
            border-color: #6c5ce7; background: rgba(108,92,231,0.12);
            color: var(--text); font-weight: 600;
        }

        .onb-btn {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 16px 40px; border-radius: 14px;
            background: rgba(108,92,231,0.2); color: rgba(255,255,255,0.3);
            border: none; font-family: inherit; font-size: 15px; font-weight: 700;
            cursor: not-allowed; transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        .onb-btn.active {
            background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff;
            cursor: pointer; box-shadow: 0 6px 24px rgba(108,92,231,0.3);
        }
        .onb-btn.active:hover {
            transform: translateY(-2px); box-shadow: 0 10px 32px rgba(108,92,231,0.45);
        }
        .onb-btn svg { width: 18px; height: 18px; fill: currentColor; }
        body.light .onb-btn {
            background: rgba(108,92,231,0.08); color: rgba(0,0,0,0.25);
        }
        body.light .onb-btn.active {
            background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff;
        }

        .onb-textarea {
            width: 100%; min-height: 100px; padding: 14px 18px;
            border-radius: 14px; border: 2px solid var(--input-border);
            background: var(--input-bg); color: var(--text);
            font-family: inherit; font-size: 14px; line-height: 1.6;
            resize: vertical; transition: all 0.3s;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .onb-textarea:focus {
            outline: none; border-color: rgba(108,92,231,0.5);
            box-shadow: 0 0 0 4px rgba(108,92,231,0.1);
        }
        .onb-textarea::placeholder { color: var(--text-muted); }
        .onb-hint {
            font-size: 12px; color: var(--text-muted); margin-top: 6px;
        }
        .tags-section { margin-top: 8px; }
        .tags-label {
            font-size: 13px; color: var(--text-muted); margin-bottom: 12px; font-weight: 500;
        }
        .tags-list {
            display: flex; flex-wrap: wrap; gap: 8px;
        }
        .tag-chip {
            padding: 8px 16px; border-radius: 20px;
            background: var(--card-bg); border: 1.5px solid var(--card-border);
            color: var(--text-secondary); font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; user-select: none;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .tag-chip:hover {
            border-color: rgba(108,92,231,0.4); background: rgba(108,92,231,0.08);
            color: var(--text); transform: translateY(-1px);
        }
        .tag-chip:active {
            transform: scale(0.95);
        }
        .tag-chip.used {
            opacity: 0.4; border-style: dashed;
        }
        .onb-fields {
            display: flex; flex-direction: column; gap: 18px;
        }
        .onb-field { display: flex; flex-direction: column; gap: 6px; }
        .onb-field-label {
            font-size: 14px; font-weight: 600; color: var(--text-secondary);
        }
        .onb-input {
            width: 100%; padding: 14px 18px; border-radius: 14px;
            border: 2px solid var(--input-border); background: var(--input-bg);
            color: var(--text); font-family: inherit; font-size: 14px;
            transition: all 0.3s;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .onb-input:focus {
            outline: none; border-color: rgba(108,92,231,0.5);
            box-shadow: 0 0 0 4px rgba(108,92,231,0.1);
        }
        .onb-input::placeholder { color: var(--text-muted); }

        /* Access submit btn states */
        .access-submit {
            width: 100%; padding: 16px; margin-top: 8px;
            background: rgba(108,92,231,0.2); color: rgba(255,255,255,0.3);
            border: none; border-radius: 14px; font-family: inherit;
            font-size: 15px; font-weight: 700; cursor: not-allowed;
            transition: all 0.4s cubic-bezier(0.16,1,0.3,1);
        }
        .access-submit.active {
            background: linear-gradient(135deg, #6c5ce7, #a855f7);
            color: #fff; cursor: pointer;
            box-shadow: 0 6px 24px rgba(108,92,231,0.3);
        }
        .access-submit.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 32px rgba(108,92,231,0.45);
        }
        body.light .access-submit {
            background: rgba(108,92,231,0.08); color: rgba(0,0,0,0.25);
        }
        body.light .access-submit.active {
            background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff;
        }

        .access-success {
            display: none; flex-direction: column; align-items: center; gap: 16px; padding: 20px 0;
        }
        .access-success.show { display: flex; }
        .access-success-icon {
            width: 72px; height: 72px; border-radius: 50%;
            background: rgba(52,211,153,0.12);
            display: flex; align-items: center; justify-content: center;
        }
        .access-success-icon svg { width: 36px; height: 36px; fill: #34d399; }
        .access-success h3 { font-size: 22px; font-weight: 700; color: var(--text); }
        .access-success p { font-size: 14px; color: var(--text-muted); line-height: 1.6; text-align: center; }

        .field-hint {
            font-size: 12px; color: #f87171; margin-top: 6px; display: none;
        }
        .field-hint.show { display: block; }

        /* Footer */
        .land-footer {
            padding: 40px; text-align: center;
            color: var(--text-muted); font-size: 13px;
            border-top: 1px solid var(--border-color); transition: color 0.4s, border-color 0.4s;
        }

        /* Theme toggle */
        .theme-toggle {
            display: flex; align-items: center; gap: 8px;
            cursor: pointer; padding: 6px 10px; border-radius: 10px;
            transition: background 0.2s;
        }
        .theme-toggle:hover { background: var(--hover-bg); }
        .theme-toggle svg { width: 16px; height: 16px; fill: var(--text-muted); transition: fill 0.3s; }
        .toggle-track {
            width: 44px; height: 24px; border-radius: 12px;
            background: rgba(108,92,231,0.3); position: relative; transition: background 0.3s;
        }
        body.light .toggle-track { background: rgba(251,191,36,0.3); }
        .toggle-thumb {
            width: 20px; height: 20px; border-radius: 50%; background: #6c5ce7;
            position: absolute; top: 2px; left: 2px;
            transition: transform 0.3s cubic-bezier(0.16,1,0.3,1), background 0.3s;
        }
        body.light .toggle-thumb { transform: translateX(20px); background: #f59e0b; }
        .icon-moon, .icon-sun { transition: opacity 0.3s; }
        body.light .icon-moon { opacity: 0; width: 0; overflow: hidden; }
        body:not(.light) .icon-sun { opacity: 0; width: 0; overflow: hidden; }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--modal-bg); border: 1px solid var(--card-border);
            border-radius: 28px; padding: 44px 36px; max-width: 420px; width: 90%;
            text-align: center; box-shadow: 0 30px 80px rgba(0,0,0,0.5);
            transform: translateY(30px) scale(0.96); transition: transform 0.4s cubic-bezier(0.16,1,0.3,1), background 0.4s;
            position: relative;
        }
        .modal-overlay.active .modal { transform: translateY(0) scale(1); }
        .modal-close {
            position: absolute; top: 16px; right: 16px; width: 36px; height: 36px;
            border-radius: 10px; border: none; background: var(--link-bg);
            color: var(--text-dim); font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .modal-close:hover { background: var(--hover-bg); color: var(--text); }
        .modal-title { font-size: 26px; font-weight: 800; color: var(--text); margin-bottom: 8px; }
        .modal-subtitle { font-size: 14px; color: var(--text-muted); margin-bottom: 32px; }
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-label); margin-bottom: 8px; }
        .form-group input {
            width: 100%; padding: 14px 16px; background: var(--input-bg);
            border: 1px solid var(--input-border); border-radius: 14px; color: var(--text);
            font-family: inherit; font-size: 15px; outline: none; transition: border-color 0.3s, background 0.3s;
        }
        .form-group input::placeholder { color: var(--text-muted); }
        .form-group input:focus { border-color: rgba(108,92,231,0.6); background: rgba(108,92,231,0.06); }
        .form-group input.error { border-color: #ef4444; background: rgba(239,68,68,0.06); }
        .error-msg {
            display: none; margin-top: 12px; padding: 12px 16px;
            background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2);
            border-radius: 12px; color: #f87171; font-size: 13px; font-weight: 500; text-align: center;
        }
        .error-msg.show { display: block; }
        .submit-btn {
            width: 100%; padding: 16px; margin-top: 8px;
            background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff; border: none;
            border-radius: 14px; font-family: inherit; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
            box-shadow: 0 6px 24px rgba(108,92,231,0.3);
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 32px rgba(108,92,231,0.45); }
        .divider {
            display: flex; align-items: center; gap: 16px; margin: 24px 0;
            color: var(--divider-color); font-size: 13px; font-weight: 500;
        }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--divider-line); }
        .google-btn {
            width: 100%; padding: 14px; background: var(--link-bg);
            border: 1px solid var(--input-border); border-radius: 14px; color: var(--text);
            font-family: inherit; font-size: 15px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        .google-btn:hover { background: var(--hover-bg); transform: translateY(-2px); }
        .google-btn svg { width: 20px; height: 20px; flex-shrink: 0; }

        /* ===== DASHBOARD ===== */
        #dashboard { display: none; min-height: 100vh; animation: fadeIn 0.6s cubic-bezier(0.16,1,0.3,1) both; }
        #dashboard.show { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } }

        .dash-topbar {
            position: fixed; top: 0; left: 0; right: 280px; height: 64px;
            background: var(--topbar-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 32px; z-index: 50;
            transition: background 0.4s, border-color 0.4s;
        }
        .dash-logo { font-size: 18px; font-weight: 800; color: var(--text); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .dash-logo-icon {
            width: 32px; height: 32px; border-radius: 10px;
            background: linear-gradient(135deg, #6c5ce7, #a855f7);
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: 800; color: #fff;
        }
        .dash-user { display: flex; align-items: center; gap: 12px; }
        .dash-user-name { font-size: 14px; font-weight: 600; color: var(--text-dim); }
        .dash-logout {
            padding: 8px 16px; background: var(--logout-bg);
            border: 1px solid var(--logout-border); border-radius: 10px;
            color: var(--logout-color); font-family: inherit; font-size: 13px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .dash-logout:hover { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.2); color: #f87171; }

        .sidebar {
            position: fixed; top: 0; right: 0; width: 280px; height: 100vh;
            background: var(--sidebar-bg); border-left: 1px solid var(--border-color);
            padding: 32px 0; z-index: 51; display: flex; flex-direction: column;
            transition: background 0.4s, border-color 0.4s;
        }
        .sidebar-header {
            padding: 0 24px 28px; border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar-header h3 { font-size: 13px; font-weight: 700; color: var(--text-nav-header); text-transform: uppercase; letter-spacing: 1.2px; }
        .sidebar-nav { list-style: none; padding: 8px 12px; flex: 1; }
        .sidebar-nav li { margin-bottom: 2px; }
        .sidebar-nav a {
            display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 14px;
            color: var(--text-dim); text-decoration: none; font-size: 14px; font-weight: 500;
            transition: all 0.2s; cursor: pointer;
        }
        .sidebar-nav a:hover { color: var(--text-secondary); background: var(--hover-bg); }
        .sidebar-nav a.active { color: var(--text); background: rgba(108,92,231,0.15); font-weight: 600; }
        .sidebar-nav a.active .nav-icon { background: linear-gradient(135deg, #6c5ce7, #a855f7); }
        .sidebar-nav a.active .nav-icon svg { fill: #fff; }
        .nav-icon {
            width: 36px; height: 36px; border-radius: 10px; background: var(--nav-icon-bg);
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s;
        }
        .nav-icon svg { width: 18px; height: 18px; fill: var(--nav-icon-fill); transition: fill 0.2s; }

        .dash-content { flex: 1; margin-top: 64px; margin-right: 280px; padding: 40px; min-height: calc(100vh - 64px); }
        .dash-content h1 { font-size: 28px; font-weight: 800; color: var(--text); margin-bottom: 8px; }
        .dash-content .subtitle { font-size: 15px; color: var(--text-muted); margin-bottom: 40px; }

        .skill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .skill-card {
            background: var(--skill-card-bg); border: 1px solid var(--skill-card-border);
            border-radius: 20px; padding: 28px; transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        .skill-card:hover { background: var(--skill-card-hover); transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.2); }
        .skill-card-icon { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; font-size: 22px; }
        .skill-card h3 { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
        .skill-card p { font-size: 13px; color: var(--text-muted); line-height: 1.6; }
        .skill-card-tag { display: inline-block; margin-top: 16px; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; }
        .tag-active { background: rgba(52,211,153,0.12); color: #34d399; }
        .tag-draft { background: rgba(251,191,36,0.12); color: #fbbf24; }
        .tag-new { background: rgba(108,92,231,0.15); color: #a78bfa; }

        /* ===== BOT CONFIG PAGE ===== */
        .page-section { display: none; }
        .page-section.active { display: block; }

        .bot-header-title {
            font-size: 24px; font-weight: 800; color: var(--text); margin-bottom: 4px;
        }
        .bot-header-updated {
            font-size: 13px; color: var(--text-muted); margin-bottom: 28px;
        }
        .bot-tabs {
            display: flex; gap: 0; border-bottom: 2px solid var(--border-color);
            margin-bottom: 32px; overflow-x: auto;
        }
        .bot-tab {
            padding: 12px 20px; font-size: 14px; font-weight: 600;
            color: var(--text-muted); cursor: pointer; border: none;
            background: none; font-family: inherit; white-space: nowrap;
            border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: all 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .bot-tab:hover { color: var(--text-secondary); }
        .bot-tab.active {
            color: var(--text); border-bottom-color: #6c5ce7;
        }
        .bot-tab-badge {
            padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 600;
            background: var(--text); color: var(--bg); white-space: nowrap;
        }
        .bot-tab-content { display: none; }
        .bot-tab-content.active { display: block; }

        .bot-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 20px; padding: 28px; margin-bottom: 20px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        .bot-card-title {
            font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 4px;
        }
        .bot-card-desc {
            font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5;
        }
        .bot-textarea {
            width: 100%; min-height: 120px; padding: 14px 18px;
            border-radius: 14px; border: 1.5px solid var(--input-border);
            background: var(--input-bg); color: var(--text);
            font-family: inherit; font-size: 14px; line-height: 1.6;
            resize: vertical; transition: all 0.3s;
        }
        .bot-textarea:focus {
            outline: none; border-color: rgba(108,92,231,0.5);
            box-shadow: 0 0 0 4px rgba(108,92,231,0.1);
        }
        .bot-textarea::placeholder { color: var(--text-muted); }
        .bot-char-count {
            text-align: right; font-size: 12px; color: var(--text-muted); margin-top: 6px;
        }

        .rule-item {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 12px 0; border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }
        .rule-item.dragging { opacity: 0.4; }
        .rule-item.drag-over { border-top: 2px solid #6c5ce7; }
        .rule-num {
            min-width: 24px; height: 24px; border-radius: 8px; margin-top: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; color: var(--text-muted);
            background: var(--nav-icon-bg);
        }
        .rule-body { flex: 1; }
        .rule-input {
            width: 100%; padding: 10px 14px;
            border-radius: 12px; border: 1.5px solid var(--input-border);
            background: var(--input-bg); color: var(--text);
            font-family: inherit; font-size: 14px; line-height: 1.5;
            resize: none; min-height: 44px; transition: all 0.3s;
        }
        .rule-input:focus {
            outline: none; border-color: rgba(108,92,231,0.5);
            box-shadow: 0 0 0 4px rgba(108,92,231,0.1);
        }
        .rule-input::placeholder { color: var(--text-muted); }
        .rule-char-count {
            text-align: right; font-size: 11px; color: var(--text-muted); margin-top: 4px;
        }
        .rule-actions {
            display: flex; gap: 4px; margin-top: 8px;
        }
        .rule-action-btn {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            background: none; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .rule-action-btn:hover { background: var(--hover-bg); color: var(--text); }
        .rule-action-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .rule-drag { cursor: grab; }
        .rule-drag:active { cursor: grabbing; }

        .add-rule-btn {
            width: 100%; padding: 14px; margin-top: 12px;
            border-radius: 14px; border: 1.5px dashed var(--input-border);
            background: none; color: var(--text-muted);
            font-family: inherit; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .add-rule-btn:hover {
            border-color: rgba(108,92,231,0.4); color: var(--text);
            background: rgba(108,92,231,0.04);
        }

        .save-status {
            font-size: 13px; color: var(--text-muted); font-style: italic;
        }
        .save-status.saving { color: #fbbf24; }
        .save-status.saved { color: #34d399; }

        .stub-content {
            text-align: center; padding: 80px 20px;
            color: var(--text-muted); font-size: 16px;
        }

        .important-badge {
            display: flex; align-items: center; gap: 6px;
            font-size: 13px; font-weight: 700; color: #f59e0b;
            white-space: nowrap; flex-shrink: 0;
        }
        .info-icon {
            position: relative; cursor: pointer; color: var(--text-muted);
            display: inline-flex; align-items: center;
        }
        .info-tooltip {
            display: none; position: absolute; right: 0; top: 28px;
            width: 280px; padding: 12px 16px; border-radius: 12px;
            background: var(--modal-bg); border: 1px solid var(--card-border);
            color: var(--text-secondary); font-size: 13px; font-weight: 400;
            line-height: 1.5; box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            z-index: 10; white-space: normal;
        }
        .info-icon:hover .info-tooltip,
        .info-icon:focus .info-tooltip { display: block; }

        .rule-audio-btn {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            background: none; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; margin-top: 8px; position: relative;
        }
        .rule-audio-btn:hover { background: rgba(108,92,231,0.1); color: #a78bfa; }
        .rule-audio-btn.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .rule-audio-btn.playing { color: #ef4444; }
        .rule-audio-btn.playing:hover { background: rgba(239,68,68,0.1); }
        .rule-audio-btn.loading { color: #a78bfa; pointer-events: none; }
        .rule-audio-btn svg { width: 18px; height: 18px; fill: currentColor; }
        @keyframes tts-spin {
            to { transform: rotate(360deg); }
        }
        .rule-audio-btn.loading svg {
            animation: tts-spin 1s linear infinite;
        }

        .tts-toast {
            position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(80px);
            padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600;
            background: #ef4444; color: #fff; z-index: 9999;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: transform 0.3s cubic-bezier(0.16,1,0.3,1), opacity 0.3s;
            opacity: 0; pointer-events: none;
        }
        .tts-toast.show {
            transform: translateX(-50%) translateY(0); opacity: 1;
        }

        .add-rule-btn.disabled {
            opacity: 0.4; cursor: not-allowed; pointer-events: none;
        }

        .lang-btn {
            padding: 4px 10px; border-radius: 8px; border: 1.5px solid var(--card-border);
            background: var(--card-bg); color: var(--text-secondary);
            font-family: inherit; font-size: 12px; font-weight: 700;
            cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .lang-btn:hover { border-color: rgba(108,92,231,0.4); background: rgba(108,92,231,0.08); }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; border-left: none; border-top: 1px solid var(--border-color); }
            .dash-topbar { right: 0; }
            .dash-content { margin-right: 0; }
            #dashboard.show { flex-direction: column; }
            .steps { grid-template-columns: repeat(2, 1fr); gap: 32px; }
            .steps::before { display: none; }
            .feat-grid { grid-template-columns: 1fr; }
            .feat-card:first-child { grid-column: auto; }
        }
        @media (max-width: 480px) {
            .hero { padding: 130px 20px 60px; }
            .hero h1 { font-size: 32px; }
            .section { padding: 60px 20px; }
            .cta-banner { margin: 60px 20px; padding: 40px 24px; }
            .steps { grid-template-columns: 1fr; }
            .land-topbar { padding: 12px 16px; }
            .dash-content { padding: 24px 16px; }
        }

        /* ===== DIALOG LIST ===== */
        .dlg-list-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px;
        }
        .dlg-list-header h1 { font-size: 22px; font-weight: 700; color: var(--text); }
        .dlg-list-actions { display: flex; gap: 10px; }

        .dlg-btn-create {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 9px 18px; border-radius: 10px; border: none;
            background: linear-gradient(135deg, #6c5ce7, #a78bfa);
            color: #fff; font-family: inherit; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: opacity 0.2s;
        }
        .dlg-btn-create:hover { opacity: 0.88; }

        .dlg-btn-quickstart {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 9px 18px; border-radius: 10px;
            border: 1.5px solid var(--card-border);
            background: var(--card-bg); color: var(--text-secondary);
            font-family: inherit; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .dlg-btn-quickstart:hover { border-color: rgba(108,92,231,0.4); background: rgba(108,92,231,0.08); }

        /* Quick Start Wizard */
        .qs-overlay {
            position: fixed; inset: 0; z-index: 10000;
            background: rgba(0,0,0,0.55); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
        }
        .qs-overlay.active { display: flex; }
        .qs-modal {
            background: var(--modal-bg); border-radius: 18px;
            width: 680px; max-width: 94vw; max-height: 88vh;
            overflow-y: auto; padding: 36px 32px 28px;
            box-shadow: 0 24px 80px rgba(0,0,0,0.35);
            position: relative; animation: modalIn 0.25s ease;
        }
        .qs-modal-title {
            font-size: 22px; font-weight: 700; color: var(--text);
            margin-bottom: 4px;
        }
        .qs-modal-sub {
            font-size: 13px; color: var(--text-muted); margin-bottom: 24px;
        }
        .qs-progress {
            display: flex; align-items: center; justify-content: center;
            gap: 0; margin-bottom: 28px;
        }
        .qs-dot {
            width: 28px; height: 28px; border-radius: 50%;
            background: var(--input-bg); border: 2px solid var(--input-border);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; color: var(--text-muted);
            transition: all 0.25s; flex-shrink: 0;
        }
        .qs-dot.active {
            border-color: #6c5ce7; background: rgba(108,92,231,0.15); color: #6c5ce7;
        }
        .qs-dot.done {
            border-color: #00b894; background: rgba(0,184,148,0.15); color: #00b894;
        }
        .qs-line {
            width: 32px; height: 2px; background: var(--input-border);
            transition: background 0.25s; flex-shrink: 0;
        }
        .qs-line.done { background: #00b894; }
        .qs-step { display: none; }
        .qs-step.active { display: block; }
        .qs-label {
            font-size: 13px; font-weight: 600; color: var(--text-secondary);
            margin-bottom: 6px; display: block;
        }
        .qs-field { margin-bottom: 16px; }
        .qs-textarea {
            width: 100%; min-height: 64px; border-radius: 10px;
            border: 1.5px solid var(--input-border); background: var(--input-bg);
            color: var(--text); font-family: inherit; font-size: 13px;
            padding: 10px 12px; resize: vertical; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .qs-textarea:focus { outline: none; border-color: #6c5ce7; }
        .qs-select {
            width: 100%; border-radius: 10px;
            border: 1.5px solid var(--input-border); background: var(--input-bg);
            color: var(--text); font-family: inherit; font-size: 13px;
            padding: 10px 12px; box-sizing: border-box;
            transition: border-color 0.2s; appearance: auto;
        }
        .qs-select:focus { outline: none; border-color: #6c5ce7; }
        .qs-upload-area {
            border: 2px dashed var(--input-border); border-radius: 12px;
            padding: 32px 20px; text-align: center; cursor: pointer;
            color: var(--text-muted); font-size: 13px;
            transition: border-color 0.2s, background 0.2s;
        }
        .qs-upload-area:hover, .qs-upload-area.dragover {
            border-color: #6c5ce7; background: rgba(108,92,231,0.05);
        }
        .qs-file-list { margin-top: 10px; }
        .qs-file-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 10px; background: var(--input-bg);
            border-radius: 8px; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);
        }
        .qs-file-item button {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; font-size: 14px; padding: 0 2px;
        }
        .qs-nav {
            display: flex; gap: 10px; justify-content: flex-end;
            margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--card-border);
        }
        .qs-btn-back, .qs-btn-next, .qs-btn-skip {
            padding: 10px 22px; border-radius: 10px; font-family: inherit;
            font-size: 13px; font-weight: 600; cursor: pointer;
            border: 1.5px solid var(--card-border); transition: all 0.2s;
        }
        .qs-btn-back { background: var(--btn-bg); color: var(--text-secondary); }
        .qs-btn-back:hover { border-color: rgba(108,92,231,0.4); }
        .qs-btn-skip { background: none; color: var(--text-muted); border-color: transparent; }
        .qs-btn-skip:hover { color: var(--text-secondary); }
        .qs-btn-next {
            background: linear-gradient(135deg, #6c5ce7, #a855f7);
            color: #fff; border: none;
        }
        .qs-btn-next:hover { opacity: 0.9; }

        .dlg-table-wrapper {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 14px; overflow: hidden;
            box-shadow: var(--card-shadow); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .dlg-table { width: 100%; border-collapse: collapse; }
        .dlg-table thead th {
            text-align: left; padding: 12px 16px;
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
        }
        .dlg-table thead th:last-child { width: 48px; text-align: center; }
        .dlg-table tbody tr {
            cursor: pointer; transition: background 0.15s;
        }
        .dlg-table tbody tr:hover { background: var(--hover-bg); }
        .dlg-table tbody td {
            padding: 14px 16px; font-size: 14px; color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        .dlg-table tbody tr:last-child td { border-bottom: none; }

        .dlg-name-cell { font-weight: 600; color: var(--text) !important; }
        .dlg-name-wrap { display: flex; align-items: center; gap: 10px; }
        .dlg-ring { position: relative; flex-shrink: 0; width: 28px; height: 28px; }
        .dlg-ring svg { transform: rotate(-90deg); }
        .dlg-ring-bg { fill: none; stroke: var(--input-border); stroke-width: 3; }
        .dlg-ring-fill { fill: none; stroke-width: 3; stroke-linecap: round; transition: stroke-dashoffset .5s, stroke .4s; }
        .dlg-ring-pct {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-size: 8px; font-weight: 700; color: var(--text-secondary); line-height: 1;
        }
        .dlg-status-hint {
            display: flex; align-items: center; gap: 6px; font-size: 11px; margin-top: 2px;
            color: var(--text-muted); line-height: 1.3;
        }
        .dlg-status-hint.ready { color: #2ecc71; }
        .dlg-status-hint.warning { color: #f1c40f; }
        .dlg-status-hint.danger { color: #e74c3c; }

        .dlg-toggle { display: flex; align-items: center; gap: 8px; position: relative; }
        .dlg-toggle-track {
            width: 38px; height: 20px; border-radius: 10px; position: relative; cursor: pointer;
            background: rgba(255,255,255,0.12); transition: background .3s;
        }
        body.light .dlg-toggle-track { background: rgba(0,0,0,0.12); }
        .dlg-toggle-track.on { background: #2ecc71; }
        .dlg-toggle-track.disabled { opacity: 0.4; cursor: not-allowed; }
        .dlg-toggle-thumb {
            width: 16px; height: 16px; border-radius: 50%; background: #fff;
            position: absolute; top: 2px; left: 2px;
            transition: transform .3s cubic-bezier(0.16,1,0.3,1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .dlg-toggle-track.on .dlg-toggle-thumb { transform: translateX(18px); }
        .dlg-toggle-label {
            font-size: 12px; font-weight: 500; white-space: nowrap;
            color: var(--text-muted); transition: color .3s;
        }
        .dlg-toggle-label.on { color: #2ecc71; }
        .dlg-toggle-tip {
            position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%);
            background: var(--modal-bg); border: 1px solid var(--card-border);
            border-radius: 8px; padding: 8px 12px; min-width: 210px;
            font-size: 12px; line-height: 1.4; color: var(--text-secondary);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); white-space: normal; text-align: center;
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity .2s, visibility .2s;
            z-index: 50;
        }
        .dlg-toggle-tip::after {
            content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            border: 6px solid transparent; border-top-color: var(--card-border);
        }
        .dlg-toggle:hover .dlg-toggle-tip { opacity: 1; visibility: visible; }
        .dlg-date { font-size: 13px; color: var(--text-muted) !important; white-space: nowrap; }

        .dlg-name-input {
            background: var(--input-bg); border: 1.5px solid rgba(108,92,231,0.5);
            border-radius: 6px; padding: 4px 8px; color: var(--text);
            font-family: inherit; font-size: 14px; font-weight: 600;
            outline: none; width: 100%;
        }

        .dlg-menu-btn {
            background: none; border: none; color: var(--text-muted);
            font-size: 18px; cursor: pointer; padding: 4px 8px;
            border-radius: 6px; transition: background 0.15s; position: relative;
        }
        .dlg-menu-btn:hover { background: var(--hover-bg); color: var(--text); }

        .dlg-context-menu {
            position: fixed;
            background: var(--modal-bg); border: 1px solid var(--card-border);
            border-radius: 10px; min-width: 160px; padding: 4px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4); z-index: 100;
            display: none;
        }
        .dlg-context-menu.show { display: block; }
        .dlg-context-header {
            padding: 8px 12px 4px; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: .5px; color: var(--text-muted);
        }
        .dlg-context-item {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 12px; border-radius: 6px; border: none;
            background: none; color: var(--text-secondary);
            font-family: inherit; font-size: 13px; cursor: pointer;
            width: 100%; text-align: left; transition: background 0.15s;
        }
        .dlg-context-item:hover { background: var(--hover-bg); }
        .dlg-context-item.danger { color: #ef4444; }
        .dlg-context-item.danger:hover { background: rgba(239,68,68,0.1); }

        .dlg-back-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 7px 14px; border-radius: 8px;
            border: 1.5px solid var(--card-border);
            background: var(--card-bg); color: var(--text-secondary);
            font-family: inherit; font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; margin-bottom: 16px;
        }
        .dlg-back-btn:hover { border-color: rgba(108,92,231,0.4); background: rgba(108,92,231,0.08); }

        .dlg-empty {
            text-align: center; padding: 48px 20px; color: var(--text-muted);
            font-size: 14px;
        }

        /* ===== STATS PAGE STYLES ===== */
        .st-wrap { font-family: 'Onest', 'Inter', sans-serif; color: #fff; }
        .st-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 28px;
        }
        .st-header h2 { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; color: #fff; }
        .st-tabs { display: flex; gap: 6px; background: rgba(255,255,255,0.04); border-radius: 10px; padding: 4px; }
        .st-tab {
            padding: 7px 18px; border-radius: 8px; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all .2s; color: rgba(255,255,255,0.7); border: none; background: none;
        }
        .st-tab.active { background: #4f8eff; color: #fff; }

        .st-dlg-picker { position: relative; }
        .st-dlg-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 7px 16px; border-radius: 10px; font-size: 13px; font-weight: 500;
            cursor: pointer; border: 1px solid var(--input-border); background: var(--input-bg);
            color: var(--text-secondary); transition: all .2s; white-space: nowrap;
        }
        .st-dlg-btn:hover { border-color: #4f8eff; color: #4f8eff; }
        .st-dlg-btn.active { border-color: #4f8eff; color: #4f8eff; background: rgba(79,142,255,0.08); }
        .st-dlg-btn svg { flex-shrink: 0; }
        .st-dlg-dropdown {
            position: absolute; top: calc(100% + 8px); right: 0; z-index: 100;
            min-width: 260px; max-height: 320px; overflow-y: auto;
            background: var(--modal-bg); border: 1px solid var(--card-border);
            border-radius: 12px; box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            opacity: 0; visibility: hidden; transform: translateY(-8px);
            transition: opacity .2s, transform .2s, visibility .2s;
        }
        .st-dlg-dropdown.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .st-dlg-dropdown-header {
            padding: 12px 16px 8px; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: .5px; color: var(--text-muted);
        }
        .st-dlg-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 16px; cursor: pointer; font-size: 13px;
            color: var(--text-secondary); transition: background .15s;
        }
        .st-dlg-item:hover { background: var(--hover-bg); }
        .st-dlg-item.active { color: #4f8eff; font-weight: 600; }
        .st-dlg-item .st-dlg-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--text-muted); flex-shrink: 0;
        }
        .st-dlg-item.active .st-dlg-dot { background: #4f8eff; }
        .st-dlg-item-all { border-bottom: 1px solid var(--border-color); }
        .st-dlg-current-name {
            max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .st-datepicker-wrap { position: relative; }
        .st-datepicker-btn {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            color: #fff; border-radius: 10px; padding: 9px 16px;
            font-size: 14px; font-family: 'Onest','Inter',sans-serif; cursor: pointer;
            transition: border-color .2s;
        }
        .st-datepicker-btn:hover { border-color: #4f8eff; }
        .st-datepicker-btn svg { color: #4f8eff; }

        .st-calendar-popup {
            position: fixed; z-index: 10000;
            background: #1e2330; border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px; padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,.6);
            display: none; min-width: 560px; max-width: 94vw;
            max-height: 80vh; overflow-y: auto;
        }
        .st-calendar-popup.open { display: block; }
        .st-calendar-popup::-webkit-scrollbar { width: 5px; }
        .st-calendar-popup::-webkit-scrollbar-track { background: rgba(255,255,255,0.04); border-radius: 4px; }
        .st-calendar-popup::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }

        .st-cal-section { flex: 1; min-width: 240px; }
        .st-cal-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 14px;
        }
        .st-cal-header span { font-weight: 600; font-size: 14px; color: #fff; }
        .st-cal-nav { background: none; border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.7);
            border-radius: 6px; width: 28px; height: 28px; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; justify-content: center; transition: all .2s; }
        .st-cal-nav:hover { border-color: #4f8eff; color: #4f8eff; }

        .st-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .st-cal-day-name {
            text-align: center; font-size: 11px; font-weight: 600;
            color: rgba(255,255,255,0.7); padding: 4px 0; text-transform: uppercase;
        }
        .st-cal-day {
            text-align: center; padding: 7px 4px; border-radius: 7px;
            font-size: 13px; cursor: pointer; transition: all .15s; color: #fff;
        }
        .st-cal-day:hover { background: rgba(255,255,255,0.08); }
        .st-cal-day.selected { background: #4f8eff; color: #fff; font-weight: 600; }
        .st-cal-day.in-range { background: rgba(79,142,255,.15); color: #4f8eff; }
        .st-cal-day.today { border: 1px solid #4f8eff; color: #4f8eff; }
        .st-cal-day.empty { cursor: default; }
        .st-cal-day.other-month { color: rgba(255,255,255,0.7); opacity: .4; }

        .st-cal-presets { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 16px; }
        .st-preset-btn {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.7); border-radius: 7px; padding: 5px 12px;
            font-size: 12px; cursor: pointer; transition: all .2s; font-family: 'Onest','Inter',sans-serif;
        }
        .st-preset-btn:hover { border-color: #4f8eff; color: #4f8eff; }

        .st-cal-apply {
            width: 100%; margin-top: 16px; padding: 10px;
            background: #4f8eff; border: none; border-radius: 9px;
            color: #fff; font-family: 'Onest','Inter',sans-serif; font-weight: 600; font-size: 14px;
            cursor: pointer; transition: opacity .2s;
        }
        .st-cal-apply:hover { opacity: .85; }

        .st-stats-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
            margin-bottom: 28px;
        }
        .st-stat-card {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px; padding: 22px; transition: border-color .2s;
        }
        .st-stat-card:hover { border-color: #4f8eff; }
        .st-stat-label { font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 10px; }
        .st-stat-value { font-size: 32px; font-weight: 700; letter-spacing: -1px; margin-bottom: 6px; color: #fff; }
        .st-stat-sub { font-size: 13px; color: rgba(255,255,255,0.7); }
        .st-stat-sub strong { color: #fff; }
        .st-stat-badge {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 12px; font-weight: 600; padding: 3px 8px; border-radius: 6px; margin-left: 8px;
        }
        .st-badge-up { background: rgba(46,204,113,.15); color: #2ecc71; }
        .st-badge-down { background: rgba(231,76,60,.15); color: #e74c3c; }

        .st-calls-section { margin-top: 8px; }
        .st-calls-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 16px; flex-wrap: wrap;
        }
        .st-calls-title { font-size: 18px; font-weight: 700; color: #fff; }

        .st-filters-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .st-filter-select {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            color: #fff; border-radius: 9px; padding: 8px 14px;
            font-size: 13px; font-family: 'Onest','Inter',sans-serif; cursor: pointer;
            appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7898' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center;
            padding-right: 28px; transition: border-color .2s;
        }
        .st-filter-select:hover, .st-filter-select:focus { border-color: #4f8eff; outline: none; }

        .st-search-input {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            color: #fff; border-radius: 9px; padding: 8px 14px;
            font-size: 13px; font-family: 'Onest','Inter',sans-serif; flex: 1; min-width: 180px;
            transition: border-color .2s;
        }
        .st-search-input:focus { border-color: #4f8eff; outline: none; }
        .st-search-input::placeholder { color: rgba(255,255,255,0.5); }

        .st-calls-scroll {
            max-height: 560px; overflow-y: auto; padding-right: 4px;
        }
        .st-calls-scroll::-webkit-scrollbar { width: 5px; }
        .st-calls-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.04); border-radius: 4px; }
        .st-calls-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }

        .st-call-row {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px; padding: 16px 20px;
            margin-bottom: 10px; display: grid;
            grid-template-columns: 40px 1fr 110px 100px 110px 120px 130px 60px;
            align-items: center; gap: 12px;
            transition: border-color .2s, transform .15s; cursor: pointer;
        }
        .st-call-row:hover { border-color: #4f8eff; transform: translateX(2px); }

        .st-call-num { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #fff; }
        .st-call-name { font-weight: 600; font-size: 14px; margin-bottom: 3px; color: #fff; }
        .st-call-phone { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: rgba(255,255,255,0.7); }

        .st-status-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 7px; font-size: 12px; font-weight: 600;
        }
        .st-status-success { background: rgba(46,204,113,.12); color: #2ecc71; border: 1px solid rgba(46,204,113,.25); }
        .st-status-fail { background: rgba(231,76,60,.12); color: #e74c3c; border: 1px solid rgba(231,76,60,.25); }
        .st-status-noanswer { background: rgba(241,196,15,.12); color: #f1c40f; border: 1px solid rgba(241,196,15,.25); }
        .st-status-busy { background: rgba(155,89,182,.12); color: #9b59b6; border: 1px solid rgba(155,89,182,.25); }

        .st-lead-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 7px; font-size: 12px; font-weight: 600;
        }
        .st-lead-yes { background: rgba(79,142,255,.12); color: #4f8eff; border: 1px solid rgba(79,142,255,.25); }
        .st-lead-no { background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.08); }

        .st-call-dur { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 500; color: #fff; }
        .st-call-date { font-size: 12px; color: rgba(255,255,255,0.7); }

        .st-play-btn {
            width: 34px; height: 34px; border-radius: 50%;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all .2s; font-size: 11px;
        }
        .st-play-btn:hover { background: #4f8eff; border-color: #4f8eff; color: #fff; }

        .st-player-expand {
            display: none; grid-column: 1 / -1;
            background: rgba(255,255,255,0.03); border-top: 1px solid rgba(255,255,255,0.08);
            padding: 14px; border-radius: 0 0 10px 10px; margin-top: 8px;
        }
        .st-player-expand.open { display: block; }
        .st-audio-bar { display: flex; align-items: center; gap: 12px; }
        .st-audio-play { width: 32px; height: 32px; border-radius: 50%; background: #4f8eff;
            border: none; color: #fff; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; }
        .st-audio-track { flex: 1; height: 4px; background: rgba(255,255,255,0.08); border-radius: 4px; position: relative; cursor: pointer; }
        .st-audio-fill { height: 100%; background: #4f8eff; border-radius: 4px; width: 35%; }
        .st-audio-time { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #fff; }

        .st-col-labels {
            display: grid;
            grid-template-columns: 40px 1fr 110px 100px 110px 120px 130px 60px;
            gap: 12px; padding: 0 20px 10px;
            font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: .5px;
        }

        .st-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; }
        .st-dot-green { background: #2ecc71; }
        .st-dot-red { background: #e74c3c; }
        .st-dot-yellow { background: #f1c40f; }
        .st-dot-purple { background: #9b59b6; }

        @media (max-width: 900px) {
            .st-stats-grid { grid-template-columns: 1fr 1fr; }
            .st-call-row { grid-template-columns: 1fr 1fr 1fr; grid-template-rows: auto auto; }
            .st-col-labels { display: none; }
        }
        /* ===== SUPPORT CHAT ===== */
        .sc-fab {
            position: fixed; bottom: 24px; right: 24px; z-index: 9998;
            width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer;
            background: linear-gradient(135deg, #6c5ce7, #a855f7);
            box-shadow: 0 4px 20px rgba(108, 92, 231, 0.4);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .sc-fab:hover { transform: scale(1.1); box-shadow: 0 6px 28px rgba(108, 92, 231, 0.55); }
        .sc-fab.open svg { display: none; }
        .sc-fab.open::after { content: ''; color: #fff; font-size: 28px; line-height: 1; }

        .sc-window {
            position: fixed; bottom: 92px; right: 24px; z-index: 9998;
            width: 380px; height: 500px; border-radius: 16px;
            background: var(--modal-bg); border: 1px solid var(--card-border);
            box-shadow: 0 12px 40px rgba(0,0,0,0.35);
            display: flex; flex-direction: column; overflow: hidden;
            opacity: 0; visibility: hidden; transform: scale(0.9) translateY(20px);
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
        }
        .sc-window.open { opacity: 1; visibility: visible; transform: scale(1) translateY(0); }

        .sc-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 18px; background: linear-gradient(135deg, #6c5ce7, #a855f7);
        }
        .sc-header-title { color: #fff; font-size: 15px; font-weight: 600; }
        .sc-header-status { color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 2px; }
        .sc-close {
            background: none; border: none; color: #fff; font-size: 22px; cursor: pointer;
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: background 0.2s;
        }
        .sc-close:hover { background: rgba(255,255,255,0.2); }

        .sc-messages {
            flex: 1; overflow-y: auto; padding: 16px; display: flex;
            flex-direction: column; gap: 12px;
        }
        .sc-msg { max-width: 80%; padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.45; }
        .sc-msg.support {
            align-self: flex-start; background: var(--input-bg); color: var(--text);
            border-bottom-left-radius: 4px;
        }
        .sc-msg.user {
            align-self: flex-end; background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff;
            border-bottom-right-radius: 4px;
        }
        .sc-msg-time { font-size: 10px; opacity: 0.6; margin-top: 4px; }
        .sc-msg-file { font-size: 12px; opacity: 0.85; margin-top: 4px; }
        .sc-msg-file::before { content: ' '; }

        .sc-file-preview {
            padding: 6px 14px; border-top: 1px solid var(--border-color);
            display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
        }
        .sc-file-tag {
            display: inline-flex; align-items: center; gap: 4px;
            background: var(--input-bg); border-radius: 8px; padding: 4px 10px;
            font-size: 12px; color: var(--text-secondary);
        }
        .sc-file-tag button {
            background: none; border: none; cursor: pointer; color: var(--text-muted);
            font-size: 14px; line-height: 1; padding: 0 0 0 2px;
        }

        .sc-input-area {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 14px; border-top: 1px solid var(--border-color);
        }
        .sc-attach-btn, .sc-send-btn {
            background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px;
            color: var(--text-muted); transition: color 0.2s;
        }
        .sc-attach-btn:hover, .sc-send-btn:hover { color: #a855f7; }
        .sc-input {
            flex: 1; background: var(--input-bg); border: 1px solid var(--input-border);
            border-radius: 10px; padding: 9px 14px; font-size: 13px;
            color: var(--text); outline: none; font-family: inherit;
        }
        .sc-input::placeholder { color: var(--text-muted); }

        @media (max-width: 480px) {
            .sc-window { width: calc(100vw - 24px); right: 12px; bottom: 80px; height: 60vh; }
            .sc-fab { bottom: 16px; right: 16px; }
        }

        /* Management modal */
        .mgmt-section { margin-bottom: 20px; }
        .mgmt-section-title {
            font-size: 13px; font-weight: 600; text-transform: uppercase;
            color: var(--text-muted); margin-bottom: 10px; letter-spacing: 0.5px;
        }
        .mgmt-days { display: flex; gap: 6px; margin-bottom: 12px; }
        .mgmt-day {
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--input-border);
            background: var(--input-bg); color: var(--text-secondary); font-size: 12px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; font-family: inherit;
        }
        .mgmt-day:hover { border-color: rgba(108,92,231,0.4); }
        .mgmt-day.on {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: #fff;
            border-color: transparent; box-shadow: 0 2px 8px rgba(108,92,231,0.3);
        }
        .mgmt-time-row { display: flex; gap: 12px; align-items: center; }
        .mgmt-time-input {
            flex: 1; background: var(--input-bg); border: 1px solid var(--input-border);
            border-radius: 10px; padding: 9px 14px; font-size: 14px;
            color: var(--text); outline: none; font-family: inherit;
            transition: border-color 0.2s;
        }
        .mgmt-time-input:focus { border-color: #6c5ce7; }
        .mgmt-toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0;
        }
        .mgmt-toggle-label { font-size: 14px; color: var(--text-secondary); }
        .mgmt-number-input {
            width: 120px; background: var(--input-bg); border: 1px solid var(--input-border);
            border-radius: 10px; padding: 9px 14px; font-size: 14px;
            color: var(--text); outline: none; font-family: inherit;
            transition: border-color 0.2s;
        }
        .mgmt-number-input:focus { border-color: #6c5ce7; }
        .mgmt-time-sep { color: var(--text-muted); font-size: 13px; font-weight: 500; }

        /* Settings cards */
        .settings-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .settings-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 20px; padding: 28px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s; display: flex; flex-direction: column;
        }
        .settings-card:hover { border-color: rgba(108,92,231,0.3); }
        .settings-card-title { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .settings-card-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; flex: 1; }
        .settings-card-btn {
            align-self: flex-start; padding: 10px 24px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff;
            font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.3s; box-shadow: 0 4px 16px rgba(108,92,231,0.25);
        }
        .settings-card-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(108,92,231,0.4); }
        .settings-info-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--card-border); }
        .settings-info-row:last-child { border-bottom: none; }
        .settings-info-label { font-size: 14px; color: var(--text-muted); }
        .settings-info-value { font-size: 15px; font-weight: 600; color: var(--text); }
        .settings-download-link {
            display: inline-flex; align-items: center; gap: 6px; margin-top: 12px;
            color: #6c5ce7; font-size: 14px; font-weight: 600; cursor: pointer; text-decoration: none;
            transition: opacity 0.2s;
        }
        .settings-download-link:hover { opacity: 0.8; }
        .settings-modal-body { text-align: left; max-height: 65vh; overflow-y: auto; padding-right: 4px; }
        .settings-modal-body .mgmt-section { margin-bottom: 16px; }

        /* Template cards */
        .tpl-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .tpl-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 20px; padding: 28px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s; display: flex; flex-direction: column;
        }
        .tpl-card:hover { border-color: rgba(108,92,231,0.3); }
        .tpl-card-title { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .tpl-card-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; flex: 1; }
        .tpl-audio { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; padding: 10px 14px; background: var(--input-bg); border-radius: 12px; }
        .tpl-audio-btn {
            width: 32px; height: 32px; border-radius: 50%; border: none; flex-shrink: 0;
            background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff;
            font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .tpl-audio-bar { flex: 1; height: 4px; background: var(--card-border); border-radius: 2px; position: relative; }
        .tpl-audio-bar::after { content: ''; position: absolute; left: 0; top: 0; width: 30%; height: 100%; background: rgba(108,92,231,0.4); border-radius: 2px; }
        .tpl-audio-time { font-size: 11px; color: var(--text-muted); white-space: nowrap; }
        .tpl-actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .tpl-select-btn {
            padding: 10px 24px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff;
            font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.3s; box-shadow: 0 4px 16px rgba(108,92,231,0.25);
        }
        .tpl-select-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(108,92,231,0.4); }
        .tpl-link { color: #6c5ce7; font-size: 13px; font-weight: 600; cursor: pointer; text-decoration: none; transition: opacity 0.2s; }
        .tpl-link:hover { opacity: 0.8; }
        .tpl-card-create { align-items: center; justify-content: center; text-align: center; cursor: pointer; border: 2px dashed var(--card-border); background: transparent; min-height: 220px; }
        .tpl-card-create:hover { border-color: rgba(108,92,231,0.5); background: rgba(108,92,231,0.04); }
        .tpl-create-icon { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #6c5ce7, #a855f7); color: #fff; font-size: 28px; font-weight: 300; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
        .tpl-card-custom-actions { display: flex; gap: 8px; margin-top: auto; flex-wrap: wrap; }
        .tpl-delete-btn { padding: 8px 16px; border-radius: 10px; border: 1px solid var(--card-border); background: transparent; color: var(--text-muted); font-family: inherit; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .tpl-delete-btn:hover { border-color: #e74c3c; color: #e74c3c; }
        .tpl-edit-btn { padding: 8px 16px; border-radius: 10px; border: 1px solid var(--card-border); background: transparent; color: var(--text-muted); font-family: inherit; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .tpl-edit-btn:hover { border-color: rgba(108,92,231,0.5); color: #6c5ce7; }
        #customTplCards { display: contents; }

    </style>
</head>
<body>
    <!-- ===== LANDING ===== -->
    <div id="landingPage">
        <div class="bg">
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
        </div>

        <!-- Top bar -->
        <div class="land-topbar">
            <div class="land-logo">
                <div class="land-logo-icon">
                    <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 00-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7a6.99 6.99 0 01-4.95-2.05l-1.41 1.41A8.96 8.96 0 0013 21a9 9 0 000-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                </div>
                AI Sales
            </div>
            <div class="land-topbar-right">
                <nav class="land-nav">
                    <a href="#about" data-i18n="about"> </a>
                    <a href="#tech" data-i18n="tech"></a>
                    <a href="#contacts" data-i18n="contacts"></a>
                </nav>
                <button class="lang-btn" onclick="switchLang()" id="landLangBtn">EN</button>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <svg class="icon-moon" viewBox="0 0 24 24"><path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.39 5.39 0 01-4.4 2.26 5.4 5.4 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
                    <svg class="icon-sun" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>
                    <div class="toggle-track"><div class="toggle-thumb"></div></div>
                </div>
                <button class="reg-btn" onclick="openModal()">
                    <svg viewBox="0 0 24 24"><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/></svg>
                    <span data-i18n="login"></span>
                </button>
            </div>
        </div>

        <!-- Hero -->
        <div class="hero">
            <div class="hero-badge">
                <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                <span data-i18n="heroBadge">  </span>
            </div>
            <h1 data-i18n-html="heroTitle">   <br>  <br> <span>AI</span></h1>
            <button class="hero-cta" onclick="openAccessModal()">
                <span data-i18n="requestAccess"> </span>
                <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z"/></svg>
            </button>
        </div>

        <!-- Features -->
        <div class="section">
            <div class="section-label" data-i18n="featLabel"></div>
            <div class="section-title" data-i18n="featTitle"> </div>

            <div class="feat-grid">
                <div class="feat-card">
                    <div class="feat-icon">
                        <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
                    </div>
                    <h3 data-i18n="f1t">AI-</h3>
                    <p data-i18n="f1d">    .  24/7,  ,       .</p>
                </div>
                <div class="feat-card">
                    <div class="feat-icon ic-blue">
                        <svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 011 1V20a1 1 0 01-1 1A17 17 0 013 4a1 1 0 011-1h3.5a1 1 0 011 1c0 1.25.2 2.46.57 3.58a1 1 0 01-.24 1.01l-2.2 2.2z"/></svg>
                    </div>
                    <h3 data-i18n="f2t"> </h3>
                    <p data-i18n="f2d">     .</p>
                </div>
                <div class="feat-card">
                    <div class="feat-icon ic-green">
                        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    </div>
                    <h3 data-i18n="f3t">  </h3>
                    <p data-i18n="f3d">        </p>
                </div>
                <div class="feat-card">
                    <div class="feat-icon ic-orange">
                        <svg viewBox="0 0 24 24"><path d="M19.14 12.94a7.07 7.07 0 000-1.88l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96a7.04 7.04 0 00-1.62-.94l-.36-2.54a.48.48 0 00-.48-.41h-3.84a.48.48 0 00-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.48.48 0 00-.59.22L2.74 8.87a.48.48 0 00.12.61l2.03 1.58a7.07 7.07 0 000 1.88l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.04.7 1.62.94l.36 2.54c.05.24.26.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54a7.04 7.04 0 001.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.49-.12-.61l-2.03-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.61 3.61 0 0112 15.6z"/></svg>
                    </div>
                    <h3 data-i18n="f4t">CRM-</h3>
                    <p data-i18n="f4d">    CRM-.</p>
                </div>
                <div class="feat-card">
                    <div class="feat-icon ic-pink">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    </div>
                    <h3 data-i18n="f5t"> </h3>
                    <p data-i18n="f5d">       .</p>
                </div>
                <div class="feat-card">
                    <div class="feat-icon ic-cyan">
                        <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 00-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7a6.99 6.99 0 01-4.95-2.05l-1.41 1.41A8.96 8.96 0 0013 21a9 9 0 000-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                    </div>
                    <h3 data-i18n="f6t"> </h3>
                    <p data-i18n="f6d">   2-5 .</p>
                </div>
                <div class="feat-card">
                    <div class="feat-icon ic-green">
                        <svg viewBox="0 0 24 24"><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                    </div>
                    <h3 data-i18n="f7t"> </h3>
                    <p data-i18n="f7d"> ,          .</p>
                </div>
            </div>
        </div>

        <!-- How it works -->
        <div class="section" style="text-align:center;">
            <div class="section-label" data-i18n="stepsLabel"></div>
            <div class="section-title" style="text-align:center;" data-i18n="stepsTitle">  ?</div>
            <div class="section-desc" style="text-align:center; margin-left:auto; margin-right:auto;" data-i18n="stepsDesc">     4 </div>

            <div class="steps">
                <div class="step">
                    <div class="step-num">1</div>
                    <h4 data-i18n="s1t"></h4>
                    <p data-i18n="s1d">   30 </p>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <h4 data-i18n="s2t"> </h4>
                    <p data-i18n="s2d">   </p>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <h4 data-i18n="s3t"> </h4>
                    <p data-i18n="s3d">  </p>
                </div>
                <div class="step">
                    <div class="step-num">4</div>
                    <h4 data-i18n="s4t"> </h4>
                    <p data-i18n="s4d">AI   </p>
                </div>
            </div>
        </div>


        <div class="land-footer">AI Sales Platform &copy; 2026</div>
    </div>

    <!-- ===== ONBOARDING ===== -->
    <div id="onboarding">
        <div class="bg">
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
        </div>
        <div class="onb-container" style="position:relative;z-index:1;">
            <!-- Progress -->
            <div class="onb-progress">
                <div class="onb-step-dot active" id="dot1">1</div>
                <div class="onb-step-line" id="line1"></div>
                <div class="onb-step-dot" id="dot2">2</div>
                <div class="onb-step-line" id="line2"></div>
                <div class="onb-step-dot" id="dot3">3</div>
            </div>

            <!-- Step 1: Niche -->
            <div id="onbStep1">
                <div class="onb-title" data-i18n="onb1title">  </div>
                <div class="onb-subtitle" data-i18n="onb1sub">      </div>
                <div class="niche-grid">
                    <div class="niche-item" data-i18n="niche1" onclick="selectNiche(this)"></div>
                    <div class="niche-item" data-i18n="niche2" onclick="selectNiche(this)">   HR</div>
                    <div class="niche-item" data-i18n="niche3" onclick="selectNiche(this)">  -</div>
                    <div class="niche-item" data-i18n="niche4" onclick="selectNiche(this)"></div>
                    <div class="niche-item" data-i18n="niche5" onclick="selectNiche(this)"> </div>
                    <div class="niche-item" data-i18n="niche6" onclick="selectNiche(this)"> </div>
                    <div class="niche-item" data-i18n="niche7" onclick="selectNiche(this)"> </div>
                    <div class="niche-item" data-i18n="niche8" onclick="selectNiche(this)"> </div>
                    <div class="niche-item" data-i18n="niche9" onclick="selectNiche(this)"> </div>
                    <div class="niche-item" data-i18n="niche10" onclick="selectNiche(this)">B2B </div>
                    <div class="niche-item" data-i18n="niche11" onclick="selectNiche(this)"></div>
                    <div class="niche-item" data-i18n="niche12" onclick="selectNiche(this)"> </div>
                    <div class="niche-item" data-i18n="niche13" onclick="selectNiche(this)">  </div>
                    <div class="niche-item" data-i18n="niche14" onclick="selectNiche(this)">   </div>
                    <div class="niche-item" data-i18n="niche15" onclick="selectNiche(this)">-</div>
                    <div class="niche-item" data-i18n="niche16" onclick="selectNiche(this)"> </div>
                    <div class="niche-item" data-i18n="niche17" onclick="selectNiche(this)"></div>
                    <div class="niche-item" data-i18n="niche18" onclick="selectNiche(this)"> </div>
                </div>
                <div id="customNicheBox" style="display:none;margin-bottom:24px;">
                    <input type="text" id="customNicheInput" class="onb-textarea" style="min-height:auto;padding:14px 18px;" placeholder="   ..." data-i18n-ph="phNiche" oninput="checkCustomNiche()">
                </div>
                <button class="onb-btn" id="onbNext1" onclick="goToStep(2)">
                    <span data-i18n="next"></span>
                    <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z"/></svg>
                </button>
            </div>

            <!-- Step 2: Target audience -->
            <div id="onbStep2" style="display:none;">
                <div class="onb-title" data-i18n="onb2title"> </div>
                <div class="onb-subtitle" data-i18n="onb2sub">    </div>

                <div class="form-group" style="margin-bottom:24px;">
                    <label style="color:var(--text-secondary);font-size:14px;font-weight:600;margin-bottom:10px;" data-i18n="onb2sitesLabel">  3  10     </label>
                    <textarea id="onbSites" class="onb-textarea" placeholder=":&#10;competitor1.ru&#10;competitor2.com&#10;similar-company.ru" data-i18n-ph="phSites" oninput="checkStep2()"></textarea>
                    <div class="onb-hint" data-i18n="onb2hint">    </div>
                </div>

                <div class="form-group" style="margin-bottom:16px;">
                    <label style="color:var(--text-secondary);font-size:14px;font-weight:600;margin-bottom:10px;" data-i18n="onb2clientLabel">   </label>
                    <textarea id="onbClient" class="onb-textarea" placeholder=":   , 30-50 ,    ..." data-i18n-ph="phClient" oninput="checkStep2()" ondragover="event.preventDefault()" ondrop="dropTag(event)"></textarea>
                </div>

                <div class="tags-section">
                    <div class="tags-label" data-i18n="onb2tagsLabel">       :</div>
                    <div class="tags-list">
                        <span class="tag-chip" data-i18n="tag1" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag2" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"></span>
                        <span class="tag-chip" data-i18n="tag3" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)">B2B </span>
                        <span class="tag-chip" data-i18n="tag4" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag5" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag6" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag7" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag8" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)">25-35 </span>
                        <span class="tag-chip" data-i18n="tag9" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)">35-50 </span>
                        <span class="tag-chip" data-i18n="tag10" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)">50+ </span>
                        <span class="tag-chip" data-i18n="tag11" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag12" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag13" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag14" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag15" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                        <span class="tag-chip" data-i18n="tag16" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)">: </span>
                        <span class="tag-chip" data-i18n="tag17" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)">:  </span>
                        <span class="tag-chip" data-i18n="tag18" draggable="true" ondragstart="dragTag(event)" onclick="insertTag(this)"> </span>
                    </div>
                </div>

                <div style="display:flex;gap:12px;margin-top:36px;">
                    <button class="onb-btn active" onclick="goToStep(1)" style="background:var(--link-bg);color:var(--text-dim);box-shadow:none;cursor:pointer;" data-i18n="back">
                        
                    </button>
                    <button class="onb-btn" id="onbNext2" onclick="goToStep(3)" style="flex:1;">
                        <span data-i18n="next"></span>
                        <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z"/></svg>
                    </button>
                </div>
            </div>

            <!-- Step 3: About company -->
            <div id="onbStep3" style="display:none;">
                <div class="onb-title" data-i18n="onb3title">  </div>
                <div class="onb-subtitle" data-i18n="onb3sub">   AI          ,   </div>

                <div class="onb-fields">
                    <div class="onb-field">
                        <label class="onb-field-label" data-i18n="onb3name">  </label>
                        <input type="text" class="onb-input" id="onbCompanyName" placeholder=": " data-i18n-ph="phCompName">
                    </div>
                    <div class="onb-field">
                        <label class="onb-field-label" data-i18n="onb3loc">  </label>
                        <input type="text" class="onb-input" id="onbCompanyLocation" placeholder=": , " data-i18n-ph="phCompLoc">
                    </div>
                    <div class="onb-field">
                        <label class="onb-field-label" data-i18n="onb3site">  </label>
                        <input type="text" class="onb-input" id="onbCompanySite" placeholder=": company.ru" data-i18n-ph="phCompSite">
                    </div>
                    <div class="onb-field">
                        <label class="onb-field-label" data-i18n="onb3prod">   / </label>
                        <input type="text" class="onb-input" id="onbCompanyProduct" placeholder=":   " data-i18n-ph="phCompProd">
                    </div>
                    <div class="onb-field">
                        <label class="onb-field-label" data-i18n="onb3utp"> (  )</label>
                        <input type="text" class="onb-input" id="onbCompanyUtp" placeholder=":    30    " data-i18n-ph="phCompUtp">
                    </div>
                    <div class="onb-field">
                        <label class="onb-field-label" data-i18n="onb3info">,       </label>
                        <textarea class="onb-textarea" id="onbCompanyInfo" placeholder="      : , , ,  ,  ..." data-i18n-ph="phCompInfo" style="min-height:120px;"></textarea>
                    </div>
                </div>

                <div style="display:flex;gap:12px;margin-top:36px;">
                    <button class="onb-btn active" onclick="goToStep(2)" style="background:var(--link-bg);color:var(--text-dim);box-shadow:none;cursor:pointer;" data-i18n="back">
                        
                    </button>
                    <button class="onb-btn active" onclick="skipStep3()" style="background:var(--link-bg);color:var(--text-dim);box-shadow:none;cursor:pointer;" data-i18n="fillLater">
                         
                    </button>
                    <button class="onb-btn active" onclick="finishOnboarding()" style="flex:1;">
                        <span data-i18n="next"></span>
                        <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ACCESS MODAL ===== -->
    <div class="modal-overlay" id="accessModal" onclick="closeAccessOnOverlay(event)">
        <div class="modal">
            <button class="modal-close" onclick="closeAccessModal()">&times;</button>

            <div id="accessForm">
                <div class="modal-title" data-i18n="accessTitle"> </div>
                <div class="modal-subtitle" data-i18n="accessSub">      </div>

                <div class="form-group">
                    <label data-i18n="innLabel"> </label>
                    <input type="text" id="accInn" placeholder="10  12 " data-i18n-ph="phInn" oninput="checkAccessForm()" maxlength="12">
                    <div class="field-hint" id="hintInn"></div>
                </div>
                <div class="form-group">
                    <label data-i18n="fioLabel"></label>
                    <input type="text" id="accName" placeholder="  " data-i18n-ph="phFio" oninput="checkAccessForm()">
                    <div class="field-hint" id="hintName"></div>
                </div>
                <div class="form-group">
                    <label data-i18n="phoneLabel"> </label>
                    <input type="tel" id="accPhone" placeholder="+7 (999) 123-45-67" data-i18n-ph="phPhone" oninput="checkAccessForm()" maxlength="18">
                    <div class="field-hint" id="hintPhone"></div>
                </div>

                <button class="access-submit" id="accessSubmitBtn" onclick="submitAccess()" data-i18n="getAccess">
                     
                </button>
            </div>

            <div class="access-success" id="accessSuccess">
                <div class="access-success-icon">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                </div>
                <h3 data-i18n="accessOk"> !</h3>
                <p data-i18n-html="accessOkDesc">   <br>  15 </p>
            </div>
        </div>
    </div>

    <!-- ===== LOGIN MODAL ===== -->
    <div class="modal-overlay" id="modal" onclick="closeOnOverlay(event)">
        <div class="modal">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="loginForm">
                <div class="modal-title" data-i18n="loginTitle"></div>
                <div class="modal-subtitle" data-i18n="loginSub">   </div>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label data-i18n="loginLabel"></label>
                        <input type="text" id="loginUser" placeholder=" " data-i18n-ph="phLogin" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label data-i18n="passLabel"></label>
                        <input type="password" id="loginPass" placeholder=" " data-i18n-ph="phPass" required autocomplete="current-password">
                    </div>
                    <div class="error-msg" id="loginError" data-i18n="loginErr">   </div>
                    <button type="submit" class="submit-btn" data-i18n="loginBtn"></button>
                </form>
                <div class="divider" data-i18n="orText"></div>
                <button class="google-btn" onclick="handleGoogle()">
                    <svg viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09a7.12 7.12 0 010-4.17V7.07H2.18a11.99 11.99 0 000 9.86l3.66-2.84z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span data-i18n="googleBtn">  Google</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== CREATE DIALOG MODAL ===== -->
    <div class="modal-overlay" id="createDialogModal" onclick="if(event.target===this)closeCreateDialogModal()">
        <div class="modal" style="max-width:420px;">
            <button class="modal-close" onclick="closeCreateDialogModal()">&times;</button>
            <div class="modal-title" data-i18n="dlgCreateTitle"> </div>
            <div class="modal-subtitle" data-i18n="dlgCreateSub">    </div>
            <div class="form-group">
                <label data-i18n="dlgNameLabel"></label>
                <input type="text" id="newDialogName" placeholder=":  B2B" data-i18n-ph="phDlgName" maxlength="100">
            </div>
            <button class="submit-btn" onclick="createDialog()" data-i18n="dlgCreateBtn"></button>
            <button class="submit-btn" style="background:var(--btn-bg);color:var(--text-secondary);margin-top:8px;" onclick="closeCreateDialogModal()" data-i18n="dlgCancelBtn"></button>
        </div>
    </div>

    <!-- ===== DELETE DIALOG MODAL ===== -->
    <div class="modal-overlay" id="deleteDialogModal" onclick="if(event.target===this)closeDeleteDialogModal()">
        <div class="modal" style="max-width:400px;">
            <button class="modal-close" onclick="closeDeleteDialogModal()">&times;</button>
            <div class="modal-title" data-i18n="dlgDeleteTitle"> ?</div>
            <div class="modal-subtitle" data-i18n="dlgDeleteConfirm">   .     .</div>
            <button class="submit-btn" style="background:linear-gradient(135deg,#ef4444,#dc2626);" onclick="confirmDeleteDialog()" data-i18n="dlgDeleteBtn"></button>
            <button class="submit-btn" style="background:var(--btn-bg);color:var(--text-secondary);margin-top:8px;" onclick="closeDeleteDialogModal()" data-i18n="dlgCancelBtn"></button>
        </div>
    </div>

    <!-- ===== MANAGEMENT MODAL ===== -->
    <div class="modal-overlay" id="mgmtModal" onclick="if(event.target===this)closeMgmtModal()">
        <div class="modal" style="max-width:460px;">
            <button class="modal-close" onclick="closeMgmtModal()">&times;</button>
            <div class="modal-title" data-i18n="mgmtTitle"></div>
            <div class="modal-subtitle" id="mgmtDialogName"></div>

            <div class="mgmt-section">
                <div class="mgmt-section-title" data-i18n="mgmtSchedule"> </div>
                <div class="mgmt-days" id="mgmtDays"></div>
                <div class="mgmt-time-row">
                    <input type="time" class="mgmt-time-input" id="mgmtTimeFrom" value="09:00">
                    <span class="mgmt-time-sep" data-i18n="mgmtTo"></span>
                    <input type="time" class="mgmt-time-input" id="mgmtTimeTo" value="18:00">
                </div>
            </div>

            <div class="mgmt-section">
                <div class="mgmt-section-title" data-i18n="mgmtTz"> </div>
                <div class="mgmt-toggle-row">
                    <span class="mgmt-toggle-label" data-i18n="mgmtTzLabel">   </span>
                    <div class="dlg-toggle-track" id="mgmtTzToggle" onclick="mgmtToggleTz()">
                        <div class="dlg-toggle-thumb"></div>
                    </div>
                </div>
            </div>

            <div class="mgmt-section">
                <div class="mgmt-section-title" data-i18n="mgmtContactLimit">  .   </div>
                <input type="number" class="mgmt-number-input" id="mgmtContactLimit" min="1" max="10000" value="100">
            </div>

            <div class="mgmt-section">
                <div class="mgmt-section-title" data-i18n="mgmtMaxCallSec">.   ()</div>
                <input type="number" class="mgmt-number-input" id="mgmtMaxCallSec" min="10" max="7200" value="600">
            </div>

            <button class="submit-btn" onclick="saveMgmt()" data-i18n="mgmtSave"></button>
        </div>
    </div>

    <!-- ===== SETTINGS: AUDIENCE MODAL ===== -->
    <div class="modal-overlay" id="settingsAudienceModal" onclick="if(event.target===this)closeSettingsAudience()">
        <div class="modal" style="max-width:500px;">
            <button class="modal-close" onclick="closeSettingsAudience()">&times;</button>
            <div class="modal-title" data-i18n="setAudT"> </div>
            <div class="modal-subtitle" data-i18n="setAudModalSub">   </div>
            <div class="settings-modal-body">
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setAudNiche"></div>
                    <input type="text" class="mgmt-number-input" id="setAudNiche" readonly style="width:100%;cursor:default;">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setAudClient">  </div>
                    <textarea class="onb-textarea" id="setAudClient" data-i18n-ph="phClient" placeholder=":   , 30-50 ,    ..."></textarea>
                    <div class="tags-section" style="margin-top:10px;">
                        <div class="tags-label" data-i18n="setAudTags"> </div>
                        <div class="tags-list">
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag1"> </span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag2"></span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag3">B2B </span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag4"> </span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag5"> </span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag6"> </span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag7"> </span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag8">25-35 </span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag9">35-50 </span>
                            <span class="tag-chip" onclick="insertSettingsTag(this,'setAudClient')" data-i18n="tag10">50+ </span>
                        </div>
                    </div>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setAudSites">  ( 10,    )</div>
                    <textarea class="onb-textarea" id="setAudSites" data-i18n-ph="phSites" placeholder=":&#10;competitor1.ru&#10;competitor2.com"></textarea>
                </div>
            </div>
            <button class="submit-btn" onclick="saveSettingsAudience()" data-i18n="setAudSave"></button>
        </div>
    </div>

    <!-- ===== SETTINGS: COMPANY MODAL ===== -->
    <div class="modal-overlay" id="settingsCompanyModal" onclick="if(event.target===this)closeSettingsCompany()">
        <div class="modal" style="max-width:520px;">
            <button class="modal-close" onclick="closeSettingsCompany()">&times;</button>
            <div class="modal-title" data-i18n="setCompT"> </div>
            <div class="modal-subtitle" data-i18n="setCompModalSub">   </div>
            <div class="settings-modal-body">
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompName"> </div>
                    <input type="text" class="mgmt-number-input" id="setCompName" style="width:100%" data-i18n-ph="phCompName" placeholder=": ">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompLoc"></div>
                    <input type="text" class="mgmt-number-input" id="setCompLoc" style="width:100%" data-i18n-ph="phCompLoc" placeholder=": , ">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompSite"></div>
                    <input type="text" class="mgmt-number-input" id="setCompSite" style="width:100%" data-i18n-ph="phCompSite" placeholder=": company.ru">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompProd"> </div>
                    <input type="text" class="mgmt-number-input" id="setCompProd" style="width:100%" data-i18n-ph="phCompProd" placeholder=":   ">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompUtp"></div>
                    <input type="text" class="mgmt-number-input" id="setCompUtp" style="width:100%" data-i18n-ph="phCompUtp" placeholder=":    30    ">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompInfo"> </div>
                    <textarea class="onb-textarea" id="setCompInfo" data-i18n-ph="phCompInfo" placeholder="  ..." style="min-height:80px;"></textarea>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompInn"></div>
                    <input type="text" class="mgmt-number-input" id="setCompInn" style="width:100%" placeholder="0000000000">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompPerson"> </div>
                    <input type="text" class="mgmt-number-input" id="setCompPerson" style="width:100%" data-i18n-ph="setCompPersonPh" placeholder="  ">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompReq"></div>
                    <textarea class="onb-textarea" id="setCompReq" data-i18n-ph="setCompReqPh" placeholder="  ..." style="min-height:80px;"></textarea>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="setCompContract">   </div>
                    <a class="settings-download-link" onclick="downloadContract()">&#128196; <span data-i18n="setCompDownload"> </span></a>
                </div>
            </div>
            <button class="submit-btn" onclick="saveSettingsCompany()" data-i18n="setCompSave"></button>
        </div>
    </div>

    <!-- ===== CUSTOM TEMPLATE MODAL ===== -->
    <div class="modal-overlay" id="customTplModal" onclick="if(event.target===this)closeCustomTplModal()">
        <div class="modal" style="max-width:560px;">
            <button class="modal-close" onclick="closeCustomTplModal()">&times;</button>
            <div class="modal-title" data-i18n="tplCreateTitle">  </div>
            <div class="modal-subtitle" data-i18n="tplCreateSub">       </div>
            <div class="settings-modal-body">
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="tplFieldName"> </div>
                    <input type="text" class="mgmt-number-input" id="ctplName" style="width:100%" placeholder=":   ">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="tplFieldDesc"></div>
                    <input type="text" class="mgmt-number-input" id="ctplDesc" style="width:100%" placeholder="  ">
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="roleTitle"> </div>
                    <textarea class="onb-textarea" id="ctplRole" placeholder="  ..." style="min-height:80px;"></textarea>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="styleTitle"> </div>
                    <textarea class="onb-textarea" id="ctplStyle" placeholder="  ..." style="min-height:80px;"></textarea>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="rulesTitle"> </div>
                    <textarea class="onb-textarea" id="ctplRules" placeholder="    " style="min-height:70px;"></textarea>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="factsTitle">  </div>
                    <textarea class="onb-textarea" id="ctplFacts" placeholder="    " style="min-height:70px;"></textarea>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="critTitle">  </div>
                    <textarea class="onb-textarea" id="ctplCriteria" placeholder="    " style="min-height:70px;"></textarea>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="greetTitle"></div>
                    <textarea class="onb-textarea" id="ctplGreeting" placeholder=" " style="min-height:50px;"></textarea>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-section-title" data-i18n="planTitle"> </div>
                    <textarea class="onb-textarea" id="ctplPlan" placeholder="    " style="min-height:70px;"></textarea>
                </div>
            </div>
            <button class="submit-btn" id="ctplSaveBtn" onclick="saveCustomTpl()" data-i18n="tplSaveBtn"> </button>
            <button class="submit-btn" style="background:var(--btn-bg);color:var(--text-secondary);margin-top:8px;" onclick="closeCustomTplModal()" data-i18n="dlgCancelBtn"></button>
        </div>
    </div>

    <!-- ===== QUICK START WIZARD ===== -->
    <div class="qs-overlay" id="qsWizard" onclick="if(event.target===this)closeQsWizard()">
        <div class="qs-modal">
            <button class="modal-close" onclick="closeQsWizard()">&times;</button>
            <div class="qs-modal-title" data-i18n="qsTitle"> </div>
            <div class="qs-modal-sub" data-i18n="qsSub">        </div>

            <div class="qs-progress" id="qsProgress">
                <div class="qs-dot active" id="qsDot1">1</div><div class="qs-line" id="qsLine1"></div>
                <div class="qs-dot" id="qsDot2">2</div><div class="qs-line" id="qsLine2"></div>
                <div class="qs-dot" id="qsDot3">3</div><div class="qs-line" id="qsLine3"></div>
                <div class="qs-dot" id="qsDot4">4</div><div class="qs-line" id="qsLine4"></div>
                <div class="qs-dot" id="qsDot5">5</div><div class="qs-line" id="qsLine5"></div>
                <div class="qs-dot" id="qsDot6">6</div><div class="qs-line" id="qsLine6"></div>
                <div class="qs-dot" id="qsDot7">7</div>
            </div>

            <!-- Step 1: Offer -->
            <div class="qs-step active" id="qsStep1">
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsWhatSell">  ?</label>
                    <textarea class="qs-textarea" id="qsWhatSell" data-i18n-ph="phQsWhatSell" placeholder=": CRM-   "></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsWhoTarget">  ?</label>
                    <textarea class="qs-textarea" id="qsWhoTarget" data-i18n-ph="phQsWhoTarget" placeholder=":    ,  "></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsAdvantages"> </label>
                    <textarea class="qs-textarea" id="qsAdvantages" data-i18n-ph="phQsAdvantages" placeholder="      "></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsAfterCall">    ?</label>
                    <select class="qs-select" id="qsAfterCall" onchange="qsToggleAfterOther()">
                        <option value="meeting" data-i18n="qsAfterMeeting">  / </option>
                        <option value="request" data-i18n="qsAfterRequest"> </option>
                        <option value="kp" data-i18n="qsAfterKP"> </option>
                        <option value="other" data-i18n="qsAfterOther"></option>
                    </select>
                </div>
                <div class="qs-field" id="qsAfterOtherWrap" style="display:none">
                    <textarea class="qs-textarea" id="qsAfterOtherText" data-i18n-ph="phQsAfterOther" placeholder="     "></textarea>
                </div>
            </div>

            <!-- Step 2: How managers sell -->
            <div class="qs-step" id="qsStep2">
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsGreetings">  </label>
                    <textarea class="qs-textarea" id="qsGreetings" data-i18n-ph="phQsGreetings" placeholder="    (    )"></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsPitch">:  </label>
                    <textarea class="qs-textarea" id="qsPitch" data-i18n-ph="phQsPitch" placeholder="   (   )"></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsClosing">:   </label>
                    <textarea class="qs-textarea" id="qsClosing" data-i18n-ph="phQsClosing" placeholder="       "></textarea>
                </div>
            </div>

            <!-- Step 3: Call recordings -->
            <div class="qs-step" id="qsStep3">
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsRecordings">   ()</label>
                    <div class="qs-upload-area" id="qsUploadArea" onclick="document.getElementById('qsFileInput').click()">
                        <div style="font-size:28px;margin-bottom:8px;"></div>
                        <div data-i18n="qsDragDrop">      </div>
                        <div style="margin-top:4px;font-size:11px;color:var(--text-dim)" data-i18n="qsFileTypes">MP3, WAV, OGG   25  </div>
                    </div>
                    <input type="file" id="qsFileInput" multiple accept="audio/*" style="display:none" onchange="qsHandleFiles(this.files)">
                    <div class="qs-file-list" id="qsFileList"></div>
                </div>
            </div>

            <!-- Step 4: Product info -->
            <div class="qs-step" id="qsStep4">
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsProductLine">  / </label>
                    <textarea class="qs-textarea" id="qsProductLine" data-i18n-ph="phQsProductLine" placeholder=" , , "></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsMinConditions">  </label>
                    <textarea class="qs-textarea" id="qsMinConditions" data-i18n-ph="phQsMinConditions" placeholder=" , ,   .."></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsFactsFigures">    </label>
                    <textarea class="qs-textarea" id="qsFactsFigures" data-i18n-ph="phQsFactsFigures" placeholder=", , "></textarea>
                </div>
            </div>

            <!-- Step 5: Robot's task -->
            <div class="qs-step" id="qsStep5">
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsGoal"> </label>
                    <select class="qs-select" id="qsGoal" onchange="qsToggleGoalOther()">
                        <option value="meeting" data-i18n="qsGoalMeeting">  / </option>
                        <option value="qualify" data-i18n="qsGoalQualify"> </option>
                        <option value="sell" data-i18n="qsGoalSell">  / </option>
                        <option value="other" data-i18n="qsGoalOther"></option>
                    </select>
                </div>
                <div class="qs-field" id="qsGoalOtherWrap" style="display:none">
                    <textarea class="qs-textarea" id="qsGoalOtherText" data-i18n-ph="phQsGoalOther" placeholder="  "></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsCollectFields">    ?</label>
                    <textarea class="qs-textarea" id="qsCollectFields" data-i18n-ph="phQsCollectFields" placeholder=", , ,   .."></textarea>
                </div>
            </div>

            <!-- Step 6: Rules -->
            <div class="qs-step" id="qsStep6">
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsForbidden">  ?</label>
                    <textarea class="qs-textarea" id="qsForbidden" data-i18n-ph="phQsForbidden" placeholder=", ,    "></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsNoPromise">   ?</label>
                    <textarea class="qs-textarea" id="qsNoPromise" data-i18n-ph="phQsNoPromise" placeholder=", ,    "></textarea>
                </div>
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsTerms">   </label>
                    <textarea class="qs-textarea" id="qsTerms" data-i18n-ph="phQsTerms" placeholder="      "></textarea>
                </div>
            </div>

            <!-- Step 7: Dialog name -->
            <div class="qs-step" id="qsStep7">
                <div class="qs-field">
                    <label class="qs-label" data-i18n="qsDialogName">  ?</label>
                    <input type="text" class="qs-textarea" style="min-height:auto;padding:12px 14px;" id="qsDialogName" data-i18n-ph="phQsDialogName" placeholder=":  CRM  B2B" maxlength="100">
                </div>
            </div>

            <div class="qs-nav">
                <button class="qs-btn-skip" id="qsBtnSkip" onclick="qsGoToStep(qsCurrentStep+1)" style="display:none" data-i18n="qsSkip"></button>
                <div style="flex:1"></div>
                <button class="qs-btn-back" id="qsBtnBack" onclick="qsGoToStep(qsCurrentStep-1)" style="display:none" data-i18n="qsBack"></button>
                <button class="qs-btn-next" id="qsBtnNext" onclick="qsGoToStep(qsCurrentStep+1)" data-i18n="qsNext"></button>
            </div>
        </div>
    </div>

    <!-- ===== DASHBOARD ===== -->
    <div id="dashboard">
        <div class="bg">
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
        </div>

        <div class="dash-topbar">
            <div class="dash-logo" onclick="var ml=document.querySelector('a[data-page=&quot;pageMain&quot;]');if(ml)setActive(ml);">
                <div class="dash-logo-icon">S</div>
                <span data-i18n="dashboard"> </span>
            </div>
            <div class="dash-user">
                <span class="dash-user-name">test</span>
                <button class="dash-logout" onclick="handleLogout()" data-i18n="logout"></button>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <h3 data-i18n="menu"></h3>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="lang-btn" onclick="switchLang()" id="sidebarLangBtn">EN</button>
                    <div class="theme-toggle" onclick="toggleTheme()">
                        <svg class="icon-moon" viewBox="0 0 24 24"><path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.39 5.39 0 01-4.4 2.26 5.4 5.4 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
                        <svg class="icon-sun" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>
                        <div class="toggle-track"><div class="toggle-thumb"></div></div>
                    </div>
                </div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#" class="active" data-page="pageMain" onclick="setActive(this)">
                    <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span>
                    <span data-i18n="navMain"></span>
                </a></li>
                <li><a href="#" data-page="pageStats" onclick="setActive(this)">
                    <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg></span>
                    <span data-i18n="navStats"></span>
                </a></li>
                <li><a href="#" data-page="pageKnowledge" onclick="setActive(this)">
                    <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></span>
                    <span data-i18n="navKb"> </span>
                </a></li>
                <li><a href="#" data-page="pageCalls" onclick="setActive(this)">
                    <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2z"/></svg></span>
                    <span data-i18n="navCalls">-</span>
                </a></li>
                <li><a href="#" data-page="pageTemplates" onclick="setActive(this)">
                    <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></span>
                    <span data-i18n="navTemplates"></span>
                </a></li>
                <li><a href="#" data-page="pageSettings" onclick="setActive(this)">
                    <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M19.14 12.94a7.07 7.07 0 000-1.88l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96a7.04 7.04 0 00-1.62-.94l-.36-2.54a.48.48 0 00-.48-.41h-3.84a.48.48 0 00-.48.41l-.36 2.54a7.04 7.04 0 00-1.62.94l-2.39-.96a.48.48 0 00-.59.22L2.74 8.87a.48.48 0 00.12.61l2.03 1.58a7.07 7.07 0 000 1.88l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.04.7 1.62.94l.36 2.54c.05.24.26.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54a7.04 7.04 0 001.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 00-.12-.61l-2.03-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.6 3.6 0 0112 15.6z"/></svg></span>
                    <span data-i18n="navSettings"></span>
                </a></li>
            </ul>
        </div>

        <div class="dash-content">
            <!-- PAGE:  -->
            <div class="page-section active" id="pageMain">
                <!-- DIALOG LIST VIEW -->
                <div id="dialogListView">
                    <div class="dlg-list-header">
                        <h1 data-i18n="dlgListTitle"></h1>
                        <div class="dlg-list-actions">
                            <button class="dlg-btn-quickstart" onclick="quickStartDialog()">
                                <span>&#10022;</span>
                                <span data-i18n="dlgQuickStart"> </span>
                            </button>
                            <button class="dlg-btn-quickstart" onclick="openTemplatesModal()">
                                <span>&#9776;</span>
                                <span data-i18n="dlgTemplate"> </span>
                            </button>
                            <button class="dlg-btn-create" onclick="openCreateDialogModal()">
                                <span>+</span>
                                <span data-i18n="dlgCreate"> </span>
                            </button>
                        </div>
                    </div>
                    <div class="dlg-table-wrapper">
                        <table class="dlg-table">
                            <thead>
                                <tr>
                                    <th data-i18n="dlgColName"></th>
                                    <th data-i18n="dlgColStatus"></th>
                                    <th data-i18n="dlgColCreated"></th>
                                    <th data-i18n="dlgColUpdated"></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="dialogTableBody"></tbody>
                        </table>
                        <div class="dlg-empty" id="dlgEmpty" style="display:none;" data-i18n="dlgEmpty"> .  !</div>
                    </div>
                </div>

                <!-- DIALOG DETAIL VIEW -->
                <div id="dialogDetailView" style="display:none;">
                <button class="dlg-back-btn" onclick="showDialogList()">
                    <span>&#8592;</span>
                    <span data-i18n="dlgBack"></span>
                </button>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <div id="botHeaderRing"></div>
                        <div>
                            <div class="bot-header-title" id="botHeaderTitle">     </div>
                            <div class="dlg-status-hint" id="botHeaderStatus"></div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="dlg-toggle" id="botHeaderToggle"></div>
                        <span class="save-status saved" id="saveStatus" data-i18n="saved"></span>
                    </div>
                </div>
                <div class="bot-header-updated" id="lastUpdated" data-i18n="botUpdated"> :  </div>

                <div class="bot-tabs" id="botTabs">
                    <button class="bot-tab active" onclick="switchBotTab('context',this)" data-i18n="tabContext"></button>
                    <button class="bot-tab" onclick="switchBotTab('plan',this)" data-i18n="tabPlan"> </button>
                    <button class="bot-tab" onclick="switchBotTab('knowledge',this)" data-i18n="tabKb"> </button>
                </div>

                <!-- Tab:  -->
                <div class="bot-tab-content active" id="tabContext">
                    <div class="bot-card">
                        <div class="bot-card-title" data-i18n="roleTitle"> </div>
                        <div class="bot-card-desc" data-i18n="roleDesc"> ,        </div>
                        <textarea class="bot-textarea" id="botSellerRole" placeholder=" " data-i18n-ph="phRole" maxlength="500" oninput="onBotInput(this,'roleCount')"></textarea>
                        <div class="bot-char-count" id="roleCount">0/500</div>
                    </div>
                    <div class="bot-card">
                        <div class="bot-card-title" data-i18n="styleTitle"> </div>
                        <div class="bot-card-desc" data-i18n="styleDesc">      </div>
                        <textarea class="bot-textarea" id="botSpeechStyle" placeholder=" " data-i18n-ph="phStyle" maxlength="500" oninput="onBotInput(this,'styleCount')"></textarea>
                        <div class="bot-char-count" id="styleCount">0/500</div>
                    </div>
                    <div class="bot-card">
                        <div class="bot-card-title" data-i18n="rulesTitle"> </div>
                        <div class="bot-card-desc" data-i18n="rulesDesc"> ,       </div>
                        <div id="rulesList"></div>
                        <button class="add-rule-btn" onclick="addRule()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            <span data-i18n="addRule">  </span>
                        </button>
                    </div>
                    <div class="bot-card">
                        <div class="bot-card-title" data-i18n="factsTitle">  </div>
                        <div class="bot-card-desc" data-i18n="factsDesc">    ,      </div>
                        <div id="factsList"></div>
                        <button class="add-rule-btn" onclick="addFact()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            <span data-i18n="addFact">  </span>
                        </button>
                    </div>
                    <div class="bot-card">
                        <div class="bot-card-title" data-i18n="critTitle">  </div>
                        <div class="bot-card-desc" data-i18n="critDesc"> ,      </div>
                        <div id="criteriaList"></div>
                        <button class="add-rule-btn" onclick="addCriterion()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            <span data-i18n="addCrit">  </span>
                        </button>
                    </div>
                </div>

                <!-- Tab:   -->
                <div class="bot-tab-content" id="tabPlan">
                    <div class="bot-card">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                            <div>
                                <div class="bot-card-title" data-i18n="greetTitle"> </div>
                                <div class="bot-card-desc" data-i18n="greetDesc"> ,       </div>
                            </div>
                            <div class="important-badge">
                                <span data-i18n="important">!</span>
                                <span class="info-icon" tabindex="0">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                    <span class="info-tooltip" data-i18n="greetTooltip">             </span>
                                </span>
                            </div>
                        </div>
                        <div id="greetingsList"></div>
                        <button class="add-rule-btn" id="addGreetingBtn" onclick="addGreeting()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            <span data-i18n="addGreeting">   ( 5)</span>
                        </button>
                    </div>
                    <div class="bot-card">
                        <div class="bot-card-title" data-i18n="planTitle"> </div>
                        <div class="bot-card-desc" data-i18n="planDesc">  ,       </div>
                        <div id="planItemsList"></div>
                        <button class="add-rule-btn" onclick="addPlanItem()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            <span data-i18n="addPlan">  </span>
                        </button>
                    </div>
                </div>
                <!-- Tab:   -->
                <div class="bot-tab-content" id="tabKnowledge">
                    <div class="stub-content" data-i18n="stub">  </div>
                </div>
                </div><!-- /dialogDetailView -->
            </div>

            <!-- PAGE:  -->
            <div class="page-section" id="pageStats">
                <div class="st-wrap">
                    <!-- HEADER -->
                    <div class="st-header">
                      <div>
                        <h2></h2>
                      </div>
                      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                        <div class="st-tabs">
                          <button class="st-tab active" onclick="stSwitchTab(this,'overview')"></button>
                        </div>
                        <!-- DIALOG PICKER -->
                        <div class="st-dlg-picker">
                          <button class="st-dlg-btn" id="st-dlg-btn" onclick="stToggleDlgPicker()">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            <span id="st-dlg-label" data-i18n="stDlgAll"> </span>
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                          </button>
                          <div class="st-dlg-dropdown" id="st-dlg-dropdown"></div>
                        </div>
                        <!-- DATE PICKER -->
                        <div class="st-datepicker-wrap">
                          <button class="st-datepicker-btn" onclick="stToggleCalendar()">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            <span id="st-date-label"></span>
                          </button>
                          <div class="st-calendar-popup" id="st-calendar-popup">
                            <div style="width:100%">
                              <div style="display:flex;gap:24px;flex-wrap:wrap">
                                <div class="st-cal-section" id="st-cal-left"></div>
                                <div class="st-cal-section" id="st-cal-right"></div>
                              </div>
                              <div class="st-cal-presets">
                                <button class="st-preset-btn" onclick="stSetPreset(1)"></button>
                                <button class="st-preset-btn" onclick="stSetPreset(7)">7 </button>
                                <button class="st-preset-btn" onclick="stSetPreset(14)">14 </button>
                                <button class="st-preset-btn" onclick="stSetPreset(30)">30 </button>
                                <button class="st-preset-btn" onclick="stSetPreset(0,'month')"> </button>
                              </div>
                              <button class="st-cal-apply" onclick="stApplyDate()"></button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- STATS CARDS -->
                    <div class="st-stats-grid" id="st-stats-grid"></div>

                    <!-- CALLS SECTION -->
                    <div class="st-calls-section">
                      <div class="st-calls-header">
                        <div class="st-calls-title"> </div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.7)">: <span id="st-count-shown">20</span>  <span id="st-count-total">84</span></div>
                      </div>

                      <div class="st-filters-row">
                        <input class="st-search-input" type="text" placeholder="    ..." oninput="stApplyFilters()">
                        <select class="st-filter-select" id="st-f-status" onchange="stApplyFilters()">
                          <option value=""> </option>
                          <option value="success"></option>
                          <option value="fail"></option>
                          <option value="noanswer"> </option>
                          <option value="busy"></option>
                        </select>
                        <select class="st-filter-select" id="st-f-lead" onchange="stApplyFilters()">
                          <option value=""> </option>
                          <option value="yes"> </option>
                          <option value="no"> </option>
                        </select>
                        <select class="st-filter-select" id="st-f-dur" onchange="stApplyFilters()">
                          <option value=""></option>
                          <option value="short">< 1 </option>
                          <option value="mid">13 </option>
                          <option value="long">> 3 </option>
                        </select>
                        <select class="st-filter-select" id="st-f-mp" onchange="stApplyFilters()">
                          <option value=""></option>
                          <option value="wb">Wildberries</option>
                          <option value="ozon">Ozon</option>
                          <option value="ym"> </option>
                        </select>
                      </div>

                      <div class="st-col-labels">
                        <div>#</div>
                        <div></div>
                        <div></div>
                        <div>.</div>
                        <div></div>
                        <div></div>
                        <div>  </div>
                        <div></div>
                      </div>

                      <div class="st-calls-scroll" id="st-calls-list">
                        <!-- Generated by JS -->
                      </div>
                    </div>
                </div>
            </div>

            <!-- PAGE:  -->
            <div class="page-section" id="pageSkills">
                <h1 data-i18n="pSkillsT"></h1>
                <p class="subtitle" data-i18n="pSkillsSub">    </p>
                <div class="skill-grid">
                    <div class="skill-card">
                        <div class="skill-card-icon" style="background:rgba(108,92,231,0.12);color:#a78bfa;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
                        </div>
                        <h3 data-i18n="sk1t"> B2B</h3>
                        <p data-i18n="sk1d">     </p>
                        <span class="skill-card-tag tag-active" data-i18n="skActive"></span>
                    </div>
                    <div class="skill-card">
                        <div class="skill-card-icon" style="background:rgba(56,189,248,0.12);color:#38bdf8;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.22C21 6.73 16.74 3 12 3c-4.69 0-9 3.65-9 9.28-.6.34-1 .98-1 1.72v2c0 1.1.9 2 2 2h1v-6.1c0-3.87 3.13-7 7-7s7 3.13 7 7V19h-8v2h8c1.1 0 2-.9 2-2v-1.22c.59-.31 1-.92 1-1.64v-2.3c0-.7-.41-1.31-1-1.62z"/></svg>
                        </div>
                        <h3 data-i18n="sk2t"> L1</h3>
                        <p data-i18n="sk2d">    </p>
                        <span class="skill-card-tag tag-active" data-i18n="skActive"></span>
                    </div>
                    <div class="skill-card">
                        <div class="skill-card-icon" style="background:rgba(251,191,36,0.12);color:#fbbf24;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                        </div>
                        <h3 data-i18n="sk3t"></h3>
                        <p data-i18n="sk3d">    </p>
                        <span class="skill-card-tag tag-draft" data-i18n="skDraft"></span>
                    </div>
                    <div class="skill-card">
                        <div class="skill-card-icon" style="background:rgba(52,211,153,0.12);color:#34d399;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                        </div>
                        <h3 data-i18n="sk4t"> NPS</h3>
                        <p data-i18n="sk4d">    </p>
                        <span class="skill-card-tag tag-new" data-i18n="skNew"></span>
                    </div>
                </div>
            </div>

            <!-- PAGE:   -->
            <div class="page-section" id="pageKnowledge">
                <h1 data-i18n="pKbT"> </h1>
                <p class="subtitle" data-i18n="pKbSub">  </p>
                <div class="stub-content" data-i18n="stub">  </div>
            </div>

            <!-- PAGE: - -->
            <div class="page-section" id="pageCalls">
                <h1 data-i18n="pCallsT">-</h1>
                <p class="subtitle" data-i18n="pCallsSub">   </p>
                <div class="stub-content" data-i18n="stub">  </div>
            </div>

            <!-- PAGE:   -->
            <div class="page-section" id="pageHistory">
                <h1 data-i18n="pHistT"> </h1>
                <p class="subtitle" data-i18n="pHistSub">  </p>
                <div class="stub-content" data-i18n="stub">  </div>
            </div>

            <!-- PAGE:  -->
            <div class="page-section" id="pageTemplates">
                <h1 data-i18n="pTplT"></h1>
                <p class="subtitle" data-i18n="pTplSub">   </p>
                <div class="tpl-cards">
                    <!--  1 -->
                    <div class="tpl-card">
                        <div class="tpl-card-title" data-i18n="tpl1t">    </div>
                        <div class="tpl-card-desc" data-i18n="tpl1d">     .    ,         .</div>
                        <div class="tpl-audio">
                            <button class="tpl-audio-btn" title="Play">&#9654;</button>
                            <div class="tpl-audio-bar"></div>
                            <span class="tpl-audio-time">0:00 / 1:24</span>
                        </div>
                        <div class="tpl-actions">
                            <button class="tpl-select-btn" onclick="applyTemplate(1)" data-i18n="tplSelect"></button>
                            <a class="tpl-link" onclick="applyTemplate(1)" data-i18n="tplReview">  </a>
                        </div>
                    </div>
                    <!--  2 -->
                    <div class="tpl-card">
                        <div class="tpl-card-title" data-i18n="tpl2t">   </div>
                        <div class="tpl-card-desc" data-i18n="tpl2d">     .  ,  ,    .</div>
                        <div class="tpl-audio">
                            <button class="tpl-audio-btn" title="Play">&#9654;</button>
                            <div class="tpl-audio-bar"></div>
                            <span class="tpl-audio-time">0:00 / 1:12</span>
                        </div>
                        <div class="tpl-actions">
                            <button class="tpl-select-btn" onclick="applyTemplate(2)" data-i18n="tplSelect"></button>
                            <a class="tpl-link" onclick="applyTemplate(2)" data-i18n="tplReview">  </a>
                        </div>
                    </div>
                    <!--  3 -->
                    <div class="tpl-card">
                        <div class="tpl-card-title" data-i18n="tpl3t">   </div>
                        <div class="tpl-card-desc" data-i18n="tpl3d">       .   ,    .</div>
                        <div class="tpl-audio">
                            <button class="tpl-audio-btn" title="Play">&#9654;</button>
                            <div class="tpl-audio-bar"></div>
                            <span class="tpl-audio-time">0:00 / 1:36</span>
                        </div>
                        <div class="tpl-actions">
                            <button class="tpl-select-btn" onclick="applyTemplate(3)" data-i18n="tplSelect"></button>
                            <a class="tpl-link" onclick="applyTemplate(3)" data-i18n="tplReview">  </a>
                        </div>
                    </div>
                    <!-- Custom templates rendered here -->
                    <div id="customTplCards"></div>
                    <!-- Create your own -->
                    <div class="tpl-card tpl-card-create" onclick="openCustomTplModal()">
                        <div class="tpl-create-icon">+</div>
                        <div class="tpl-card-title" data-i18n="tplCreateTitle">  </div>
                        <div class="tpl-card-desc" data-i18n="tplCreateDesc"> ,  ,       </div>
                    </div>
                </div>
            </div>

            <!-- PAGE:  -->
            <div class="page-section" id="pageSettings">
                <h1 data-i18n="pSetT"></h1>
                <p class="subtitle" data-i18n="pSetSub"> </p>
                <div class="settings-cards">
                    <!-- Card 1: Target Audience -->
                    <div class="settings-card">
                        <div class="settings-card-title" data-i18n="setAudT"> </div>
                        <div class="settings-card-desc" data-i18n="setAudD">    ,   </div>
                        <button class="settings-card-btn" onclick="openSettingsAudience()" data-i18n="setBtn"></button>
                    </div>
                    <!-- Card 2: Company -->
                    <div class="settings-card">
                        <div class="settings-card-title" data-i18n="setCompT"> </div>
                        <div class="settings-card-desc" data-i18n="setCompD">  ,   </div>
                        <button class="settings-card-btn" onclick="openSettingsCompany()" data-i18n="setBtn"></button>
                    </div>
                    <!-- Card 3: Tariff & Balance -->
                    <div class="settings-card">
                        <div class="settings-card-title" data-i18n="setTarT">  </div>
                        <div class="settings-card-desc" data-i18n="setTarD">     </div>
                        <div class="settings-info-row">
                            <span class="settings-info-label" data-i18n="setTarPlan"> </span>
                            <span class="settings-info-value" id="settingsTariffName"></span>
                        </div>
                        <div class="settings-info-row">
                            <span class="settings-info-label" data-i18n="setTarBal"></span>
                            <span class="settings-info-value" id="settingsBalance">0 </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tts-toast" id="ttsToast"></div>

    <!-- Shared context menu (outside overflow containers) -->
    <div class="dlg-context-menu" id="dlgContextMenu"></div>

    <script>
        const modal = document.getElementById('modal');
        const landingPage = document.getElementById('landingPage');
        const dashboard = document.getElementById('dashboard');

        // ===== DIALOG LIST STATE =====
        var dialogs = [], dialogIdCounter = 0, currentDialogId = null, deleteTargetId = null;

        function openModal() {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('loginUser').classList.remove('error');
            document.getElementById('loginPass').classList.remove('error');
        }

        function closeModal() {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function closeOnOverlay(e) {
            if (e.target === modal) closeModal();
        }

        const onboarding = document.getElementById('onboarding');

        function showAfterLogin() {
            closeModal();
            landingPage.classList.add('hidden');
            const onboarded = localStorage.getItem('onboarded');
            if (onboarded) {
                setTimeout(() => { dashboard.classList.add('show'); document.body.style.overflow = ''; }, 400);
            } else {
                setTimeout(() => { onboarding.classList.add('show'); document.body.style.overflow = ''; }, 400);
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('loginUser');
            const pass = document.getElementById('loginPass');
            const error = document.getElementById('loginError');
            if (user.value === 'test' && pass.value === '1234') {
                showAfterLogin();
            } else {
                user.classList.add('error');
                pass.classList.add('error');
                error.classList.add('show');
                setTimeout(() => { user.classList.remove('error'); pass.classList.remove('error'); }, 1500);
            }
        }

        function handleGoogle() {
            showAfterLogin();
        }

        // Onboarding
        let selectedNiche = null;
        var settingsAudienceData = { niche: '', client: '', sites: '' };
        var settingsCompanyData = { name: '', location: '', site: '', product: '', utp: '', info: '', inn: '', person: '', requisites: '' };

        function selectNiche(el) {
            document.querySelectorAll('.niche-item').forEach(n => n.classList.remove('selected'));
            el.classList.add('selected');
            var box = document.getElementById('customNicheBox');
            var btn = document.getElementById('onbNext1');
            if (el.getAttribute('data-i18n') === 'niche18') {
                box.style.display = '';
                document.getElementById('customNicheInput').focus();
                selectedNiche = null;
                btn.classList.remove('active');
                checkCustomNiche();
            } else {
                box.style.display = 'none';
                document.getElementById('customNicheInput').value = '';
                selectedNiche = el.textContent;
                btn.classList.add('active');
            }
        }

        function checkCustomNiche() {
            var val = document.getElementById('customNicheInput').value.trim();
            var btn = document.getElementById('onbNext1');
            if (val.length > 0) {
                selectedNiche = val;
                btn.classList.add('active');
            } else {
                selectedNiche = null;
                btn.classList.remove('active');
            }
        }

        function goToStep(step) {
            if (step === 2 && !selectedNiche) return;
            if (step === 3) {
                var s = document.getElementById('onbSites').value.trim();
                var c = document.getElementById('onbClient').value.trim();
                if (!s || !c) return;
            }
            // Show/hide steps
            document.getElementById('onbStep1').style.display = step === 1 ? '' : 'none';
            document.getElementById('onbStep2').style.display = step === 2 ? '' : 'none';
            document.getElementById('onbStep3').style.display = step === 3 ? '' : 'none';
            // Update dots
            var dot1 = document.getElementById('dot1');
            var dot2 = document.getElementById('dot2');
            var dot3 = document.getElementById('dot3');
            var line1 = document.getElementById('line1');
            var line2 = document.getElementById('line2');
            if (step === 1) {
                dot1.className = 'onb-step-dot active';
                dot2.className = 'onb-step-dot';
                dot3.className = 'onb-step-dot';
                line1.className = 'onb-step-line';
                line2.className = 'onb-step-line';
            } else if (step === 2) {
                dot1.className = 'onb-step-dot done';
                dot2.className = 'onb-step-dot active';
                dot3.className = 'onb-step-dot';
                line1.className = 'onb-step-line done';
                line2.className = 'onb-step-line';
            } else if (step === 3) {
                dot1.className = 'onb-step-dot done';
                dot2.className = 'onb-step-dot done';
                dot3.className = 'onb-step-dot active';
                line1.className = 'onb-step-line done';
                line2.className = 'onb-step-line done';
            }
        }

        function finishOnboarding() {
            // Save onboarding data to settings globals
            settingsAudienceData.niche = selectedNiche || '';
            settingsAudienceData.client = document.getElementById('onbClient').value || '';
            settingsAudienceData.sites = document.getElementById('onbSites').value || '';
            settingsCompanyData.name = document.getElementById('onbCompanyName').value || '';
            settingsCompanyData.location = document.getElementById('onbCompanyLocation').value || '';
            settingsCompanyData.site = document.getElementById('onbCompanySite').value || '';
            settingsCompanyData.product = document.getElementById('onbCompanyProduct').value || '';
            settingsCompanyData.utp = document.getElementById('onbCompanyUtp').value || '';
            settingsCompanyData.info = document.getElementById('onbCompanyInfo').value || '';
            localStorage.setItem('onboarded', '1');
            onboarding.classList.remove('show');
            dashboard.classList.add('show');
        }

        function skipStep3() {
            finishOnboarding();
        }

        function checkStep2() {
            var sites = document.getElementById('onbSites').value.trim();
            var client = document.getElementById('onbClient').value.trim();
            var btn = document.getElementById('onbNext2');
            if (sites.length > 0 && client.length > 0) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        function dragTag(e) {
            e.dataTransfer.setData('text/plain', e.target.textContent);
        }

        function insertTag(el) {
            var ta = document.getElementById('onbClient');
            var text = el.textContent;
            var start = ta.selectionStart;
            var end = ta.selectionEnd;
            var val = ta.value;
            var before = val.substring(0, start);
            var after = val.substring(end);
            var sep = before.length > 0 && !before.endsWith(' ') && !before.endsWith('\n') ? ', ' : '';
            ta.value = before + sep + text + after;
            ta.focus();
            var pos = (before + sep + text).length;
            ta.setSelectionRange(pos, pos);
            el.classList.add('used');
            checkStep2();
        }

        function dropTag(e) {
            e.preventDefault();
            var text = e.dataTransfer.getData('text/plain');
            var ta = document.getElementById('onbClient');
            var val = ta.value;
            var sep = val.length > 0 && !val.endsWith(' ') && !val.endsWith('\n') ? ', ' : '';
            ta.value = val + sep + text;
            // Mark the tag chip as used
            document.querySelectorAll('.tag-chip').forEach(function(ch) {
                if (ch.textContent === text) ch.classList.add('used');
            });
            checkStep2();
        }

        // ===== SETTINGS PAGE =====
        function openSettingsAudience() {
            var niche = settingsAudienceData.niche || selectedNiche || '';
            var client = settingsAudienceData.client || document.getElementById('onbClient').value || '';
            var sites = settingsAudienceData.sites || document.getElementById('onbSites').value || '';
            document.getElementById('setAudNiche').value = niche;
            document.getElementById('setAudClient').value = client;
            document.getElementById('setAudSites').value = sites;
            // Reset tag chips
            document.querySelectorAll('#settingsAudienceModal .tag-chip').forEach(function(c) { c.classList.remove('used'); });
            document.getElementById('settingsAudienceModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeSettingsAudience() {
            document.getElementById('settingsAudienceModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        function saveSettingsAudience() {
            var sitesVal = document.getElementById('setAudSites').value.trim();
            var lines = sitesVal.split('\n').filter(function(l) { return l.trim().length > 0; });
            if (lines.length > 10) {
                alert(t('setAudMaxSites'));
                return;
            }
            settingsAudienceData.niche = document.getElementById('setAudNiche').value;
            settingsAudienceData.client = document.getElementById('setAudClient').value;
            settingsAudienceData.sites = sitesVal;
            closeSettingsAudience();
        }

        function insertSettingsTag(el, targetId) {
            var ta = document.getElementById(targetId);
            var text = el.textContent;
            var val = ta.value;
            var sep = val.length > 0 && !val.endsWith(' ') && !val.endsWith('\n') ? ', ' : '';
            ta.value = val + sep + text;
            ta.focus();
            el.classList.add('used');
        }

        function openSettingsCompany() {
            var d = settingsCompanyData;
            document.getElementById('setCompName').value = d.name || document.getElementById('onbCompanyName').value || '';
            document.getElementById('setCompLoc').value = d.location || document.getElementById('onbCompanyLocation').value || '';
            document.getElementById('setCompSite').value = d.site || document.getElementById('onbCompanySite').value || '';
            document.getElementById('setCompProd').value = d.product || document.getElementById('onbCompanyProduct').value || '';
            document.getElementById('setCompUtp').value = d.utp || document.getElementById('onbCompanyUtp').value || '';
            document.getElementById('setCompInfo').value = d.info || document.getElementById('onbCompanyInfo').value || '';
            document.getElementById('setCompInn').value = d.inn || '';
            document.getElementById('setCompPerson').value = d.person || '';
            document.getElementById('setCompReq').value = d.requisites || '';
            document.getElementById('settingsCompanyModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeSettingsCompany() {
            document.getElementById('settingsCompanyModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        function saveSettingsCompany() {
            settingsCompanyData.name = document.getElementById('setCompName').value;
            settingsCompanyData.location = document.getElementById('setCompLoc').value;
            settingsCompanyData.site = document.getElementById('setCompSite').value;
            settingsCompanyData.product = document.getElementById('setCompProd').value;
            settingsCompanyData.utp = document.getElementById('setCompUtp').value;
            settingsCompanyData.info = document.getElementById('setCompInfo').value;
            settingsCompanyData.inn = document.getElementById('setCompInn').value;
            settingsCompanyData.person = document.getElementById('setCompPerson').value;
            settingsCompanyData.requisites = document.getElementById('setCompReq').value;
            closeSettingsCompany();
        }

        function downloadContract() {
            alert(currentLang === 'ru' ? '       ' : 'Contract will be available for download soon');
        }

        function handleLogout() {
            dashboard.classList.remove('show');
            localStorage.removeItem('onboarded');
            setTimeout(() => {
                landingPage.classList.remove('hidden');
                document.getElementById('loginUser').value = '';
                document.getElementById('loginPass').value = '';
                window.scrollTo(0, 0);
            }, 100);
        }

        // ===== DIALOG LIST CRUD =====
        function createDialogObject(name) {
            dialogIdCounter++;
            var now = new Date().toISOString();
            return {
                id: 'dlg_' + dialogIdCounter,
                name: name,
                createdAt: now,
                updatedAt: now,
                active: false,
                botRole: '',
                botStyle: '',
                rules: [],
                facts: [],
                criteria: [],
                greetings: [],
                planItems: [],
                schedule: { days: [1,2,3,4,5], timeFrom: '09:00', timeTo: '18:00' },
                useClientTz: false,
                contactLimit: 100,
                maxCallSec: 600
            };
        }

        // ===== APPLY TEMPLATE =====
        function applyTemplate(templateId) {
            var companyName = (settingsCompanyData && settingsCompanyData.name) || ' ';
            var companyProduct = (settingsCompanyData && settingsCompanyData.product) || ' ';
            var dlg;

            if (templateId === 1) {
                //  1:     
                dlg = createDialogObject('  ');

                dlg.botRole = '  ,      ' + companyName + '.           .     -,    .   ' + companyProduct + '.    ,           .';

                dlg.botStyle = ' ,    .  ,  .  ,  .\n ,          ,       .\n  , ,  .   .  .     , ,   .\n  ,     .\n  , ,  .\n   .\n  , , . .';

                dlg.rules = [
                    { id: 'rule_1', text: ' .       .' },
                    { id: 'rule_2', text: '     .' },
                    { id: 'rule_3', text: '   ,     .' }
                ];

                dlg.facts = [
                    { id: 'fact_1', text: '           .' },
                    { id: 'fact_2', text: '   1520        .' },
                    { id: 'fact_3', text: '       .' }
                ];

                dlg.criteria = [
                    { id: 'crit_1', text: '      .' },
                    { id: 'crit_2', text: '     .' },
                    { id: 'crit_3', text: '    .' }
                ];

                dlg.greetings = [
                    { id: 'greet_1', text: '!   ,    ' + companyName + '. ,      ?' }
                ];

                dlg.planItems = [
                    { id: 'plan_1', text: '    ' },
                    { id: 'plan_2', text: '       ' },
                    { id: 'plan_3', text: '-     ' },
                    { id: 'plan_4', text: '    ' },
                    { id: 'plan_5', text: '    ' },
                    { id: 'plan_6', text: '   ' },
                    { id: 'plan_7', text: '   ' }
                ];

            } else if (templateId === 2) {
                //  2:    
                dlg = createDialogObject('  ');

                dlg.botRole = '  ,       ' + companyName + '.        , ,      .   , -,  .   ' + companyProduct + '.       ,   ,     .';

                dlg.botStyle = '  , , .     .\n .    .     .\n ,      .   .\n ,  ,  .\n    .\n  .\n      ,     .';

                dlg.rules = [
                    { id: 'rule_1', text: ' ,          .' },
                    { id: 'rule_2', text: '    .    ,    .' },
                    { id: 'rule_3', text: '        ,      .' }
                ];

                dlg.facts = [
                    { id: 'fact_1', text: '            .' },
                    { id: 'fact_2', text: '    - ,    .' },
                    { id: 'fact_3', text: '         .' }
                ];

                dlg.criteria = [
                    { id: 'crit_1', text: '       .' },
                    { id: 'crit_2', text: '        - .' },
                    { id: 'crit_3', text: ' ,  ,    .' }
                ];

                dlg.greetings = [
                    { id: 'greet_1', text: ' !  ,  ' + companyName + '.        .   , ?' }
                ];

                dlg.planItems = [
                    { id: 'plan_1', text: '   ' },
                    { id: 'plan_2', text: '      ' },
                    { id: 'plan_3', text: '      ' },
                    { id: 'plan_4', text: '    ' },
                    { id: 'plan_5', text: '     ' },
                    { id: 'plan_6', text: '    ' },
                    { id: 'plan_7', text: '   ' }
                ];

            } else if (templateId === 3) {
                //  3:    
                dlg = createDialogObject('  ');

                dlg.botRole = '  ,    ' + companyName + '.  ,         ,  .   ,       .   ' + companyProduct + '.        ,     .';

                dlg.botStyle = '  , , .     ,    .\n ,  .    .\n ,  .      .\n ,  ,  .        .\n   ,   .\n  .\n .    .';

                dlg.rules = [
                    { id: 'rule_1', text: ' .      ,    .' },
                    { id: 'rule_2', text: '          .' },
                    { id: 'rule_3', text: '     ,  ,   .' }
                ];

                dlg.facts = [
                    { id: 'fact_1', text: '          .' },
                    { id: 'fact_2', text: '     ,     ,     .' },
                    { id: 'fact_3', text: '          ,    .' }
                ];

                dlg.criteria = [
                    { id: 'crit_1', text: '    ,    .' },
                    { id: 'crit_2', text: '       .' },
                    { id: 'crit_3', text: ' ,         ,   .' }
                ];

                dlg.greetings = [
                    { id: 'greet_1', text: '!   ,   ' + companyName + '. ,    ,      .     ?' }
                ];

                dlg.planItems = [
                    { id: 'plan_1', text: '    ' },
                    { id: 'plan_2', text: '         ' },
                    { id: 'plan_3', text: '    ,     ' },
                    { id: 'plan_4', text: '      ' },
                    { id: 'plan_5', text: '  ,   ' },
                    { id: 'plan_6', text: '   ,    ' },
                    { id: 'plan_7', text: '      ' }
                ];

            } else {
                return;
            }

            dialogs.push(dlg);
            renderDialogTable();

            // Switch to Dialogs page
            var mainLink = document.querySelector('a[data-page="pageMain"]');
            if (mainLink) setActive(mainLink);

            // Open created dialog in edit mode
            openDialogDetail(dlg.id);
        }

        // ===== CUSTOM TEMPLATES =====
        var customTemplates = [];
        var customTplIdCounter = 0;
        var editingTplId = null;

        function openCustomTplModal(tplId) {
            editingTplId = tplId || null;
            var m = document.getElementById('customTplModal');
            if (editingTplId) {
                var tpl = customTemplates.find(function(t) { return t.id === editingTplId; });
                if (!tpl) return;
                document.getElementById('ctplName').value = tpl.name;
                document.getElementById('ctplDesc').value = tpl.desc;
                document.getElementById('ctplRole').value = tpl.botRole;
                document.getElementById('ctplStyle').value = tpl.botStyle;
                document.getElementById('ctplRules').value = tpl.rules.join('\n');
                document.getElementById('ctplFacts').value = tpl.facts.join('\n');
                document.getElementById('ctplCriteria').value = tpl.criteria.join('\n');
                document.getElementById('ctplGreeting').value = tpl.greeting;
                document.getElementById('ctplPlan').value = tpl.planItems.join('\n');
                document.getElementById('ctplSaveBtn').textContent = t('tplSaveBtn');
            } else {
                document.getElementById('ctplName').value = '';
                document.getElementById('ctplDesc').value = '';
                document.getElementById('ctplRole').value = '';
                document.getElementById('ctplStyle').value = '';
                document.getElementById('ctplRules').value = '';
                document.getElementById('ctplFacts').value = '';
                document.getElementById('ctplCriteria').value = '';
                document.getElementById('ctplGreeting').value = '';
                document.getElementById('ctplPlan').value = '';
            }
            m.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCustomTplModal() {
            document.getElementById('customTplModal').classList.remove('active');
            document.body.style.overflow = '';
            editingTplId = null;
        }

        function linesToArray(val) {
            return val.split('\n').map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
        }

        function saveCustomTpl() {
            var name = document.getElementById('ctplName').value.trim();
            if (!name) { document.getElementById('ctplName').focus(); return; }

            var data = {
                name: name,
                desc: document.getElementById('ctplDesc').value.trim(),
                botRole: document.getElementById('ctplRole').value.trim(),
                botStyle: document.getElementById('ctplStyle').value.trim(),
                rules: linesToArray(document.getElementById('ctplRules').value),
                facts: linesToArray(document.getElementById('ctplFacts').value),
                criteria: linesToArray(document.getElementById('ctplCriteria').value),
                greeting: document.getElementById('ctplGreeting').value.trim(),
                planItems: linesToArray(document.getElementById('ctplPlan').value)
            };

            if (editingTplId) {
                var tpl = customTemplates.find(function(t) { return t.id === editingTplId; });
                if (tpl) Object.assign(tpl, data);
            } else {
                customTplIdCounter++;
                data.id = 'ctpl_' + customTplIdCounter;
                customTemplates.push(data);
            }

            closeCustomTplModal();
            renderCustomTplCards();
        }

        function deleteCustomTpl(id) {
            customTemplates = customTemplates.filter(function(t) { return t.id !== id; });
            renderCustomTplCards();
        }

        function applyCustomTpl(id) {
            var tpl = customTemplates.find(function(t) { return t.id === id; });
            if (!tpl) return;

            var dlg = createDialogObject(tpl.name);
            dlg.botRole = tpl.botRole;
            dlg.botStyle = tpl.botStyle;

            dlg.rules = tpl.rules.map(function(text, i) {
                return { id: 'rule_' + (i + 1), text: text };
            });
            dlg.facts = tpl.facts.map(function(text, i) {
                return { id: 'fact_' + (i + 1), text: text };
            });
            dlg.criteria = tpl.criteria.map(function(text, i) {
                return { id: 'crit_' + (i + 1), text: text };
            });
            dlg.greetings = tpl.greeting ? [{ id: 'greet_1', text: tpl.greeting }] : [];
            dlg.planItems = tpl.planItems.map(function(text, i) {
                return { id: 'plan_' + (i + 1), text: text };
            });

            dialogs.push(dlg);
            renderDialogTable();

            var mainLink = document.querySelector('a[data-page="pageMain"]');
            if (mainLink) setActive(mainLink);
            openDialogDetail(dlg.id);
        }

        function renderCustomTplCards() {
            var container = document.getElementById('customTplCards');
            container.innerHTML = '';
            customTemplates.forEach(function(tpl) {
                var card = document.createElement('div');
                card.className = 'tpl-card';
                card.innerHTML =
                    '<div class="tpl-card-title">' + escapeHtml(tpl.name) + '</div>' +
                    '<div class="tpl-card-desc">' + escapeHtml(tpl.desc || '') + '</div>' +
                    '<div class="tpl-actions">' +
                        '<button class="tpl-select-btn" onclick="applyCustomTpl(\'' + tpl.id + '\')">' + t('tplSelect') + '</button>' +
                    '</div>' +
                    '<div class="tpl-card-custom-actions">' +
                        '<button class="tpl-edit-btn" onclick="openCustomTplModal(\'' + tpl.id + '\')">' + t('tplEditBtn') + '</button>' +
                        '<button class="tpl-delete-btn" onclick="deleteCustomTpl(\'' + tpl.id + '\')">' + t('tplDeleteBtn') + '</button>' +
                    '</div>';
                container.appendChild(card);
            });
        }

        function openCreateDialogModal() {
            document.getElementById('createDialogModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            var inp = document.getElementById('newDialogName');
            inp.value = '';
            setTimeout(function() { inp.focus(); }, 100);
        }

        function closeCreateDialogModal() {
            document.getElementById('createDialogModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function createDialog() {
            var name = document.getElementById('newDialogName').value.trim();
            if (!name) return;
            var dlg = createDialogObject(name);
            dialogs.push(dlg);
            closeCreateDialogModal();
            renderDialogTable();
        }

        var qsCurrentStep = 1;
        var qsFiles = [];

        function quickStartDialog() {
            qsResetForm();
            qsCurrentStep = 1;
            qsGoToStep(1);
            document.getElementById('qsWizard').classList.add('active');
            document.body.style.overflow = 'hidden';
            applyLang();
        }

        function closeQsWizard() {
            document.getElementById('qsWizard').classList.remove('active');
            document.body.style.overflow = '';
        }

        function qsResetForm() {
            var ids = ['qsWhatSell','qsWhoTarget','qsAdvantages','qsGreetings','qsPitch','qsClosing',
                       'qsProductLine','qsMinConditions','qsFactsFigures','qsCollectFields',
                       'qsForbidden','qsNoPromise','qsTerms','qsGoalOtherText','qsAfterOtherText','qsDialogName'];
            ids.forEach(function(id) { document.getElementById(id).value = ''; });
            document.getElementById('qsAfterCall').selectedIndex = 0;
            document.getElementById('qsGoal').selectedIndex = 0;
            document.getElementById('qsGoalOtherWrap').style.display = 'none';
            document.getElementById('qsAfterOtherWrap').style.display = 'none';
            qsFiles = [];
            document.getElementById('qsFileList').innerHTML = '';
            document.getElementById('qsFileInput').value = '';
        }

        function qsGoToStep(n) {
            if (n < 1 || n > 7) return;
            qsCurrentStep = n;
            for (var i = 1; i <= 7; i++) {
                var step = document.getElementById('qsStep' + i);
                if (step) step.classList.toggle('active', i === n);
            }
            qsUpdateProgress(n);
            // Nav buttons
            document.getElementById('qsBtnBack').style.display = n > 1 ? '' : 'none';
            document.getElementById('qsBtnSkip').style.display = (n === 3) ? '' : 'none';
            var nextBtn = document.getElementById('qsBtnNext');
            if (n === 7) {
                nextBtn.textContent = t('qsFinishBtn');
                nextBtn.onclick = qsFinish;
            } else {
                nextBtn.textContent = t('qsNext');
                nextBtn.onclick = function() { qsGoToStep(qsCurrentStep + 1); };
            }
        }

        function qsUpdateProgress(step) {
            for (var i = 1; i <= 7; i++) {
                var dot = document.getElementById('qsDot' + i);
                dot.classList.remove('active', 'done');
                if (i === step) dot.classList.add('active');
                else if (i < step) dot.classList.add('done');
            }
            for (var j = 1; j <= 6; j++) {
                var line = document.getElementById('qsLine' + j);
                line.classList.toggle('done', j < step);
            }
        }

        function qsToggleAfterOther() {
            var sel = document.getElementById('qsAfterCall').value;
            document.getElementById('qsAfterOtherWrap').style.display = sel === 'other' ? '' : 'none';
        }

        function qsToggleGoalOther() {
            var sel = document.getElementById('qsGoal').value;
            document.getElementById('qsGoalOtherWrap').style.display = sel === 'other' ? '' : 'none';
        }

        function qsHandleFiles(fileList) {
            for (var i = 0; i < fileList.length; i++) {
                var f = fileList[i];
                if (f.size <= 25 * 1024 * 1024) qsFiles.push(f);
            }
            qsRenderFileList();
        }

        function qsRemoveFile(idx) {
            qsFiles.splice(idx, 1);
            qsRenderFileList();
        }

        function qsRenderFileList() {
            var html = '';
            qsFiles.forEach(function(f, i) {
                var size = (f.size / 1024 / 1024).toFixed(1) + ' MB';
                html += '<div class="qs-file-item"><span style="flex:1">' + f.name + ' (' + size + ')</span>' +
                        '<button onclick="qsRemoveFile(' + i + ')">&times;</button></div>';
            });
            document.getElementById('qsFileList').innerHTML = html;
        }

        // Drag-and-drop for upload area
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                var area = document.getElementById('qsUploadArea');
                if (!area) return;
                area.addEventListener('dragover', function(e) { e.preventDefault(); area.classList.add('dragover'); });
                area.addEventListener('dragleave', function() { area.classList.remove('dragover'); });
                area.addEventListener('drop', function(e) {
                    e.preventDefault(); area.classList.remove('dragover');
                    qsHandleFiles(e.dataTransfer.files);
                });
            });
        })();

        function qsSplitToItems(text) {
            if (!text || !text.trim()) return [];
            // Split by newlines first
            var lines = text.split(/\n/);
            var result = [];
            lines.forEach(function(line) {
                line = line.trim();
                if (!line) return;
                // Split by ; then by , but not inside words
                var parts = line.split(/[;]/);
                parts.forEach(function(part) {
                    // Split by "  " (with spaces) as separator
                    var subparts = part.split(/\s+\s+/);
                    subparts.forEach(function(sp) {
                        // Also split by comma
                        var items = sp.split(/,/);
                        items.forEach(function(item) {
                            item = item.trim();
                            if (item) {
                                // Capitalize first letter
                                result.push(item.charAt(0).toUpperCase() + item.slice(1));
                            }
                        });
                    });
                });
            });
            return result;
        }

        function qsFinish() {
            var v = function(id) { return document.getElementById(id).value.trim(); };
            var dialogName = v('qsDialogName') || t('dlgQuickStartName');
            var dlg = createDialogObject(dialogName);

            // botRole: " []  []"
            var what = v('qsWhatSell');
            var who = v('qsWhoTarget');
            if (what || who) {
                dlg.botRole = (currentLang === 'ru' ? ' ' : 'Selling ') +
                              (what || '...') +
                              (currentLang === 'ru' ? '  ' : ' for ') +
                              (who || '...');
            }

            // botStyle: opening phrases from step 2
            dlg.botStyle = v('qsGreetings');

            // greetings[]: split greeting phrases
            var greetItems = qsSplitToItems(v('qsGreetings'));
            greetingIdCounter = greetingIdCounter || 0;
            greetItems.forEach(function(txt) {
                greetingIdCounter++;
                dlg.greetings.push({ id: 'greet_' + greetingIdCounter, text: txt });
            });

            // planItems[]: pitch + closing from step 2
            var planTexts = qsSplitToItems(v('qsPitch'));
            var closeTexts = qsSplitToItems(v('qsClosing'));
            planIdCounter = planIdCounter || 0;
            planTexts.concat(closeTexts).forEach(function(txt) {
                planIdCounter++;
                dlg.planItems.push({ id: 'plan_' + planIdCounter, text: txt });
            });

            // facts[]: advantages (step1) + product line + conditions + facts (step4)
            var factTexts = qsSplitToItems(v('qsAdvantages'))
                .concat(qsSplitToItems(v('qsProductLine')))
                .concat(qsSplitToItems(v('qsMinConditions')))
                .concat(qsSplitToItems(v('qsFactsFigures')));
            factIdCounter = factIdCounter || 0;
            factTexts.forEach(function(txt) {
                factIdCounter++;
                dlg.facts.push({ id: 'fact_' + factIdCounter, text: txt });
            });

            // criteria[]: collect fields (step5) + goal + after-call action (step1)
            var critTexts = qsSplitToItems(v('qsCollectFields'));
            // Add goal
            var goalSel = document.getElementById('qsGoal');
            var goalText = goalSel.value === 'other' ? v('qsGoalOtherText') : goalSel.options[goalSel.selectedIndex].textContent;
            if (goalText) critTexts.push(goalText.charAt(0).toUpperCase() + goalText.slice(1));
            // Add after-call action
            var afterSel = document.getElementById('qsAfterCall');
            var afterText = afterSel.value === 'other' ? v('qsAfterOtherText') : afterSel.options[afterSel.selectedIndex].textContent;
            if (afterText) critTexts.push(afterText.charAt(0).toUpperCase() + afterText.slice(1));
            criterionIdCounter = criterionIdCounter || 0;
            critTexts.forEach(function(txt) {
                criterionIdCounter++;
                dlg.criteria.push({ id: 'crit_' + criterionIdCounter, text: txt });
            });

            // rules[]: forbidden + no promise + terms (step6)
            var ruleTexts = qsSplitToItems(v('qsForbidden'))
                .concat(qsSplitToItems(v('qsNoPromise')))
                .concat(qsSplitToItems(v('qsTerms')));
            ruleIdCounter = ruleIdCounter || 0;
            ruleTexts.forEach(function(txt) {
                ruleIdCounter++;
                dlg.rules.push({ id: 'rule_' + ruleIdCounter, text: txt });
            });

            dialogs.push(dlg);
            closeQsWizard();
            renderDialogTable();
            openDialogDetail(dlg.id);
        }

        function openTemplatesModal() {
            var tplLink = document.querySelector('a[data-page="pageTemplates"]');
            if (tplLink) setActive(tplLink);
        }

        function openDeleteDialogModal(id) {
            deleteTargetId = id;
            document.getElementById('deleteDialogModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteDialogModal() {
            deleteTargetId = null;
            document.getElementById('deleteDialogModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function confirmDeleteDialog() {
            if (!deleteTargetId) return;
            dialogs = dialogs.filter(function(d) { return d.id !== deleteTargetId; });
            if (currentDialogId === deleteTargetId) {
                currentDialogId = null;
                showDialogList();
            }
            closeDeleteDialogModal();
            renderDialogTable();
        }

        // ===== MANAGEMENT MODAL =====
        var mgmtCurrentId = null;
        var mgmtDaysState = [];

        function openMgmtModal(id) {
            var dlg = dialogs.find(function(d) { return d.id === id; });
            if (!dlg) return;
            mgmtCurrentId = id;
            // Ensure defaults for older dialogs
            if (!dlg.schedule) dlg.schedule = { days: [1,2,3,4,5], timeFrom: '09:00', timeTo: '18:00' };
            if (dlg.useClientTz === undefined) dlg.useClientTz = false;
            if (dlg.contactLimit === undefined) dlg.contactLimit = 100;
            if (dlg.maxCallSec === undefined) dlg.maxCallSec = 600;

            mgmtDaysState = dlg.schedule.days.slice();
            document.getElementById('mgmtDialogName').textContent = dlg.name;
            document.getElementById('mgmtTimeFrom').value = dlg.schedule.timeFrom;
            document.getElementById('mgmtTimeTo').value = dlg.schedule.timeTo;
            mgmtRenderDays();
            var tzToggle = document.getElementById('mgmtTzToggle');
            if (dlg.useClientTz) { tzToggle.classList.add('on'); } else { tzToggle.classList.remove('on'); }
            document.getElementById('mgmtContactLimit').value = dlg.contactLimit;
            document.getElementById('mgmtMaxCallSec').value = dlg.maxCallSec;
            document.getElementById('mgmtModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            applyLang();
        }

        function closeMgmtModal() {
            document.getElementById('mgmtModal').classList.remove('active');
            document.body.style.overflow = '';
            mgmtCurrentId = null;
        }

        function mgmtRenderDays() {
            var dayKeys = ['mgmtMon','mgmtTue','mgmtWed','mgmtThu','mgmtFri','mgmtSat','mgmtSun'];
            var container = document.getElementById('mgmtDays');
            container.innerHTML = '';
            for (var i = 0; i < 7; i++) {
                var dayNum = i + 1;
                var isOn = mgmtDaysState.indexOf(dayNum) !== -1;
                var btn = document.createElement('button');
                btn.className = 'mgmt-day' + (isOn ? ' on' : '');
                btn.textContent = t(dayKeys[i]);
                btn.setAttribute('data-day', dayNum);
                btn.onclick = (function(d) { return function() { mgmtToggleDay(d); }; })(dayNum);
                container.appendChild(btn);
            }
        }

        function mgmtToggleDay(day) {
            var idx = mgmtDaysState.indexOf(day);
            if (idx !== -1) { mgmtDaysState.splice(idx, 1); } else { mgmtDaysState.push(day); }
            mgmtRenderDays();
        }

        function mgmtToggleTz() {
            var el = document.getElementById('mgmtTzToggle');
            el.classList.toggle('on');
        }

        function saveMgmt() {
            if (!mgmtCurrentId) return;
            var dlg = dialogs.find(function(d) { return d.id === mgmtCurrentId; });
            if (!dlg) return;
            dlg.schedule = {
                days: mgmtDaysState.slice().sort(),
                timeFrom: document.getElementById('mgmtTimeFrom').value,
                timeTo: document.getElementById('mgmtTimeTo').value
            };
            dlg.useClientTz = document.getElementById('mgmtTzToggle').classList.contains('on');
            dlg.contactLimit = parseInt(document.getElementById('mgmtContactLimit').value, 10) || 100;
            dlg.maxCallSec = parseInt(document.getElementById('mgmtMaxCallSec').value, 10) || 600;
            dlg.updatedAt = new Date().toISOString();
            closeMgmtModal();
        }

        function toggleContextMenu(id, event) {
            event.stopPropagation();
            var menu = document.getElementById('dlgContextMenu');
            // If already open for this id, close it
            if (menu.classList.contains('show') && menu.getAttribute('data-dlg-id') === id) {
                closeAllContextMenus();
                return;
            }
            menu.setAttribute('data-dlg-id', id);
            menu.innerHTML =
                '<button class="dlg-context-item" onclick="event.stopPropagation();closeAllContextMenus();openMgmtModal(\'' + id + '\')">' + t('dlgMenuTitle') + '</button>' +
                '<button class="dlg-context-item" onclick="event.stopPropagation();startRename(\'' + id + '\')">' + t('dlgRename') + '</button>' +
                '<button class="dlg-context-item" onclick="event.stopPropagation();cloneDialog(\'' + id + '\')">' + t('dlgClone') + '</button>' +
                '<button class="dlg-context-item danger" onclick="event.stopPropagation();openDeleteDialogModal(\'' + id + '\')">' + t('dlgDelete') + '</button>';
            var btn = event.currentTarget;
            var rect = btn.getBoundingClientRect();
            menu.style.top = (rect.bottom + 4) + 'px';
            menu.style.left = '';
            menu.style.right = (window.innerWidth - rect.right) + 'px';
            menu.classList.add('show');
        }

        function closeAllContextMenus() {
            var menu = document.getElementById('dlgContextMenu');
            menu.classList.remove('show');
        }

        function startRename(id) {
            closeAllContextMenus();
            var cell = document.getElementById('namecell_' + id);
            if (!cell) return;
            var dlg = dialogs.find(function(d) { return d.id === id; });
            if (!dlg) return;
            cell.innerHTML = '<input class="dlg-name-input" id="renameinp_' + id + '" value="' + escapeHtml(dlg.name) + '" maxlength="100" onclick="event.stopPropagation()" onkeydown="if(event.key===\'Enter\'){finishRename(\'' + id + '\',this.value);event.preventDefault();}if(event.key===\'Escape\'){renderDialogTable();}" onblur="finishRename(\'' + id + '\',this.value)">';
            var inp = document.getElementById('renameinp_' + id);
            if (inp) { inp.focus(); inp.select(); }
        }

        function finishRename(id, value) {
            var name = value.trim();
            if (!name) { renderDialogTable(); return; }
            var dlg = dialogs.find(function(d) { return d.id === id; });
            if (dlg) {
                dlg.name = name;
                dlg.updatedAt = new Date().toISOString();
            }
            renderDialogTable();
        }

        function cloneDialog(id) {
            closeAllContextMenus();
            var src = dialogs.find(function(d) { return d.id === id; });
            if (!src) return;
            var clone = createDialogObject(src.name + ' ' + t('dlgCopySuffix'));
            clone.botRole = src.botRole;
            clone.botStyle = src.botStyle;
            clone.rules = JSON.parse(JSON.stringify(src.rules));
            clone.facts = JSON.parse(JSON.stringify(src.facts));
            clone.criteria = JSON.parse(JSON.stringify(src.criteria));
            clone.greetings = JSON.parse(JSON.stringify(src.greetings));
            clone.planItems = JSON.parse(JSON.stringify(src.planItems));
            clone.schedule = JSON.parse(JSON.stringify(src.schedule));
            clone.useClientTz = src.useClientTz;
            clone.contactLimit = src.contactLimit;
            clone.maxCallSec = src.maxCallSec;
            // Regenerate IDs in cloned arrays
            var regen = function(arr, prefix) {
                arr.forEach(function(item) {
                    dialogIdCounter++;
                    item.id = prefix + '_' + dialogIdCounter;
                });
            };
            regen(clone.rules, 'rule');
            regen(clone.facts, 'fact');
            regen(clone.criteria, 'crit');
            regen(clone.greetings, 'greet');
            regen(clone.planItems, 'plan');
            dialogs.push(clone);
            renderDialogTable();
        }

        function formatDate(isoStr) {
            var d = new Date(isoStr);
            var pad = function(n) { return n < 10 ? '0' + n : n; };
            return pad(d.getDate()) + '.' + pad(d.getMonth() + 1) + '.' + d.getFullYear() + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
        }

        function dlgCompleteness(dlg) {
            var fields = 0, total = 7;
            if (dlg.botRole && dlg.botRole.trim()) fields++;
            if (dlg.botStyle && dlg.botStyle.trim()) fields++;
            if (dlg.rules && dlg.rules.some(function(r) { return r.text && r.text.trim(); })) fields++;
            if (dlg.facts && dlg.facts.some(function(r) { return r.text && r.text.trim(); })) fields++;
            if (dlg.criteria && dlg.criteria.some(function(r) { return r.text && r.text.trim(); })) fields++;
            if (dlg.greetings && dlg.greetings.some(function(r) { return r.text && r.text.trim(); })) fields++;
            if (dlg.planItems && dlg.planItems.some(function(r) { return r.text && r.text.trim(); })) fields++;
            return Math.round((fields / total) * 100);
        }

        function dlgRingColor(pct) {
            if (pct >= 100) return '#2ecc71';
            if (pct >= 60) return '#f1c40f';
            return '#e74c3c';
        }

        function dlgRingHTML(pct, size) {
            size = size || 28;
            var r = (size - 4) / 2;
            var circ = 2 * Math.PI * r;
            var offset = circ - (pct / 100) * circ;
            var color = dlgRingColor(pct);
            return '<div class="dlg-ring" style="width:' + size + 'px;height:' + size + 'px">' +
                '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">' +
                    '<circle class="dlg-ring-bg" cx="' + size/2 + '" cy="' + size/2 + '" r="' + r + '"/>' +
                    '<circle class="dlg-ring-fill" cx="' + size/2 + '" cy="' + size/2 + '" r="' + r + '" stroke="' + color + '" stroke-dasharray="' + circ.toFixed(1) + '" stroke-dashoffset="' + offset.toFixed(1) + '"/>' +
                '</svg>' +
                '<div class="dlg-ring-pct" style="color:' + color + '">' + pct + '</div>' +
            '</div>';
        }

        function dlgStatusText(pct) {
            if (pct >= 100) return { text: t('dlgReady'), cls: 'ready' };
            if (pct >= 60) return { text: t('dlgAlmost'), cls: 'warning' };
            return { text: t('dlgFillMore'), cls: 'danger' };
        }

        function renderDialogTable() {
            var tbody = document.getElementById('dialogTableBody');
            var emptyEl = document.getElementById('dlgEmpty');
            tbody.innerHTML = '';
            if (dialogs.length === 0) {
                emptyEl.style.display = '';
                return;
            }
            emptyEl.style.display = 'none';
            dialogs.forEach(function(dlg) {
                var tr = document.createElement('tr');
                tr.onclick = function() { openDialogDetail(dlg.id); };
                var pct = dlgCompleteness(dlg);
                var st = dlgStatusText(pct);
                var canActivate = pct >= 100;
                var isOn = dlg.active && canActivate;
                tr.innerHTML =
                    '<td class="dlg-name-cell" id="namecell_' + dlg.id + '">' +
                        '<div class="dlg-name-wrap">' +
                            dlgRingHTML(pct) +
                            '<div>' +
                                '<div>' + escapeHtml(dlg.name) + '</div>' +
                                '<div class="dlg-status-hint ' + st.cls + '">' + st.text + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</td>' +
                    '<td>' +
                        '<div class="dlg-toggle">' +
                            '<div class="dlg-toggle-track' + (isOn ? ' on' : '') + (canActivate ? '' : ' disabled') + '" onclick="event.stopPropagation();dlgToggleActive(\'' + dlg.id + '\')">' +
                                '<div class="dlg-toggle-thumb"></div>' +
                            '</div>' +
                            '<span class="dlg-toggle-label' + (isOn ? ' on' : '') + '">' + (isOn ? t('dlgActive') : t('dlgInactive')) + '</span>' +
                            (canActivate ? '' : '<div class="dlg-toggle-tip">' + t('dlgFillToActivate') + '</div>') +
                        '</div>' +
                    '</td>' +
                    '<td class="dlg-date">' + formatDate(dlg.createdAt) + '</td>' +
                    '<td class="dlg-date">' + formatDate(dlg.updatedAt) + '</td>' +
                    '<td style="text-align:center;">' +
                        '<button class="dlg-menu-btn" onclick="toggleContextMenu(\'' + dlg.id + '\',event)" title="' + t('tipMore') + '">&#8942;</button>' +
                    '</td>';
                tbody.appendChild(tr);
            });
        }

        function openDialogDetail(id) {
            var dlg = dialogs.find(function(d) { return d.id === id; });
            if (!dlg) return;
            currentDialogId = id;
            loadDialogIntoForm(dlg);
            document.getElementById('dialogListView').style.display = 'none';
            document.getElementById('dialogDetailView').style.display = '';
            document.getElementById('botHeaderTitle').textContent = dlg.name;
            updateDetailRing();
        }

        function updateDetailRing() {
            if (!currentDialogId) return;
            var dlg = dialogs.find(function(d) { return d.id === currentDialogId; });
            if (!dlg) return;
            var tmp = {
                botRole: document.getElementById('botSellerRole').value,
                botStyle: document.getElementById('botSpeechStyle').value,
                rules: typeof botRules !== 'undefined' ? botRules : dlg.rules,
                facts: typeof botFacts !== 'undefined' ? botFacts : dlg.facts,
                criteria: typeof botCriteria !== 'undefined' ? botCriteria : dlg.criteria,
                greetings: typeof botGreetings !== 'undefined' ? botGreetings : dlg.greetings,
                planItems: typeof botPlanItems !== 'undefined' ? botPlanItems : dlg.planItems
            };
            var pct = dlgCompleteness(tmp);
            var st = dlgStatusText(pct);
            var ringEl = document.getElementById('botHeaderRing');
            var statusEl = document.getElementById('botHeaderStatus');
            if (ringEl) ringEl.innerHTML = dlgRingHTML(pct, 32);
            if (statusEl) { statusEl.textContent = st.text; statusEl.className = 'dlg-status-hint ' + st.cls; }
            // Update header toggle
            var canActivate = pct >= 100;
            if (!canActivate && dlg.active) { dlg.active = false; }
            var isOn = dlg.active && canActivate;
            var toggleEl = document.getElementById('botHeaderToggle');
            if (toggleEl) {
                toggleEl.innerHTML =
                    '<div class="dlg-toggle-track' + (isOn ? ' on' : '') + (canActivate ? '' : ' disabled') + '" onclick="dlgToggleActive(\'' + dlg.id + '\')">' +
                        '<div class="dlg-toggle-thumb"></div>' +
                    '</div>' +
                    '<span class="dlg-toggle-label' + (isOn ? ' on' : '') + '">' + (isOn ? t('dlgActive') : t('dlgInactive')) + '</span>' +
                    (canActivate ? '' : '<div class="dlg-toggle-tip">' + t('dlgFillToActivate') + '</div>');
            }
        }

        function dlgToggleActive(id) {
            var dlg = dialogs.find(function(d) { return d.id === id; });
            if (!dlg) return;
            var pct = dlgCompleteness(dlg);
            if (pct < 100) return;
            dlg.active = !dlg.active;
            renderDialogTable();
            updateDetailRing();
        }

        function showDialogList() {
            if (currentDialogId) saveFormIntoDialog(currentDialogId);
            currentDialogId = null;
            document.getElementById('dialogDetailView').style.display = 'none';
            document.getElementById('dialogListView').style.display = '';
            renderDialogTable();
        }

        function loadDialogIntoForm(dlg) {
            document.getElementById('botSellerRole').value = dlg.botRole;
            document.getElementById('roleCount').textContent = dlg.botRole.length + '/500';
            document.getElementById('botSpeechStyle').value = dlg.botStyle;
            document.getElementById('styleCount').textContent = dlg.botStyle.length + '/500';
            // Load arrays
            botRules = JSON.parse(JSON.stringify(dlg.rules));
            botFacts = JSON.parse(JSON.stringify(dlg.facts));
            botCriteria = JSON.parse(JSON.stringify(dlg.criteria));
            botGreetings = JSON.parse(JSON.stringify(dlg.greetings));
            botPlanItems = JSON.parse(JSON.stringify(dlg.planItems));
            // Sync counters to max existing ID to prevent collisions
            var maxId = dialogIdCounter;
            [].concat(dlg.rules, dlg.facts, dlg.criteria, dlg.greetings, dlg.planItems).forEach(function(item) {
                var m = item.id.match(/(\d+)$/);
                if (m) maxId = Math.max(maxId, parseInt(m[1], 10));
            });
            dialogIdCounter = maxId;
            ruleIdCounter = maxId;
            factIdCounter = maxId;
            criterionIdCounter = maxId;
            greetingIdCounter = maxId;
            planIdCounter = maxId;
            // Render
            renderRules();
            renderFacts();
            renderCriteria();
            renderGreetings();
            renderPlanItems();
            // Reset to context tab
            switchBotTab('context', document.querySelector('#botTabs .bot-tab'));
        }

        function saveFormIntoDialog(id) {
            var dlg = dialogs.find(function(d) { return d.id === id; });
            if (!dlg) return;
            dlg.botRole = document.getElementById('botSellerRole').value;
            dlg.botStyle = document.getElementById('botSpeechStyle').value;
            dlg.rules = JSON.parse(JSON.stringify(botRules));
            dlg.facts = JSON.parse(JSON.stringify(botFacts));
            dlg.criteria = JSON.parse(JSON.stringify(botCriteria));
            dlg.greetings = JSON.parse(JSON.stringify(botGreetings));
            dlg.planItems = JSON.parse(JSON.stringify(botPlanItems));
            dlg.updatedAt = new Date().toISOString();
        }

        function setActive(el) {
            // Save current dialog before navigating away
            if (currentDialogId) {
                saveFormIntoDialog(currentDialogId);
                currentDialogId = null;
                document.getElementById('dialogDetailView').style.display = 'none';
                document.getElementById('dialogListView').style.display = '';
            }
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            el.classList.add('active');
            var pageId = el.getAttribute('data-page');
            if (pageId) {
                document.querySelectorAll('.page-section').forEach(function(p) { p.classList.remove('active'); });
                var target = document.getElementById(pageId);
                if (target) target.classList.add('active');
            }
        }

        // ===== BOT CONFIG =====
        var botRules = [];
        var ruleIdCounter = 0;
        var saveTimer = null;

        function switchBotTab(tabId, btn) {
            document.querySelectorAll('.bot-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.bot-tab-content').forEach(function(c) { c.classList.remove('active'); });
            btn.classList.add('active');
            var map = { context:'tabContext', plan:'tabPlan', knowledge:'tabKnowledge' };
            var el = document.getElementById(map[tabId]);
            if (el) el.classList.add('active');
        }

        function onBotInput(textarea, counterId) {
            var len = textarea.value.length;
            document.getElementById(counterId).textContent = len + '/500';
            triggerAutoSave();
        }

        function triggerAutoSave() {
            var status = document.getElementById('saveStatus');
            status.textContent = t('saving');
            status.className = 'save-status saving';
            updateDetailRing();
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(function() {
                if (currentDialogId) saveFormIntoDialog(currentDialogId);
                status.textContent = t('saved');
                status.className = 'save-status saved';
                document.getElementById('lastUpdated').textContent = t('botUpdated');
            }, 1000);
        }

        function addRule() {
            ruleIdCounter++;
            botRules.push({ id: 'rule_' + ruleIdCounter, text: '' });
            renderRules();
            triggerAutoSave();
        }

        function deleteRule(id) {
            botRules = botRules.filter(function(r) { return r.id !== id; });
            renderRules();
            triggerAutoSave();
        }

        function onRuleInput(id, textarea) {
            for (var i = 0; i < botRules.length; i++) {
                if (botRules[i].id === id) { botRules[i].text = textarea.value; break; }
            }
            var countEl = document.getElementById('count_' + id);
            if (countEl) countEl.textContent = textarea.value.length + '/500';
            triggerAutoSave();
        }

        var dragRuleId = null;

        function onRuleDragStart(e, id) {
            dragRuleId = id;
            e.currentTarget.closest('.rule-item').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function onRuleDragEnd(e) {
            dragRuleId = null;
            document.querySelectorAll('.rule-item').forEach(function(r) {
                r.classList.remove('dragging');
                r.classList.remove('drag-over');
            });
        }

        function onRuleDragOver(e, id) {
            e.preventDefault();
            if (dragRuleId && dragRuleId !== id) {
                e.currentTarget.classList.add('drag-over');
            }
        }

        function onRuleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function onRuleDrop(e, targetId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            if (!dragRuleId || dragRuleId === targetId) return;
            var fromIdx = botRules.findIndex(function(r) { return r.id === dragRuleId; });
            var toIdx = botRules.findIndex(function(r) { return r.id === targetId; });
            if (fromIdx === -1 || toIdx === -1) return;
            var moved = botRules.splice(fromIdx, 1)[0];
            botRules.splice(toIdx, 0, moved);
            renderRules();
            triggerAutoSave();
        }

        function renderRules() {
            var list = document.getElementById('rulesList');
            list.innerHTML = '';
            botRules.forEach(function(rule, idx) {
                var div = document.createElement('div');
                div.className = 'rule-item';
                div.setAttribute('draggable', 'false');
                div.ondragover = function(e) { onRuleDragOver(e, rule.id); };
                div.ondragleave = onRuleDragLeave;
                div.ondrop = function(e) { onRuleDrop(e, rule.id); };
                div.innerHTML =
                    '<div class="rule-num">' + (idx + 1) + '</div>' +
                    '<div class="rule-body">' +
                        '<textarea class="rule-input" maxlength="500" placeholder="' + t('phRule') + '" oninput="onRuleInput(\'' + rule.id + '\',this)">' + escapeHtml(rule.text) + '</textarea>' +
                        '<div class="rule-char-count" id="count_' + rule.id + '">' + rule.text.length + '/500</div>' +
                    '</div>' +
                    '<div class="rule-actions">' +
                        '<button class="rule-action-btn rule-drag" draggable="true" ondragstart="onRuleDragStart(event,\'' + rule.id + '\')" ondragend="onRuleDragEnd(event)" title="' + t('tipDrag') + '">' +
                            '<svg viewBox="0 0 24 24"><circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/><circle cx="9" cy="15" r="1.5"/><circle cx="15" cy="15" r="1.5"/><circle cx="9" cy="20" r="1.5"/><circle cx="15" cy="20" r="1.5"/></svg>' +
                        '</button>' +
                        '<button class="rule-action-btn" onclick="deleteRule(\'' + rule.id + '\')" title="' + t('tipDelete') + '">' +
                            '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                        '</button>' +
                    '</div>';
                list.appendChild(div);
            });
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        // ===== FACTS =====
        var botFacts = [];
        var factIdCounter = 0;

        function addFact() {
            factIdCounter++;
            botFacts.push({ id: 'fact_' + factIdCounter, text: '' });
            renderFacts();
            triggerAutoSave();
        }

        function deleteFact(id) {
            botFacts = botFacts.filter(function(r) { return r.id !== id; });
            renderFacts();
            triggerAutoSave();
        }

        function onFactInput(id, textarea) {
            for (var i = 0; i < botFacts.length; i++) {
                if (botFacts[i].id === id) { botFacts[i].text = textarea.value; break; }
            }
            var countEl = document.getElementById('count_' + id);
            if (countEl) countEl.textContent = textarea.value.length + '/500';
            triggerAutoSave();
        }

        var dragFactId = null;

        function onFactDragStart(e, id) {
            dragFactId = id;
            e.currentTarget.closest('.rule-item').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function onFactDragEnd(e) {
            dragFactId = null;
            document.querySelectorAll('#factsList .rule-item').forEach(function(r) {
                r.classList.remove('dragging'); r.classList.remove('drag-over');
            });
        }
        function onFactDragOver(e, id) {
            e.preventDefault();
            if (dragFactId && dragFactId !== id) e.currentTarget.classList.add('drag-over');
        }
        function onFactDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function onFactDrop(e, targetId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            if (!dragFactId || dragFactId === targetId) return;
            var fromIdx = botFacts.findIndex(function(r) { return r.id === dragFactId; });
            var toIdx = botFacts.findIndex(function(r) { return r.id === targetId; });
            if (fromIdx === -1 || toIdx === -1) return;
            var moved = botFacts.splice(fromIdx, 1)[0];
            botFacts.splice(toIdx, 0, moved);
            renderFacts();
            triggerAutoSave();
        }

        function renderFacts() {
            var list = document.getElementById('factsList');
            list.innerHTML = '';
            botFacts.forEach(function(item, idx) {
                var div = document.createElement('div');
                div.className = 'rule-item';
                div.ondragover = function(e) { onFactDragOver(e, item.id); };
                div.ondragleave = onFactDragLeave;
                div.ondrop = function(e) { onFactDrop(e, item.id); };
                div.innerHTML =
                    '<div class="rule-num">' + (idx + 1) + '</div>' +
                    '<div class="rule-body">' +
                        '<textarea class="rule-input" maxlength="500" placeholder="' + t('phFact') + '" oninput="onFactInput(\'' + item.id + '\',this)">' + escapeHtml(item.text) + '</textarea>' +
                        '<div class="rule-char-count" id="count_' + item.id + '">' + item.text.length + '/500</div>' +
                    '</div>' +
                    '<div class="rule-actions">' +
                        '<button class="rule-action-btn rule-drag" draggable="true" ondragstart="onFactDragStart(event,\'' + item.id + '\')" ondragend="onFactDragEnd(event)" title="' + t('tipDrag') + '">' +
                            '<svg viewBox="0 0 24 24"><circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/><circle cx="9" cy="15" r="1.5"/><circle cx="15" cy="15" r="1.5"/><circle cx="9" cy="20" r="1.5"/><circle cx="15" cy="20" r="1.5"/></svg>' +
                        '</button>' +
                        '<button class="rule-action-btn" onclick="deleteFact(\'' + item.id + '\')" title="' + t('tipDelete') + '">' +
                            '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                        '</button>' +
                    '</div>';
                list.appendChild(div);
            });
        }

        // ===== CRITERIA =====
        var botCriteria = [];
        var criterionIdCounter = 0;

        function addCriterion() {
            criterionIdCounter++;
            botCriteria.push({ id: 'crit_' + criterionIdCounter, text: '' });
            renderCriteria();
            triggerAutoSave();
        }

        function deleteCriterion(id) {
            botCriteria = botCriteria.filter(function(r) { return r.id !== id; });
            renderCriteria();
            triggerAutoSave();
        }

        function onCriterionInput(id, textarea) {
            for (var i = 0; i < botCriteria.length; i++) {
                if (botCriteria[i].id === id) { botCriteria[i].text = textarea.value; break; }
            }
            var countEl = document.getElementById('count_' + id);
            if (countEl) countEl.textContent = textarea.value.length + '/500';
            triggerAutoSave();
        }

        var dragCritId = null;

        function onCritDragStart(e, id) {
            dragCritId = id;
            e.currentTarget.closest('.rule-item').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function onCritDragEnd(e) {
            dragCritId = null;
            document.querySelectorAll('#criteriaList .rule-item').forEach(function(r) {
                r.classList.remove('dragging'); r.classList.remove('drag-over');
            });
        }
        function onCritDragOver(e, id) {
            e.preventDefault();
            if (dragCritId && dragCritId !== id) e.currentTarget.classList.add('drag-over');
        }
        function onCritDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function onCritDrop(e, targetId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            if (!dragCritId || dragCritId === targetId) return;
            var fromIdx = botCriteria.findIndex(function(r) { return r.id === dragCritId; });
            var toIdx = botCriteria.findIndex(function(r) { return r.id === targetId; });
            if (fromIdx === -1 || toIdx === -1) return;
            var moved = botCriteria.splice(fromIdx, 1)[0];
            botCriteria.splice(toIdx, 0, moved);
            renderCriteria();
            triggerAutoSave();
        }

        function renderCriteria() {
            var list = document.getElementById('criteriaList');
            list.innerHTML = '';
            botCriteria.forEach(function(item, idx) {
                var div = document.createElement('div');
                div.className = 'rule-item';
                div.ondragover = function(e) { onCritDragOver(e, item.id); };
                div.ondragleave = onCritDragLeave;
                div.ondrop = function(e) { onCritDrop(e, item.id); };
                div.innerHTML =
                    '<div class="rule-num">' + (idx + 1) + '</div>' +
                    '<div class="rule-body">' +
                        '<textarea class="rule-input" maxlength="500" placeholder="' + t('phCrit') + '" oninput="onCriterionInput(\'' + item.id + '\',this)">' + escapeHtml(item.text) + '</textarea>' +
                        '<div class="rule-char-count" id="count_' + item.id + '">' + item.text.length + '/500</div>' +
                    '</div>' +
                    '<div class="rule-actions">' +
                        '<button class="rule-action-btn rule-drag" draggable="true" ondragstart="onCritDragStart(event,\'' + item.id + '\')" ondragend="onCritDragEnd(event)" title="' + t('tipDrag') + '">' +
                            '<svg viewBox="0 0 24 24"><circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/><circle cx="9" cy="15" r="1.5"/><circle cx="15" cy="15" r="1.5"/><circle cx="9" cy="20" r="1.5"/><circle cx="15" cy="20" r="1.5"/></svg>' +
                        '</button>' +
                        '<button class="rule-action-btn" onclick="deleteCriterion(\'' + item.id + '\')" title="' + t('tipDelete') + '">' +
                            '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                        '</button>' +
                    '</div>';
                list.appendChild(div);
            });
        }

        // ===== GREETINGS (max 5, with audio) =====
        var botGreetings = [];
        var greetingIdCounter = 0;
        var GREETINGS_MAX = 5;

        function addGreeting() {
            if (botGreetings.length >= GREETINGS_MAX) return;
            greetingIdCounter++;
            botGreetings.push({ id: 'greet_' + greetingIdCounter, text: '' });
            renderGreetings();
            triggerAutoSave();
        }

        function deleteGreeting(id) {
            botGreetings = botGreetings.filter(function(r) { return r.id !== id; });
            renderGreetings();
            triggerAutoSave();
        }

        function onGreetingInput(id, textarea) {
            for (var i = 0; i < botGreetings.length; i++) {
                if (botGreetings[i].id === id) { botGreetings[i].text = textarea.value; break; }
            }
            var countEl = document.getElementById('count_' + id);
            if (countEl) countEl.textContent = textarea.value.length + '/500';
            triggerAutoSave();
        }

        var dragGreetId = null;
        function onGreetDragStart(e, id) {
            dragGreetId = id;
            e.currentTarget.closest('.rule-item').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function onGreetDragEnd(e) {
            dragGreetId = null;
            document.querySelectorAll('#greetingsList .rule-item').forEach(function(r) {
                r.classList.remove('dragging'); r.classList.remove('drag-over');
            });
        }
        function onGreetDragOver(e, id) {
            e.preventDefault();
            if (dragGreetId && dragGreetId !== id) e.currentTarget.classList.add('drag-over');
        }
        function onGreetDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function onGreetDrop(e, targetId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            if (!dragGreetId || dragGreetId === targetId) return;
            var fromIdx = botGreetings.findIndex(function(r) { return r.id === dragGreetId; });
            var toIdx = botGreetings.findIndex(function(r) { return r.id === targetId; });
            if (fromIdx === -1 || toIdx === -1) return;
            var moved = botGreetings.splice(fromIdx, 1)[0];
            botGreetings.splice(toIdx, 0, moved);
            renderGreetings();
            triggerAutoSave();
        }

        // ===== TTS ENGINE =====
        var ELEVENLABS_API_KEY = ''; // Set your key here or via setTTSKey()
        var ttsCache = {}; // { greetId: { text: string, blobUrl: string } }
        var ttsCurrentAudio = null;
        var ttsCurrentId = null;

        function setTTSKey(key) { ELEVENLABS_API_KEY = key; }

        function showTtsToast(msg) {
            var toast = document.getElementById('ttsToast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        function getTtsBtn(id) {
            return document.getElementById('ttsBtn_' + id);
        }

        function setTtsBtnState(id, state) {
            var btn = getTtsBtn(id);
            if (!btn) return;
            btn.classList.remove('loading', 'playing', 'disabled');
            if (state === 'loading') {
                btn.classList.add('loading');
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>';
            } else if (state === 'playing') {
                btn.classList.add('playing');
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>';
            } else {
                // idle
                var text = getGreetingText(id);
                if (!text.trim()) btn.classList.add('disabled');
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';
            }
        }

        function getGreetingText(id) {
            for (var i = 0; i < botGreetings.length; i++) {
                if (botGreetings[i].id === id) return botGreetings[i].text;
            }
            return '';
        }

        function stopTts() {
            if (ttsCurrentAudio) {
                ttsCurrentAudio.pause();
                ttsCurrentAudio.currentTime = 0;
                ttsCurrentAudio = null;
            }
            if (ttsCurrentId) {
                setTtsBtnState(ttsCurrentId, 'idle');
                ttsCurrentId = null;
            }
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
        }

        function playGreeting(id) {
            // If already playing this one  stop
            if (ttsCurrentId === id && ttsCurrentAudio) {
                stopTts();
                return;
            }
            // Stop any other playback
            stopTts();

            var text = getGreetingText(id);
            if (!text.trim()) return;

            // Check cache  if text matches, reuse blob
            if (ttsCache[id] && ttsCache[id].text === text && ttsCache[id].blobUrl) {
                playAudioBlob(id, ttsCache[id].blobUrl);
                return;
            }

            // If ElevenLabs key set  use API
            if (ELEVENLABS_API_KEY) {
                setTtsBtnState(id, 'loading');
                ttsCurrentId = id;
                fetchElevenLabs(id, text);
            } else {
                // Fallback: browser TTS
                playBrowserTts(id, text);
            }
        }

        function fetchElevenLabs(id, text) {
            var voiceId = 'EXAVITQu4vr4xnSDxMaL'; // Sarah  multilingual
            fetch('https://api.elevenlabs.io/v1/text-to-speech/' + voiceId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'xi-api-key': ELEVENLABS_API_KEY
                },
                body: JSON.stringify({
                    text: text,
                    model_id: 'eleven_multilingual_v2',
                    voice_settings: {
                        stability: 0.4,
                        similarity_boost: 0.75,
                        style: 0.35,
                        use_speaker_boost: true
                    }
                })
            })
            .then(function(res) {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.blob();
            })
            .then(function(blob) {
                // Revoke old cached URL
                if (ttsCache[id] && ttsCache[id].blobUrl) {
                    URL.revokeObjectURL(ttsCache[id].blobUrl);
                }
                var url = URL.createObjectURL(blob);
                ttsCache[id] = { text: text, blobUrl: url };
                if (ttsCurrentId === id) playAudioBlob(id, url);
            })
            .catch(function(err) {
                console.error('TTS error:', err);
                setTtsBtnState(id, 'idle');
                ttsCurrentId = null;
                showTtsToast(t('ttsFail'));
            });
        }

        function playAudioBlob(id, blobUrl) {
            var audio = new Audio(blobUrl);
            ttsCurrentAudio = audio;
            ttsCurrentId = id;
            setTtsBtnState(id, 'playing');
            audio.play().catch(function() {
                setTtsBtnState(id, 'idle');
                ttsCurrentId = null;
                showTtsToast(t('ttsPlayFail'));
            });
            audio.onended = function() {
                setTtsBtnState(id, 'idle');
                ttsCurrentAudio = null;
                ttsCurrentId = null;
            };
        }

        function playBrowserTts(id, text) {
            if (!('speechSynthesis' in window)) {
                showTtsToast(t('ttsNoSupport'));
                return;
            }
            ttsCurrentId = id;
            setTtsBtnState(id, 'playing');
            var utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'ru-RU';
            utter.onend = function() {
                setTtsBtnState(id, 'idle');
                ttsCurrentId = null;
            };
            utter.onerror = function() {
                setTtsBtnState(id, 'idle');
                ttsCurrentId = null;
            };
            window.speechSynthesis.speak(utter);
        }

        // Invalidate cache when greeting text changes
        var origOnGreetingInput = onGreetingInput;
        onGreetingInput = function(id, textarea) {
            origOnGreetingInput(id, textarea);
            if (ttsCache[id] && ttsCache[id].text !== textarea.value) {
                if (ttsCache[id].blobUrl) URL.revokeObjectURL(ttsCache[id].blobUrl);
                delete ttsCache[id];
            }
            // Update disabled state of audio btn
            var btn = getTtsBtn(id);
            if (btn && !btn.classList.contains('loading') && !btn.classList.contains('playing')) {
                if (textarea.value.trim()) btn.classList.remove('disabled');
                else btn.classList.add('disabled');
            }
        };

        function renderGreetings() {
            var list = document.getElementById('greetingsList');
            list.innerHTML = '';
            botGreetings.forEach(function(item, idx) {
                var isEmpty = !item.text.trim();
                var isPlaying = ttsCurrentId === item.id && ttsCurrentAudio;
                var disabledClass = isEmpty && !isPlaying ? ' disabled' : '';
                var div = document.createElement('div');
                div.className = 'rule-item';
                div.ondragover = function(e) { onGreetDragOver(e, item.id); };
                div.ondragleave = onGreetDragLeave;
                div.ondrop = function(e) { onGreetDrop(e, item.id); };
                div.innerHTML =
                    '<div class="rule-num">' + (idx + 1) + '</div>' +
                    '<div class="rule-body">' +
                        '<textarea class="rule-input" maxlength="500" placeholder="' + t('phGreet') + '" oninput="onGreetingInput(\'' + item.id + '\',this)">' + escapeHtml(item.text) + '</textarea>' +
                        '<div class="rule-char-count" id="count_' + item.id + '">' + item.text.length + '/500</div>' +
                    '</div>' +
                    '<div class="rule-actions">' +
                        '<button class="rule-audio-btn' + disabledClass + '" id="ttsBtn_' + item.id + '" onclick="playGreeting(\'' + item.id + '\')" title="' + t('tipListen') + '">' +
                            '<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>' +
                        '</button>' +
                        '<button class="rule-action-btn rule-drag" draggable="true" ondragstart="onGreetDragStart(event,\'' + item.id + '\')" ondragend="onGreetDragEnd(event)" title="' + t('tipDrag') + '">' +
                            '<svg viewBox="0 0 24 24"><circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/><circle cx="9" cy="15" r="1.5"/><circle cx="15" cy="15" r="1.5"/><circle cx="9" cy="20" r="1.5"/><circle cx="15" cy="20" r="1.5"/></svg>' +
                        '</button>' +
                        '<button class="rule-action-btn" onclick="deleteGreeting(\'' + item.id + '\')" title="' + t('tipDelete') + '">' +
                            '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                        '</button>' +
                    '</div>';
                list.appendChild(div);
            });
            // Toggle add button
            var btn = document.getElementById('addGreetingBtn');
            if (botGreetings.length >= GREETINGS_MAX) {
                btn.classList.add('disabled');
            } else {
                btn.classList.remove('disabled');
            }
        }

        // ===== PLAN ITEMS =====
        var botPlanItems = [];
        var planIdCounter = 0;

        function addPlanItem() {
            planIdCounter++;
            botPlanItems.push({ id: 'plan_' + planIdCounter, text: '' });
            renderPlanItems();
            triggerAutoSave();
        }

        function deletePlanItem(id) {
            botPlanItems = botPlanItems.filter(function(r) { return r.id !== id; });
            renderPlanItems();
            triggerAutoSave();
        }

        function onPlanItemInput(id, textarea) {
            for (var i = 0; i < botPlanItems.length; i++) {
                if (botPlanItems[i].id === id) { botPlanItems[i].text = textarea.value; break; }
            }
            var countEl = document.getElementById('count_' + id);
            if (countEl) countEl.textContent = textarea.value.length + '/500';
            triggerAutoSave();
        }

        var dragPlanId = null;
        function onPlanDragStart(e, id) {
            dragPlanId = id;
            e.currentTarget.closest('.rule-item').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function onPlanDragEnd(e) {
            dragPlanId = null;
            document.querySelectorAll('#planItemsList .rule-item').forEach(function(r) {
                r.classList.remove('dragging'); r.classList.remove('drag-over');
            });
        }
        function onPlanDragOver(e, id) {
            e.preventDefault();
            if (dragPlanId && dragPlanId !== id) e.currentTarget.classList.add('drag-over');
        }
        function onPlanDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function onPlanDrop(e, targetId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            if (!dragPlanId || dragPlanId === targetId) return;
            var fromIdx = botPlanItems.findIndex(function(r) { return r.id === dragPlanId; });
            var toIdx = botPlanItems.findIndex(function(r) { return r.id === targetId; });
            if (fromIdx === -1 || toIdx === -1) return;
            var moved = botPlanItems.splice(fromIdx, 1)[0];
            botPlanItems.splice(toIdx, 0, moved);
            renderPlanItems();
            triggerAutoSave();
        }

        function renderPlanItems() {
            var list = document.getElementById('planItemsList');
            list.innerHTML = '';
            botPlanItems.forEach(function(item, idx) {
                var div = document.createElement('div');
                div.className = 'rule-item';
                div.ondragover = function(e) { onPlanDragOver(e, item.id); };
                div.ondragleave = onPlanDragLeave;
                div.ondrop = function(e) { onPlanDrop(e, item.id); };
                div.innerHTML =
                    '<div class="rule-num">' + (idx + 1) + '</div>' +
                    '<div class="rule-body">' +
                        '<textarea class="rule-input" maxlength="500" placeholder="' + t('phPlanItem') + '" oninput="onPlanItemInput(\'' + item.id + '\',this)">' + escapeHtml(item.text) + '</textarea>' +
                        '<div class="rule-char-count" id="count_' + item.id + '">' + item.text.length + '/500</div>' +
                    '</div>' +
                    '<div class="rule-actions">' +
                        '<button class="rule-action-btn rule-drag" draggable="true" ondragstart="onPlanDragStart(event,\'' + item.id + '\')" ondragend="onPlanDragEnd(event)" title="' + t('tipDrag') + '">' +
                            '<svg viewBox="0 0 24 24"><circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/><circle cx="9" cy="15" r="1.5"/><circle cx="15" cy="15" r="1.5"/><circle cx="9" cy="20" r="1.5"/><circle cx="15" cy="20" r="1.5"/></svg>' +
                        '</button>' +
                        '<button class="rule-action-btn" onclick="deletePlanItem(\'' + item.id + '\')" title="' + t('tipDelete') + '">' +
                            '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                        '</button>' +
                    '</div>';
                list.appendChild(div);
            });
        }

        // ===== i18n =====
        var currentLang = localStorage.getItem('lang') || 'ru';

        var i18n = {
            // Landing nav
            about: { ru:' ', en:'About Us' },
            tech: { ru:'', en:'Technology' },
            contacts: { ru:'', en:'Contacts' },
            login: { ru:'', en:'Sign In' },
            // Hero
            heroBadge: { ru:'  ', en:'Next-Generation Platform' },
            heroTitle: { ru:'   <br>  <br> <span>AI</span>', en:'Fast and Easy Launch<br>of Your Sales Department<br>with <span>AI</span>' },
            requestAccess: { ru:' ', en:'Request Access' },
            // Features
            featLabel: { ru:'', en:'Capabilities' },
            featTitle: { ru:' ', en:'Complete Solution' },
            f1t: { ru:'AI-', en:'AI Telemarketer' },
            f1d: { ru:'    .  24/7,  ,       .', en:'Intelligent assistant for automating outbound calls. Works 24/7, never gets tired, never makes mistakes, and adapts to each customer.' },
            f2t: { ru:' ', en:'Integrated Telephony' },
            f2d: { ru:'     .', en:'Reliable telephony providers for uninterrupted communication.' },
            f3t: { ru:'  ', en:'Up-to-Date Databases' },
            f3d: { ru:'        ', en:'We\'ll build a call list for you and make calls to it' },
            f4t: { ru:'CRM-', en:'CRM Integrations' },
            f4d: { ru:'    CRM-.', en:'Seamless synchronization with your CRM systems.' },
            f5t: { ru:' ', en:'Ready-Made Templates' },
            f5d: { ru:'       .', en:'Customizable templates for various niches for a quick start.' },
            f6t: { ru:' ', en:'Quick Setup' },
            f6d: { ru:'   2-5 .', en:'Launch a campaign in 2-5 minutes.' },
            f7t: { ru:' ', en:'Quick Lead' },
            f7d: { ru:' ,          .', en:'Choose a template, configure the call, and get warm leads the next day.' },
            // Steps
            stepsLabel: { ru:'', en:'Process' },
            stepsTitle: { ru:'  ?', en:'How It Works?' },
            stepsDesc: { ru:'     4 ', en:'From Idea to Lead in 4 Steps' },
            s1t: { ru:'', en:'Registration' },
            s1d: { ru:'   30 ', en:'Create an account in 30 seconds' },
            s2t: { ru:' ', en:'Choose Your Niche' },
            s2d: { ru:'   ', en:'Specify your business field' },
            s3t: { ru:' ', en:'Goal Setup' },
            s3d: { ru:'  ', en:'Define campaign parameters' },
            s4t: { ru:' ', en:'Start Calls' },
            s4d: { ru:'AI   ', en:'AI will start attracting customers' },
            // Access modal
            accessTitle: { ru:' ', en:'Request Access' },
            accessSub: { ru:'      ', en:'Fill in the details and we\'ll contact you' },
            innLabel: { ru:' ', en:'Company TIN' },
            fioLabel: { ru:'', en:'Full Name' },
            phoneLabel: { ru:' ', en:'Phone Number' },
            getAccess: { ru:' ', en:'Get Access' },
            accessOk: { ru:' !', en:'Application Submitted!' },
            accessOkDesc: { ru:'   <br>  15 ', en:'We\'ll contact you<br>within 15 minutes' },
            // Login modal
            loginTitle: { ru:'', en:'Sign In' },
            loginSub: { ru:'   ', en:'Enter username and password' },
            loginLabel: { ru:'', en:'Username' },
            passLabel: { ru:'', en:'Password' },
            loginBtn: { ru:'', en:'Sign In' },
            loginErr: { ru:'   ', en:'Invalid username or password' },
            orText: { ru:'', en:'or' },
            googleBtn: { ru:'  Google', en:'Sign in with Google' },
            // Onboarding step 1
            onb1title: { ru:'  ', en:'Choose Your Niche' },
            onb1sub: { ru:'      ', en:'This will help configure the platform for your business' },
            next: { ru:'', en:'Next' },
            back: { ru:'', en:'Back' },
            niche1: { ru:'', en:'Finance' },
            niche2: { ru:'   HR', en:'Recruitment & HR' },
            niche3: { ru:'  -', en:'Education & Online Schools' },
            niche4: { ru:'', en:'Real Estate' },
            niche5: { ru:' ', en:'Medical Organizations' },
            niche6: { ru:' ', en:'Beauty Services' },
            niche7: { ru:' ', en:'Legal Services' },
            niche8: { ru:' ', en:'Event Planning' },
            niche9: { ru:' ', en:'Sports Facilities' },
            niche10: { ru:'B2B ', en:'B2B Solutions' },
            niche11: { ru:'', en:'Arbitrage' },
            niche12: { ru:' ', en:'Logistics Company' },
            niche13: { ru:'  ', en:'Debt Collection' },
            niche14: { ru:'   ', en:'Housing & Utilities' },
            niche15: { ru:'-', en:'Online Store' },
            niche16: { ru:' ', en:'Insurance Companies' },
            niche17: { ru:'', en:'Tourism' },
            niche18: { ru:' ', en:'Other Niche' },
            // Onboarding step 2
            onb2title: { ru:' ', en:'Target Audience' },
            onb2sub: { ru:'    ', en:'Help us understand your customers' },
            onb2sitesLabel: { ru:'  3  10     ', en:'Specify 3 to 10 competitor or related company websites' },
            onb2clientLabel: { ru:'   ', en:'Describe your ideal customer' },
            onb2hint: { ru:'    ', en:'One website per line' },
            onb2tagsLabel: { ru:'       :', en:'Quick tags  click or drag into the description:' },
            tag1: { ru:' ', en:'Business Owner' },
            tag2: { ru:'', en:'Decision Maker' },
            tag3: { ru:'B2B ', en:'B2B Client' },
            tag4: { ru:' ', en:'Small Business' },
            tag5: { ru:' ', en:'Medium Business' },
            tag6: { ru:' ', en:'Large Business' },
            tag7: { ru:' ', en:'Individual' },
            tag8: { ru:'25-35 ', en:'25-35 y.o.' },
            tag9: { ru:'35-50 ', en:'35-50 y.o.' },
            tag10: { ru:'50+ ', en:'50+ y.o.' },
            tag11: { ru:' ', en:'High Income' },
            tag12: { ru:' ', en:'Medium Income' },
            tag13: { ru:' ', en:'Looking for Contractor' },
            tag14: { ru:' ', en:'Wants to Save' },
            tag15: { ru:' ', en:'Needs it Fast' },
            tag16: { ru:': ', en:'Region: Moscow' },
            tag17: { ru:':  ', en:'Region: All Russia' },
            tag18: { ru:' ', en:'New Customer' },
            // Onboarding step 3
            onb3title: { ru:'  ', en:'About Your Company' },
            onb3sub: { ru:'   AI          ,   ', en:'We\'re already training AI on your sales  fill in this info so it knows everything about you' },
            onb3name: { ru:'  ', en:'Short Company Name' },
            onb3loc: { ru:'  ', en:'Company Location' },
            onb3site: { ru:'  ', en:'Website URL' },
            onb3prod: { ru:'   / ', en:'Main Product / Service' },
            onb3utp: { ru:' (  )', en:'USP (Unique Selling Proposition)' },
            onb3info: { ru:',       ', en:'Everything we need to know about your company' },
            fillLater: { ru:' ', en:'Fill Later' },
            // Dashboard
            menu: { ru:'', en:'Menu' },
            dashboard: { ru:' ', en:'Dashboard' },
            logout: { ru:'', en:'Logout' },
            navMain: { ru:'', en:'Main' },
            navStats: { ru:'', en:'Statistics' },
            navSkills: { ru:'', en:'Skill Bases' },
            navKb: { ru:' ', en:'Knowledge Base' },
            navCalls: { ru:'-', en:'Call Lists' },
            navHistory: { ru:' ', en:'Call History' },
            navTemplates: { ru:'', en:'Templates' },
            navSettings: { ru:'', en:'Settings' },
            // Page stubs
            pStatsT: { ru:'', en:'Statistics' },
            pStatsSub: { ru:'  ', en:'Analytics and Reports' },
            pSkillsT: { ru:'', en:'Skill Bases' },
            pSkillsSub: { ru:'    ', en:'Manage skill bases and scenarios' },
            pKbT: { ru:' ', en:'Knowledge Base' },
            pKbSub: { ru:'  ', en:'Documents and Materials' },
            pCallsT: { ru:'-', en:'Call Lists' },
            pCallsSub: { ru:'   ', en:'Manage call lists' },
            pHistT: { ru:' ', en:'Call History' },
            pHistSub: { ru:'  ', en:'Log of all calls' },
            pTplT: { ru:'', en:'Templates' },
            pTplSub: { ru:'   ', en:'Ready-made scripts and templates' },
            pSetT: { ru:'', en:'Settings' },
            pSetSub: { ru:' ', en:'System Settings' },
            stub: { ru:'  ', en:'Section under development' },
            // Skill cards
            sk1t: { ru:' B2B', en:'B2B Sales' },
            sk1d: { ru:'     ', en:'Cold calling scripts for corporate clients' },
            sk2t: { ru:' L1', en:'Tech Support L1' },
            sk2d: { ru:'    ', en:'Basic first-line support scripts' },
            sk3t: { ru:'', en:'Onboarding' },
            sk3d: { ru:'    ', en:'Scripts for onboarding new employees' },
            sk4t: { ru:' NPS', en:'NPS Surveys' },
            sk4d: { ru:'    ', en:'Scripts for measuring customer satisfaction' },
            skActive: { ru:'', en:'Active' },
            skDraft: { ru:'', en:'Draft' },
            skNew: { ru:'', en:'New' },
            // Bot config
            botUpdated: { ru:' :  ', en:'Last updated: just now' },
            saved: { ru:'', en:'Saved' },
            saving: { ru:'...', en:'Saving...' },
            tabContext: { ru:'', en:'Context' },
            tabPlan: { ru:' ', en:'Conversation Plan' },
            tabKb: { ru:' ', en:'Knowledge Base' },
            roleTitle: { ru:' ', en:'Seller Role' },
            roleDesc: { ru:' ,        ', en:'Describe the role the AI bot will play when calling leads' },
            styleTitle: { ru:' ', en:'Speech Style' },
            styleDesc: { ru:'      ', en:'Define the AI bot\'s communication style with leads' },
            rulesTitle: { ru:' ', en:'Important Rules' },
            rulesDesc: { ru:' ,       ', en:'Specify rules the AI bot must follow during calls' },
            factsTitle: { ru:'  ', en:'Arguments and Facts' },
            factsDesc: { ru:'    ,      ', en:'Specify key arguments and facts the bot can use in conversation' },
            critTitle: { ru:'  ', en:'Lead Transfer Criteria' },
            critDesc: { ru:' ,      ', en:'Define conditions for transferring a lead to a manager' },
            addRule: { ru:'  ', en:'Add new rule' },
            addFact: { ru:'  ', en:'Add new fact' },
            addCrit: { ru:'  ', en:'Add new criterion' },
            greetTitle: { ru:' ', en:'Conversation Start' },
            greetDesc: { ru:' ,       ', en:'Pre-recorded phrases the AI bot will say at the start of the call' },
            important: { ru:'!', en:'Important!' },
            greetTooltip: { ru:'             ', en:'These phrases will be played as pre-recorded audio at the start of the call for maximum natural sound' },
            addGreeting: { ru:'   ( 5)', en:'Add new answer (max 5)' },
            planTitle: { ru:' ', en:'Conversation Plan' },
            planDesc: { ru:'  ,       ', en:'Define the sequence of topics the AI bot should discuss with a lead' },
            addPlan: { ru:'  ', en:'Add new item' },
            // Tooltips
            tipDrag: { ru:'', en:'Drag' },
            tipDelete: { ru:'', en:'Delete' },
            tipListen: { ru:'', en:'Listen' },
            // Placeholders
            phRule: { ru:' ...', en:'Enter rule...' },
            phFact: { ru:'   ...', en:'Enter fact or argument...' },
            phCrit: { ru:'  ...', en:'Enter transfer criterion...' },
            phGreet: { ru:'  ...', en:'Enter greeting phrase...' },
            phPlanItem: { ru:'   ...', en:'Enter discussion topic...' },
            phRole: { ru:' ', en:'Seller Role' },
            phStyle: { ru:' ', en:'Speech Style' },
            phNiche: { ru:'   ...', en:'Enter your niche name...' },
            phInn: { ru:'10  12 ', en:'10 or 12 digits' },
            phFio: { ru:'  ', en:'John Smith' },
            phPhone: { ru:'+7 (999) 123-45-67', en:'+1 (555) 123-4567' },
            phLogin: { ru:' ', en:'Enter username' },
            phPass: { ru:' ', en:'Enter password' },
            phSites: { ru:':\ncompetitor1.ru\ncompetitor2.com\nsimilar-company.ru', en:'Example:\ncompetitor1.com\ncompetitor2.com\nsimilar-company.com' },
            phClient: { ru:':   , 30-50 ,    ...', en:'Example: small business owner, 30-50 years old, looking for ways to increase sales...' },
            phCompName: { ru:': ', en:'Example: BuildMaster' },
            phCompLoc: { ru:': , ', en:'Example: New York, USA' },
            phCompSite: { ru:': company.ru', en:'Example: company.com' },
            phCompProd: { ru:':   ', en:'Example: construction of country houses' },
            phCompUtp: { ru:':    30    ', en:'Example: build a house in 30 days or money back' },
            phCompInfo: { ru:'      : , , ,  ,  ...', en:'Tell us everything important: history, values, advantages, specifics, target audience...' },
            // Toasts
            ttsFail: { ru:'   ', en:'Failed to vocalize phrase' },
            ttsPlayFail: { ru:'   ', en:'Failed to play audio' },
            ttsNoSupport: { ru:'   ', en:'Browser does not support text-to-speech' },
            // Validation
            valInn: { ru:'   10  12 ', en:'TIN must contain 10 or 12 digits' },
            valName: { ru:'  ( )', en:'Enter name (letters only)' },
            valPhone: { ru:'   ', en:'Enter a valid phone number' },
            // Dialog list
            dlgListTitle: { ru:'', en:'Dialogs' },
            dlgCreate: { ru:' ', en:'Create Dialog' },
            dlgQuickStart: { ru:' ', en:'Thorough Start' },
            dlgQuickStartName: { ru:' ', en:'New Dialog' },
            dlgTemplate: { ru:' ', en:'Choose template' },
            dlgColName: { ru:'', en:'Name' },
            dlgColCreated: { ru:'', en:'Created' },
            dlgColUpdated: { ru:'', en:'Updated' },
            dlgBack: { ru:'', en:'Back' },
            dlgCreateTitle: { ru:' ', en:'New Dialog' },
            dlgCreateSub: { ru:'    ', en:'Enter a name for the new dialog' },
            dlgNameLabel: { ru:'', en:'Name' },
            phDlgName: { ru:':  B2B', en:'Example: B2B Sales' },
            dlgCreateBtn: { ru:'', en:'Create' },
            dlgCancelBtn: { ru:'', en:'Cancel' },
            dlgDeleteTitle: { ru:' ?', en:'Delete dialog?' },
            dlgDeleteConfirm: { ru:'   .     .', en:'This action cannot be undone. All dialog data will be lost.' },
            dlgDeleteBtn: { ru:'', en:'Delete' },
            dlgRename: { ru:'', en:'Rename' },
            dlgClone: { ru:'', en:'Duplicate' },
            dlgDelete: { ru:'', en:'Delete' },
            dlgCopySuffix: { ru:'()', en:'(copy)' },
            dlgEmpty: { ru:' .  !', en:'No dialogs yet. Create your first one!' },
            tipMore: { ru:'', en:'Actions' },

            // Quick Start Wizard
            qsTitle: { ru:' ', en:'Quick Start' },
            qsSub: { ru:'        ', en:'Answer the questions  we\'ll set up the dialog for you' },
            qsNext: { ru:'', en:'Next' },
            qsBack: { ru:'', en:'Back' },
            qsSkip: { ru:'', en:'Skip' },
            qsFinishBtn: { ru:' ', en:'Create dialog' },
            // Step 1
            qsWhatSell: { ru:'  ?', en:'What do you sell?' },
            qsWhoTarget: { ru:'  ?', en:'Who is your target audience?' },
            qsAdvantages: { ru:' ', en:'Key advantages' },
            qsAfterCall: { ru:'    ?', en:'What should happen after the call?' },
            qsAfterMeeting: { ru:'  / ', en:'Schedule a meeting' },
            qsAfterRequest: { ru:' ', en:'Submit a request' },
            qsAfterKP: { ru:' ', en:'Send a proposal' },
            qsAfterOther: { ru:'', en:'Other' },
            phQsAfterOther: { ru:'     ', en:'Describe what should happen after the call' },
            phQsWhatSell: { ru:': CRM-   ', en:'E.g.: CRM system for sales automation' },
            phQsWhoTarget: { ru:':    ,  ', en:'E.g.: small and medium businesses, sales teams' },
            phQsAdvantages: { ru:'      ', en:'List separated by commas or new lines' },
            // Step 2
            qsGreetings: { ru:'  ', en:'Manager opening phrases' },
            qsPitch: { ru:':  ', en:'Pitch: key points' },
            qsClosing: { ru:':   ', en:'Closing: how to wrap up' },
            phQsGreetings: { ru:'    (    )', en:'How the manager starts the conversation (each phrase on a new line)' },
            phQsPitch: { ru:'   (   )', en:'Key sales points (each on a new line)' },
            phQsClosing: { ru:'       ', en:'Phrases for closing and converting to target action' },
            // Step 3
            qsRecordings: { ru:'   ()', en:'Upload call recordings (optional)' },
            qsDragDrop: { ru:'      ', en:'Drag files here or click to select' },
            qsFileTypes: { ru:'MP3, WAV, OGG   25  ', en:'MP3, WAV, OGG  up to 25 MB each' },
            // Step 4
            qsProductLine: { ru:'  / ', en:'Product line / pricing plans' },
            qsMinConditions: { ru:'  ', en:'Minimum deal conditions' },
            qsFactsFigures: { ru:'    ', en:'Product facts and figures' },
            phQsProductLine: { ru:' , , ', en:'Describe products, plans, packages' },
            phQsMinConditions: { ru:' , ,   ..', en:'Minimum check, term, quantity, etc.' },
            phQsFactsFigures: { ru:', , ', en:'Statistics, case studies, achievements' },
            // Step 5
            qsGoal: { ru:' ', en:'Call objective' },
            qsGoalMeeting: { ru:'  / ', en:'Schedule a meeting' },
            qsGoalQualify: { ru:' ', en:'Qualify the lead' },
            qsGoalSell: { ru:'  / ', en:'Sell a product / service' },
            qsGoalOther: { ru:'', en:'Other' },
            qsCollectFields: { ru:'    ?', en:'What data to collect from the client?' },
            phQsGoalOther: { ru:'  ', en:'Describe the call objective' },
            phQsCollectFields: { ru:', , ,   ..', en:'Name, company, budget, timeline, etc.' },
            // Step 6
            qsForbidden: { ru:'  ?', en:'What is forbidden to say?' },
            qsNoPromise: { ru:'   ?', en:'What not to promise the client?' },
            qsTerms: { ru:'   ', en:'Special terms and abbreviations' },
            phQsForbidden: { ru:', ,    ', en:'Topics, words, phrases to avoid' },
            phQsNoPromise: { ru:', ,    ', en:'Discounts, deadlines, guarantees that cannot be promised' },
            phQsTerms: { ru:'      ', en:'Terms the robot should know and use' },
            // Step 7
            qsDialogName: { ru:'  ?', en:'What shall we name the dialog?' },
            phQsDialogName: { ru:':  CRM  B2B', en:'E.g.: CRM Sales for B2B' },
            // Dialog completeness & status
            dlgReady: { ru:'  ', en:'Ready for calls' },
            dlgAlmost: { ru:'     ', en:'Almost ready  fill remaining fields' },
            dlgFillMore: { ru:'    ', en:'Fill dialog to start calls' },
            dlgActive: { ru:'', en:'Active' },
            dlgInactive: { ru:' ', en:'Inactive' },
            dlgColStatus: { ru:'', en:'Status' },
            dlgFillToActivate: { ru:'    ', en:'Fill all fields to activate' },
            dlgMenuTitle: { ru:'', en:'Manage' },
            // Stats Dialog Picker
            stDlgAll: { ru:' ', en:'All dialogs' },
            stDlgPick: { ru:' ', en:'Choose dialog' },
            // Support Chat
            scTitle: { ru:'', en:'Support' },
            scStatus: { ru:' ', en:' online' },
            scPlaceholder: { ru:' ...', en:'Type a message...' },
            scWelcome: { ru:'!   ?', en:'Hello! How can we help?' },
            scAutoReply: { ru:',   .   .', en:'Thank you, your message has been received. We will reply soon.' },
            scFileTooLarge: { ru:'   (. 10 )', en:'File is too large (max 10 MB)' },
            // Management modal
            mgmtTitle: { ru:'', en:'Management' },
            mgmtSchedule: { ru:' ', en:'Working hours' },
            mgmtFrom: { ru:'', en:'from' },
            mgmtTo: { ru:'', en:'' },
            mgmtTz: { ru:' ', en:'Time zone' },
            mgmtTzLabel: { ru:'   ', en:'Use client time zone' },
            mgmtContactLimit: { ru:'  .   ', en:'Qualified leads per day' },
            mgmtMaxCallSec: { ru:'.   ()', en:'Max call duration (sec)' },
            mgmtSave: { ru:'', en:'Save' },
            mgmtMon: { ru:'', en:'Mo' },
            mgmtTue: { ru:'', en:'Tu' },
            mgmtWed: { ru:'', en:'We' },
            mgmtThu: { ru:'', en:'Th' },
            mgmtFri: { ru:'', en:'Fr' },
            mgmtSat: { ru:'', en:'Sa' },
            mgmtSun: { ru:'', en:'Su' },
            mgmtMenu: { ru:'', en:'Settings' },
            // Settings page
            setAudT: { ru:' ', en:'Target Audience' },
            setAudD: { ru:'    ,   ', en:'Configure your ideal client profile, niche, and competitors' },
            setAudModalSub: { ru:'   ', en:'Configure target audience parameters' },
            setAudNiche: { ru:'', en:'Niche' },
            setAudClient: { ru:'  ', en:'Ideal Client Description' },
            setAudTags: { ru:' ', en:'Quick select' },
            setAudSites: { ru:'  ( 10,    )', en:'Competitor websites (up to 10, one per line)' },
            setAudSave: { ru:'', en:'Save' },
            setAudMaxSites: { ru:' 10  ', en:'Maximum 10 competitor websites' },
            setCompT: { ru:' ', en:'Company Settings' },
            setCompD: { ru:'  ,   ', en:'Company info, details, and contract' },
            setCompModalSub: { ru:'   ', en:'Your company information' },
            setCompName: { ru:' ', en:'Company Name' },
            setCompLoc: { ru:'', en:'Location' },
            setCompSite: { ru:'', en:'Website' },
            setCompProd: { ru:' ', en:'Main Product' },
            setCompUtp: { ru:'', en:'USP' },
            setCompInfo: { ru:' ', en:'About Company' },
            setCompInn: { ru:'', en:'Tax ID' },
            setCompPerson: { ru:' ', en:'Contact Person' },
            setCompPersonPh: { ru:'  ', en:'Full name of contact person' },
            setCompReq: { ru:'', en:'Bank Details' },
            setCompReqPh: { ru:'  ...', en:'Company bank details...' },
            setCompContract: { ru:'   ', en:'Service Agreement' },
            setCompDownload: { ru:' ', en:'Download contract' },
            setCompSave: { ru:'', en:'Save' },
            setBtn: { ru:'', en:'Configure' },
            setTarT: { ru:'  ', en:'Plan & Balance' },
            setTarD: { ru:'     ', en:'Current plan and company balance' },
            setTarPlan: { ru:' ', en:'Current Plan' },
            setTarBal: { ru:'', en:'Balance' },
            // Templates
            tpl1t: { ru:'    ', en:'Friendly  close for a meeting' },
            tpl1d: { ru:'     .    ,         .', en:'Warm call to schedule a meeting. Anya is a friendly manager who gently leads the conversation and closes on a specific date.' },
            tpl2t: { ru:'   ', en:'Business  lead qualification' },
            tpl2d: { ru:'     .  ,  ,    .', en:'Structured call to assess client potential. Clear questions, fast qualification, focus on key criteria.' },
            tpl3t: { ru:'   ', en:'Soft  needs discovery' },
            tpl3d: { ru:'       .   ,    .', en:'Delicate conversation to uncover client pain points and tasks. Focus on listening, empathy, and targeted questions.' },
            tplSelect: { ru:'', en:'Select' },
            tplReview: { ru:'  ', en:'Review template' },
            tplComingSoon: { ru:'  ', en:'Template in development' },
            tplAudioPlaceholder: { ru:'-', en:'Audio preview' },
            tplCreateTitle: { ru:'  ', en:'Create your template' },
            tplCreateDesc: { ru:' ,  ,       ', en:'Set up the role, speech style, rules and conversation plan for your tasks' },
            tplCreateSub: { ru:'       ', en:'Fill in the fields  you can reuse the template' },
            tplFieldName: { ru:' ', en:'Template name' },
            tplFieldDesc: { ru:'', en:'Description' },
            tplSaveBtn: { ru:' ', en:'Save template' },
            tplEditBtn: { ru:'', en:'Edit' },
            tplDeleteBtn: { ru:'', en:'Delete' },
        };

        function t(key) {
            var entry = i18n[key];
            if (!entry) return key;
            return entry[currentLang] || entry.ru;
        }

        function switchLang() {
            currentLang = currentLang === 'ru' ? 'en' : 'ru';
            localStorage.setItem('lang', currentLang);
            applyLang();
        }

        function applyLang() {
            var label = currentLang === 'ru' ? 'EN' : 'RU';
            document.getElementById('landLangBtn').textContent = label;
            document.getElementById('sidebarLangBtn').textContent = label;

            // data-i18n text
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                var key = el.getAttribute('data-i18n');
                if (i18n[key]) el.textContent = i18n[key][currentLang];
            });
            // data-i18n-html (innerHTML)
            document.querySelectorAll('[data-i18n-html]').forEach(function(el) {
                var key = el.getAttribute('data-i18n-html');
                if (i18n[key]) el.innerHTML = i18n[key][currentLang];
            });
            // data-i18n-ph (placeholder)
            document.querySelectorAll('[data-i18n-ph]').forEach(function(el) {
                var key = el.getAttribute('data-i18n-ph');
                if (i18n[key]) el.placeholder = i18n[key][currentLang];
            });

            // Re-render dynamic lists with correct placeholders
            renderRules();
            renderFacts();
            renderCriteria();
            renderGreetings();
            renderPlanItems();
            renderDialogTable();
        }

        // Init with one example dialog
        (function() {
            var exDlg = createDialogObject('     ');
            exDlg.rules.push({ id: 'rule_init1', text: '' });
            exDlg.facts.push({ id: 'fact_init1', text: '' });
            exDlg.criteria.push({ id: 'crit_init1', text: '' });
            exDlg.greetings.push({ id: 'greet_init1', text: '' });
            exDlg.planItems.push({ id: 'plan_init1', text: '' });
            dialogs.push(exDlg);
            renderDialogTable();
        })();

        // Apply saved language on load
        if (currentLang === 'en') applyLang();

        function toggleTheme() {
            document.body.classList.toggle('light');
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
        }

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
        }

        // Access modal
        const accessModal = document.getElementById('accessModal');
        const accessForm = document.getElementById('accessForm');
        const accessSuccess = document.getElementById('accessSuccess');
        const accessSubmitBtn = document.getElementById('accessSubmitBtn');

        function openAccessModal() {
            accessModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            accessForm.style.display = '';
            accessSuccess.classList.remove('show');
            document.getElementById('accInn').value = '';
            document.getElementById('accName').value = '';
            document.getElementById('accPhone').value = '';
            accessSubmitBtn.classList.remove('active');
            document.querySelectorAll('.field-hint').forEach(h => h.classList.remove('show'));
            document.querySelectorAll('#accessForm input').forEach(i => i.classList.remove('error'));
        }

        function closeAccessModal() {
            accessModal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function closeAccessOnOverlay(e) {
            if (e.target === accessModal) closeAccessModal();
        }

        function validateInn(v) {
            const digits = v.replace(/\D/g, '');
            return digits.length === 10 || digits.length === 12;
        }

        function validateName(v) {
            return v.trim().length >= 2 && /^[--a-zA-Z\s-]+$/.test(v.trim());
        }

        function validatePhone(v) {
            const digits = v.replace(/\D/g, '');
            return digits.length >= 10 && digits.length <= 12;
        }

        function showHint(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.classList.add('show');
        }

        function hideHint(id) {
            document.getElementById(id).classList.remove('show');
        }

        function checkAccessForm() {
            const inn = document.getElementById('accInn').value.trim();
            const name = document.getElementById('accName').value.trim();
            const phone = document.getElementById('accPhone').value.trim();

            const innOk = validateInn(inn);
            const nameOk = validateName(name);
            const phoneOk = validatePhone(phone);

            // Live hints
            if (inn && !innOk) { showHint('hintInn', t('valInn')); }
            else { hideHint('hintInn'); }

            if (name && !nameOk) { showHint('hintName', t('valName')); }
            else { hideHint('hintName'); }

            if (phone && !phoneOk) { showHint('hintPhone', t('valPhone')); }
            else { hideHint('hintPhone'); }

            // Inputs error styling
            document.getElementById('accInn').classList.toggle('error', inn !== '' && !innOk);
            document.getElementById('accName').classList.toggle('error', name !== '' && !nameOk);
            document.getElementById('accPhone').classList.toggle('error', phone !== '' && !phoneOk);

            if (innOk && nameOk && phoneOk) {
                accessSubmitBtn.classList.add('active');
            } else {
                accessSubmitBtn.classList.remove('active');
            }
        }

        function submitAccess() {
            const inn = document.getElementById('accInn').value.trim();
            const name = document.getElementById('accName').value.trim();
            const phone = document.getElementById('accPhone').value.trim();

            let valid = true;

            if (!inn) { showHint('hintInn', '  '); valid = false; }
            else if (!validateInn(inn)) { showHint('hintInn', '   10  12 '); valid = false; }

            if (!name) { showHint('hintName', '  '); valid = false; }
            else if (!validateName(name)) { showHint('hintName', '  ( )'); valid = false; }

            if (!phone) { showHint('hintPhone', '  '); valid = false; }
            else if (!validatePhone(phone)) { showHint('hintPhone', '   '); valid = false; }

            if (!valid) return;

            accessForm.style.display = 'none';
            accessSuccess.classList.add('show');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { closeModal(); closeAccessModal(); closeCreateDialogModal(); closeDeleteDialogModal(); closeMgmtModal(); closeAllContextMenus(); }
        });

        document.addEventListener('click', function() { closeAllContextMenus(); });

        document.getElementById('newDialogName').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); createDialog(); }
        });

        // ===================== STATS PAGE =====================
        (function() {
            const ST_MONTHS_RU = ['','','','','','','','','','','',''];
            const ST_DAYS_RU = ['','','','','','',''];

            var _stNow = new Date();
            var _stLeftMonth = _stNow.getMonth() === 0 ? 11 : _stNow.getMonth() - 1;
            var _stLeftYear = _stNow.getMonth() === 0 ? _stNow.getFullYear() - 1 : _stNow.getFullYear();
            const stCalState = {
                leftYear: _stLeftYear, leftMonth: _stLeftMonth,
                rightYear: _stNow.getFullYear(), rightMonth: _stNow.getMonth(),
                start: _stNow,
                end: _stNow
            };

            // Set initial date label
            (function() {
                var shortMonths = ['','','','','','','','','','','',''];
                var el = document.getElementById('st-date-label');
                if (el) el.textContent = _stNow.getDate() + ' ' + shortMonths[_stNow.getMonth()] + ' ' + _stNow.getFullYear();
            })();

            window.stToggleCalendar = function() {
                const p = document.getElementById('st-calendar-popup');
                p.classList.toggle('open');
                if (p.classList.contains('open')) {
                    var btn = document.querySelector('.st-datepicker-btn');
                    var r = btn.getBoundingClientRect();
                    var top = r.bottom + 8;
                    var left = r.left;
                    if (left + 560 > window.innerWidth) left = window.innerWidth - 570;
                    if (left < 10) left = 10;
                    if (top + p.offsetHeight > window.innerHeight) top = r.top - p.offsetHeight - 8;
                    p.style.top = top + 'px';
                    p.style.left = left + 'px';
                }
                stRenderCals();
            };

            document.addEventListener('mousedown', function(e) {
                const popup = document.getElementById('st-calendar-popup');
                const btn = document.querySelector('.st-datepicker-btn');
                if (popup && btn && !popup.contains(e.target) && !btn.contains(e.target)) {
                    popup.classList.remove('open');
                }
            });

            function stRenderCals() {
                stRenderCal('st-cal-left', stCalState.leftYear, stCalState.leftMonth, 'left');
                stRenderCal('st-cal-right', stCalState.rightYear, stCalState.rightMonth, 'right');
            }

            function stRenderCal(id, year, month, side) {
                const el = document.getElementById(id);
                if (!el) return;
                const firstDay = new Date(year, month, 1).getDay();
                const offset = (firstDay === 0 ? 6 : firstDay - 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                let html = '<div class="st-cal-header">' +
                    '<button class="st-cal-nav" onclick="stCalNav(\'' + side + '\',-1)"></button>' +
                    '<span>' + ST_MONTHS_RU[month] + ' ' + year + '</span>' +
                    '<button class="st-cal-nav" onclick="stCalNav(\'' + side + '\',1)"></button>' +
                    '</div><div class="st-cal-grid">';
                ST_DAYS_RU.forEach(function(d) { html += '<div class="st-cal-day-name">' + d + '</div>'; });

                for (var i = 0; i < offset; i++) {
                    var prevMonthDays = new Date(year, month, 0).getDate();
                    var dayNum = prevMonthDays - offset + i + 1;
                    html += '<div class="st-cal-day other-month">' + dayNum + '</div>';
                }
                for (var d = 1; d <= daysInMonth; d++) {
                    var dt = new Date(year, month, d);
                    var cls = 'st-cal-day';
                    if (today.getFullYear()===year && today.getMonth()===month && today.getDate()===d) cls += ' today';
                    if (stCalState.start && stSameDay(dt, stCalState.start)) cls += ' selected';
                    if (stCalState.end && stSameDay(dt, stCalState.end)) cls += ' selected';
                    if (stCalState.start && stCalState.end) {
                        var s = stCalState.start < stCalState.end ? stCalState.start : stCalState.end;
                        var e = stCalState.start < stCalState.end ? stCalState.end : stCalState.start;
                        if (dt > s && dt < e) cls += ' in-range';
                    }
                    html += '<div class="' + cls + '" onclick="stPickDay(' + year + ',' + month + ',' + d + ')">' + d + '</div>';
                }
                html += '</div>';
                el.innerHTML = html;
            }

            function stSameDay(a, b) {
                return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
            }

            window.stCalNav = function(side, dir) {
                if (side === 'left') {
                    stCalState.leftMonth += dir;
                    if (stCalState.leftMonth > 11) { stCalState.leftMonth = 0; stCalState.leftYear++; }
                    if (stCalState.leftMonth < 0) { stCalState.leftMonth = 11; stCalState.leftYear--; }
                } else {
                    stCalState.rightMonth += dir;
                    if (stCalState.rightMonth > 11) { stCalState.rightMonth = 0; stCalState.rightYear++; }
                    if (stCalState.rightMonth < 0) { stCalState.rightMonth = 11; stCalState.rightYear--; }
                }
                stRenderCals();
            };

            window.stPickDay = function(y, m, d) {
                var dt = new Date(y, m, d);
                if (!stCalState.start || (stCalState.start && stCalState.end)) {
                    stCalState.start = dt; stCalState.end = null;
                } else {
                    if (dt < stCalState.start) { stCalState.end = stCalState.start; stCalState.start = dt; }
                    else { stCalState.end = dt; }
                }
                stRenderCals();
            };

            window.stSetPreset = function(days, type) {
                var now = new Date();
                if (type === 'month') {
                    stCalState.start = new Date(now.getFullYear(), now.getMonth(), 1);
                    stCalState.end = now;
                } else if (days === 1) {
                    stCalState.start = now; stCalState.end = now;
                } else {
                    stCalState.end = now;
                    stCalState.start = new Date(now - (days-1)*86400000);
                }
                // Navigate calendar to show current month
                var prevM = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                var prevY = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                stCalState.leftYear = prevY; stCalState.leftMonth = prevM;
                stCalState.rightYear = now.getFullYear(); stCalState.rightMonth = now.getMonth();
                stRenderCals();
            };

            window.stApplyDate = function() {
                var shortMonths = ['','','','','','','','','','','',''];
                if (stCalState.start) {
                    var fmt = function(d) { return d.getDate() + ' ' + shortMonths[d.getMonth()]; };
                    var label = fmt(stCalState.start);
                    if (stCalState.end && !stSameDay(stCalState.start, stCalState.end)) {
                        label += '  ' + fmt(stCalState.end) + ' ' + stCalState.end.getFullYear();
                    } else {
                        label += ' ' + stCalState.start.getFullYear();
                    }
                    document.getElementById('st-date-label').textContent = label;
                }
                document.getElementById('st-calendar-popup').classList.remove('open');
            };

            window.stSwitchTab = function(btn, tab) {
                document.querySelectorAll('.st-tab').forEach(function(t) { t.classList.remove('active'); });
                btn.classList.add('active');
            };

            // Calls data  full set (all dialogs)
            var stCallsAll = [
                {id:1,name:' ',phone:'+7 912 345-67-89',status:'success',dur:247,lead:'yes',mp:'wb',date:'01.03.2026',time:'11:42',dlg:'dlg_1'},
                {id:2,name:' ',phone:'+7 905 234-56-78',status:'noanswer',dur:0,lead:'no',mp:'ozon',date:'01.03.2026',time:'10:15',dlg:'dlg_1'},
                {id:3,name:' ',phone:'+7 916 789-01-23',status:'success',dur:183,lead:'yes',mp:'ym',date:'01.03.2026',time:'09:55',dlg:'dlg_1'},
                {id:4,name:' ',phone:'+7 926 456-78-90',status:'fail',dur:34,lead:'no',mp:'wb',date:'28.02.2026',time:'17:30',dlg:'dlg_1'},
                {id:5,name:' ',phone:'+7 903 321-54-76',status:'success',dur:512,lead:'yes',mp:'ozon',date:'28.02.2026',time:'16:08',dlg:'dlg_1'},
                {id:6,name:' ',phone:'+7 919 654-32-10',status:'busy',dur:8,lead:'no',mp:'wb',date:'28.02.2026',time:'14:22',dlg:'dlg_1'},
                {id:7,name:' ',phone:'+7 931 112-23-34',status:'success',dur:298,lead:'no',mp:'ym',date:'27.02.2026',time:'13:45',dlg:'dlg_1'},
                {id:8,name:' ',phone:'+7 906 987-65-43',status:'noanswer',dur:0,lead:'no',mp:'ozon',date:'27.02.2026',time:'12:10',dlg:'dlg_1'},
                {id:9,name:' ',phone:'+7 922 543-21-09',status:'success',dur:421,lead:'yes',mp:'wb',date:'27.02.2026',time:'11:30',dlg:'dlg_1'},
                {id:10,name:' ',phone:'+7 904 876-54-32',status:'fail',dur:17,lead:'no',mp:'wb',date:'26.02.2026',time:'18:05',dlg:'dlg_1'},
                {id:11,name:' ',phone:'+7 915 321-09-87',status:'success',dur:190,lead:'yes',mp:'ozon',date:'26.02.2026',time:'15:40',dlg:'dlg_2'},
                {id:12,name:' ',phone:'+7 929 765-43-21',status:'noanswer',dur:0,lead:'no',mp:'ym',date:'26.02.2026',time:'14:55',dlg:'dlg_2'},
                {id:13,name:' ',phone:'+7 937 234-56-78',status:'success',dur:376,lead:'yes',mp:'wb',date:'25.02.2026',time:'17:20',dlg:'dlg_2'},
                {id:14,name:' ',phone:'+7 911 890-12-34',status:'busy',dur:5,lead:'no',mp:'ozon',date:'25.02.2026',time:'16:00',dlg:'dlg_2'},
                {id:15,name:' ',phone:'+7 923 456-78-01',status:'success',dur:305,lead:'no',mp:'ym',date:'25.02.2026',time:'13:15',dlg:'dlg_2'},
                {id:16,name:' ',phone:'+7 918 234-56-78',status:'fail',dur:42,lead:'no',mp:'wb',date:'24.02.2026',time:'10:30',dlg:'dlg_2'},
                {id:17,name:' ',phone:'+7 908 765-43-21',status:'success',dur:228,lead:'yes',mp:'ozon',date:'24.02.2026',time:'09:45',dlg:'dlg_2'},
                {id:18,name:' ',phone:'+7 935 123-45-67',status:'noanswer',dur:0,lead:'no',mp:'wb',date:'23.02.2026',time:'16:50',dlg:'dlg_2'},
                {id:19,name:' ',phone:'+7 901 678-90-12',status:'success',dur:461,lead:'yes',mp:'ym',date:'23.02.2026',time:'15:05',dlg:'dlg_2'},
                {id:20,name:' ',phone:'+7 925 345-67-89',status:'success',dur:134,lead:'no',mp:'ozon',date:'23.02.2026',time:'11:20',dlg:'dlg_2'}
            ];

            var stCurrentDlg = null; // null = all dialogs
            var stCalls = stCallsAll;

            var ST_STATUS_MAP = {
                success: {label:'', cls:'st-status-success', dot:'st-dot-green'},
                fail: {label:'', cls:'st-status-fail', dot:'st-dot-red'},
                noanswer: {label:' ', cls:'st-status-noanswer', dot:'st-dot-yellow'},
                busy: {label:'', cls:'st-status-busy', dot:'st-dot-purple'}
            };
            var ST_MP_MAP = {wb:'Wildberries', ozon:'Ozon', ym:' '};

            function stFmtDur(sec) {
                if (!sec) return '';
                var m = Math.floor(sec/60), s = sec%60;
                return m + ':' + String(s).padStart(2,'0');
            }

            function stDurGroup(sec) {
                if (sec < 60) return 'short';
                if (sec < 180) return 'mid';
                return 'long';
            }

            var stOpenPlayer = null;

            function stRenderCalls(data) {
                var list = document.getElementById('st-calls-list');
                if (!list) return;
                list.innerHTML = data.map(function(c) {
                    var st = ST_STATUS_MAP[c.status];
                    return '<div class="st-call-row" onclick="stTogglePlayer(' + c.id + ')">' +
                        '<div class="st-call-num">' + c.id + '</div>' +
                        '<div><div class="st-call-name">' + c.name + '</div><div class="st-call-phone">' + c.phone + '</div></div>' +
                        '<div><span class="st-status-badge ' + st.cls + '"><span class="st-dot ' + st.dot + '"></span>' + st.label + '</span></div>' +
                        '<div class="st-call-dur">' + stFmtDur(c.dur) + '</div>' +
                        '<div><span class="st-lead-badge ' + (c.lead==='yes'?'st-lead-yes':'st-lead-no') + '">' + (c.lead==='yes'?'':'') + '</span></div>' +
                        '<div style="font-size:13px;color:rgba(255,255,255,0.7)">' + ST_MP_MAP[c.mp] + '</div>' +
                        '<div class="st-call-date">' + c.date + '<br><span style="color:rgba(255,255,255,0.7)">' + c.time + '</span></div>' +
                        '<div><div class="st-play-btn" onclick="event.stopPropagation();stTogglePlayer(' + c.id + ')">' +
                            '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>' +
                        '</div></div>' +
                    '</div>' +
                    '<div class="st-player-expand" id="st-player-' + c.id + '">' +
                        '<div class="st-audio-bar">' +
                            '<button class="st-audio-play"><svg width="11" height="11" viewBox="0 0 24 24" fill="white"><polygon points="5,3 19,12 5,21"/></svg></button>' +
                            '<div class="st-audio-track"><div class="st-audio-fill" style="width:' + (c.dur ? Math.floor(Math.random()*70+5) : 0) + '%"></div></div>' +
                            '<span class="st-audio-time">' + stFmtDur(Math.floor(c.dur*0.35)) + ' / ' + stFmtDur(c.dur) + '</span>' +
                            '<span style="font-size:12px;color:rgba(255,255,255,0.7);margin-left:8px">' + c.name + '  ' + c.date + ' ' + c.time + '</span>' +
                            (c.dur===0 ? '<span style="font-size:12px;color:rgba(255,255,255,0.7);margin-left:12px"> </span>' : '') +
                        '</div>' +
                    '</div>';
                }).join('');
                var counter = document.getElementById('st-count-shown');
                if (counter) counter.textContent = data.length;
            }

            window.stTogglePlayer = function(id) {
                var el = document.getElementById('st-player-' + id);
                if (!el) return;
                if (stOpenPlayer && stOpenPlayer !== id) {
                    var prev = document.getElementById('st-player-' + stOpenPlayer);
                    if (prev) prev.classList.remove('open');
                }
                el.classList.toggle('open');
                stOpenPlayer = el.classList.contains('open') ? id : null;
            };

            window.stApplyFilters = function() {
                var q = document.querySelector('.st-search-input').value.toLowerCase();
                var status = document.getElementById('st-f-status').value;
                var lead = document.getElementById('st-f-lead').value;
                var dur = document.getElementById('st-f-dur').value;
                var mp = document.getElementById('st-f-mp').value;

                var filtered = stCalls.filter(function(c) {
                    if (q && c.name.toLowerCase().indexOf(q) === -1 && c.phone.indexOf(q) === -1) return false;
                    if (status && c.status !== status) return false;
                    if (lead && c.lead !== lead) return false;
                    if (dur && stDurGroup(c.dur) !== dur) return false;
                    if (mp && c.mp !== mp) return false;
                    return true;
                });
                stRenderCalls(filtered);
            };

            // ---- Dialog picker ----
            function stGetCurrentCalls() {
                if (!stCurrentDlg) return stCallsAll;
                return stCallsAll.filter(function(c) { return c.dlg === stCurrentDlg; });
            }

            function stRenderStatsCards(data) {
                var grid = document.getElementById('st-stats-grid');
                if (!grid) return;
                var totalDur = 0, contacts = 0, answers = 0, leads = 0, scheduled = 0, queued = 0;
                data.forEach(function(c) {
                    contacts++;
                    totalDur += c.dur;
                    if (c.status === 'success' || c.status === 'fail') answers++;
                    if (c.lead === 'yes') leads++;
                    if (c.status === 'noanswer') scheduled++;
                    if (c.status === 'busy') queued++;
                });
                var durMin = Math.round(totalDur / 60);
                var cost = (durMin * 3.6).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                var conv = answers > 0 ? ((leads / answers) * 100).toFixed(1) : '0.0';
                var convUp = parseFloat(conv) >= 30;

                grid.innerHTML =
                    '<div class="st-stat-card">' +
                        '<div class="st-stat-label"></div>' +
                        '<div class="st-stat-value">' + durMin + ' </div>' +
                        '<div class="st-stat-sub">: <strong>' + cost + ' </strong></div>' +
                        '<div class="st-stat-sub" style="margin-top:4px">  </div>' +
                    '</div>' +
                    '<div class="st-stat-card">' +
                        '<div class="st-stat-label"> </div>' +
                        '<div class="st-stat-value">+' + contacts + ' <span class="st-stat-badge st-badge-up"> 12%</span></div>' +
                        '<div class="st-stat-sub">  : <strong>' + scheduled + '</strong></div>' +
                        '<div class="st-stat-sub" style="margin-top:4px"><span style="color:#2ecc71">  </span>   </div>' +
                    '</div>' +
                    '<div class="st-stat-card">' +
                        '<div class="st-stat-label"></div>' +
                        '<div class="st-stat-value">+' + answers + ' <span class="st-stat-badge st-badge-up"> 8%</span></div>' +
                        '<div class="st-stat-sub" style="margin-top:4px"><span style="color:#2ecc71">  </span>   </div>' +
                    '</div>' +
                    '<div class="st-stat-card">' +
                        '<div class="st-stat-label"> </div>' +
                        '<div class="st-stat-value">+' + leads + ' <span class="st-stat-badge st-badge-up"> 19%</span></div>' +
                        '<div class="st-stat-sub" style="margin-top:4px"><span style="color:#2ecc71">  </span>   </div>' +
                    '</div>' +
                    '<div class="st-stat-card">' +
                        '<div class="st-stat-label">    </div>' +
                        '<div class="st-stat-value">' + conv + '% <span class="st-stat-badge ' + (convUp ? 'st-badge-up' : 'st-badge-down') + '">' + (convUp ? '' : '') + '</span></div>' +
                        '<div class="st-stat-sub" style="margin-top:4px"><span style="color:' + (convUp ? '#2ecc71' : '#e74c3c') + '">' + (convUp ? ' ' : ' ') + ' </span>   </div>' +
                    '</div>' +
                    '<div class="st-stat-card">' +
                        '<div class="st-stat-label">  </div>' +
                        '<div class="st-stat-value" style="font-size:20px;margin-top:8px">' +
                          '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">' +
                            '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:0.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' +
                            '<span style="font-size:16px;font-weight:600">: <span style="color:#4f8eff">' + scheduled + '</span></span>' +
                          '</div>' +
                          '<div style="display:flex;align-items:center;gap:8px">' +
                            '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:0.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' +
                            '<span style="font-size:16px;font-weight:600"> : <span style="color:#f1c40f">' + queued + '</span></span>' +
                          '</div>' +
                        '</div>' +
                        '<div class="st-stat-sub" style="margin-top:8px">*   -</div>' +
                    '</div>';
            }

            function stRenderDlgDropdown() {
                var dd = document.getElementById('st-dlg-dropdown');
                if (!dd) return;
                var html = '<div class="st-dlg-dropdown-header">' + t('stDlgPick') + '</div>';
                html += '<div class="st-dlg-item st-dlg-item-all' + (stCurrentDlg === null ? ' active' : '') + '" onclick="stSelectDlg(null)">' +
                    '<div class="st-dlg-dot"></div><span>' + t('stDlgAll') + '</span></div>';
                dialogs.forEach(function(dlg) {
                    var pct = dlgCompleteness(dlg);
                    var isOn = dlg.active && pct >= 100;
                    var statusLabel = isOn ? t('dlgActive') : t('dlgInactive');
                    var statusColor = isOn ? '#2ecc71' : 'var(--text-muted)';
                    html += '<div class="st-dlg-item' + (stCurrentDlg === dlg.id ? ' active' : '') + '" onclick="stSelectDlg(\'' + dlg.id + '\')">' +
                        dlgRingHTML(pct, 22) +
                        '<div style="flex:1"><span>' + escapeHtml(dlg.name) + '</span>' +
                        '<div class="dlg-status-hint" style="color:' + statusColor + '">' + statusLabel + '</div></div></div>';
                });
                dd.innerHTML = html;
            }

            window.stToggleDlgPicker = function() {
                var dd = document.getElementById('st-dlg-dropdown');
                var isOpen = dd.classList.toggle('open');
                document.getElementById('st-dlg-btn').classList.toggle('active', isOpen);
                if (isOpen) stRenderDlgDropdown();
            };

            window.stSelectDlg = function(dlgId) {
                stCurrentDlg = dlgId;
                stCalls = stGetCurrentCalls();
                // Update label
                var label = document.getElementById('st-dlg-label');
                if (dlgId === null) {
                    label.textContent = t('stDlgAll');
                } else {
                    var dlg = dialogs.find(function(d) { return d.id === dlgId; });
                    label.textContent = dlg ? dlg.name : t('stDlgAll');
                }
                // Update button style
                document.getElementById('st-dlg-btn').classList.toggle('active', dlgId !== null);
                // Close dropdown
                document.getElementById('st-dlg-dropdown').classList.remove('open');
                // Re-render stats
                stRenderStatsCards(stCalls);
                stRenderCalls(stCalls);
                var totalEl = document.getElementById('st-count-total');
                if (totalEl) totalEl.textContent = stCalls.length;
            };

            // Close dropdown on outside click
            document.addEventListener('mousedown', function(e) {
                var dd = document.getElementById('st-dlg-dropdown');
                var btn = document.getElementById('st-dlg-btn');
                if (dd && btn && !dd.contains(e.target) && !btn.contains(e.target)) {
                    dd.classList.remove('open');
                    btn.classList.remove('active');
                }
            });

            // Init stats page
            stRenderCals();
            stRenderStatsCards(stCallsAll);
            stRenderCalls(stCalls);
        })();
    </script>

<!-- ===== SUPPORT CHAT ===== -->
<div class="sc-window" id="scWindow">
    <div class="sc-header">
        <div class="sc-header-info">
            <div class="sc-header-title" data-i18n="scTitle"></div>
            <div class="sc-header-status" data-i18n="scStatus"> </div>
        </div>
        <button class="sc-close" onclick="scToggle()"></button>
    </div>
    <div class="sc-messages" id="scMessages">
        <div class="sc-msg support">
            <div class="sc-msg-text" data-i18n="scWelcome">!   ?</div>
            <div class="sc-msg-time"></div>
        </div>
    </div>
    <div class="sc-file-preview" id="scFilePreview" style="display:none"></div>
    <div class="sc-input-area">
        <button class="sc-attach-btn" onclick="document.getElementById('scFileInput').click()"></button>
        <input type="file" id="scFileInput" multiple style="display:none" onchange="scAttachFiles(this.files)">
        <input type="text" class="sc-input" id="scInput" placeholder=" ..." data-i18n-ph="scPlaceholder" onkeydown="if(event.key==='Enter')scSend()">
        <button class="sc-send-btn" onclick="scSend()"></button>
    </div>
</div>
<button class="sc-fab" id="scFab" onclick="scToggle()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
</button>

<script>
    var scFiles = [];

    function scToggle() {
        var win = document.getElementById('scWindow');
        var fab = document.getElementById('scFab');
        var isOpen = win.classList.toggle('open');
        fab.classList.toggle('open', isOpen);
        if (isOpen) {
            var msgs = document.getElementById('scMessages');
            msgs.scrollTop = msgs.scrollHeight;
        }
    }

    function scSend() {
        var input = document.getElementById('scInput');
        var text = input.value.trim();
        if (!text && scFiles.length === 0) return;

        var msgs = document.getElementById('scMessages');
        var now = new Date();
        var time = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');

        var bubble = document.createElement('div');
        bubble.className = 'sc-msg user';
        var html = '';
        if (text) html += '<div class="sc-msg-text">' + text.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
        for (var i = 0; i < scFiles.length; i++) {
            html += '<div class="sc-msg-file">' + scFiles[i].name + '</div>';
        }
        html += '<div class="sc-msg-time">' + time + '</div>';
        bubble.innerHTML = html;
        msgs.appendChild(bubble);
        msgs.scrollTop = msgs.scrollHeight;

        input.value = '';
        scFiles = [];
        document.getElementById('scFilePreview').style.display = 'none';
        document.getElementById('scFilePreview').innerHTML = '';
        document.getElementById('scFileInput').value = '';

        scAutoReply();
    }

    function scAttachFiles(fileList) {
        var preview = document.getElementById('scFilePreview');
        for (var i = 0; i < fileList.length; i++) {
            var f = fileList[i];
            if (f.size > 10 * 1024 * 1024) {
                alert(t('scFileTooLarge'));
                continue;
            }
            scFiles.push(f);
        }
        scRenderPreview();
        document.getElementById('scFileInput').value = '';
    }

    function scRenderPreview() {
        var preview = document.getElementById('scFilePreview');
        if (scFiles.length === 0) { preview.style.display = 'none'; preview.innerHTML = ''; return; }
        preview.style.display = 'flex';
        var html = '';
        for (var i = 0; i < scFiles.length; i++) {
            html += '<span class="sc-file-tag">' + scFiles[i].name + '<button onclick="scRemoveFile(' + i + ')"></button></span>';
        }
        preview.innerHTML = html;
    }

    function scRemoveFile(idx) {
        scFiles.splice(idx, 1);
        scRenderPreview();
    }

    function scAutoReply() {
        setTimeout(function() {
            var msgs = document.getElementById('scMessages');
            var now = new Date();
            var time = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
            var bubble = document.createElement('div');
            bubble.className = 'sc-msg support';
            bubble.innerHTML = '<div class="sc-msg-text">' + t('scAutoReply') + '</div><div class="sc-msg-time">' + time + '</div>';
            msgs.appendChild(bubble);
            msgs.scrollTop = msgs.scrollHeight;
        }, 1000);
    }
</script>
</body>
</html>
